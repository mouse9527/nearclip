name: Release

on:
  push:
    tags:
      - 'v*'

# Required permissions for creating releases
permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================
  # Create Release
  # ============================================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          generate_release_notes: true
          name: NearClip v${{ steps.get_version.outputs.version }}

  # ============================================
  # Build macOS
  # ============================================
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    needs: create-release

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin, x86_64-apple-darwin

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      - name: Build Rust FFI (ARM64)
        run: cargo build -p nearclip-ffi --release --target aarch64-apple-darwin

      - name: Build Rust FFI (x86_64)
        run: cargo build -p nearclip-ffi --release --target x86_64-apple-darwin

      - name: Create Universal Binary
        run: |
          mkdir -p target/universal-apple-darwin/release
          lipo -create \
            target/aarch64-apple-darwin/release/libnearclip_ffi.dylib \
            target/x86_64-apple-darwin/release/libnearclip_ffi.dylib \
            -output target/universal-apple-darwin/release/libnearclip_ffi.dylib

      - name: Setup library path for Swift
        run: |
          mkdir -p target/swift
          cp target/universal-apple-darwin/release/libnearclip_ffi.dylib target/swift/
          cp target/universal-apple-darwin/release/libnearclip_ffi.dylib target/swift/libnearclip_ffi.a || true

      - name: Build Swift Package (Release)
        working-directory: macos/NearClip
        run: swift build -c release
        continue-on-error: true

      - name: Package macOS App
        run: |
          mkdir -p dist
          cp -r macos/NearClip/.build/release/NearClip dist/ || true
          cp target/universal-apple-darwin/release/libnearclip_ffi.dylib dist/
          cd dist && zip -r ../NearClip-macos-${{ needs.create-release.outputs.version }}.zip .

      - name: Upload macOS Release
        uses: softprops/action-gh-release@v1
        with:
          files: NearClip-macos-${{ needs.create-release.outputs.version }}.zip

  # ============================================
  # Build Android
  # ============================================
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: create-release

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android, armv7-linux-androideabi, x86_64-linux-android

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r25c

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      - name: Configure Cargo for Android
        run: |
          mkdir -p ~/.cargo
          cat >> ~/.cargo/config.toml << EOF
          [target.aarch64-linux-android]
          linker = "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang"

          [target.armv7-linux-androideabi]
          linker = "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang"

          [target.x86_64-linux-android]
          linker = "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android21-clang"
          EOF

      - name: Build Rust for Android
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          # Set CC/AR for ring crate cross-compilation
          CC_aarch64-linux-android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang
          AR_aarch64-linux-android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
          CC_armv7-linux-androideabi: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang
          AR_armv7-linux-androideabi: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
          CC_x86_64-linux-android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android21-clang
          AR_x86_64-linux-android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
        run: |
          cargo build -p nearclip-ffi --release --target aarch64-linux-android
          cargo build -p nearclip-ffi --release --target armv7-linux-androideabi
          cargo build -p nearclip-ffi --release --target x86_64-linux-android
        continue-on-error: true

      - name: Copy native libraries
        run: |
          mkdir -p android/app/src/main/jniLibs/{arm64-v8a,armeabi-v7a,x86_64}
          cp target/aarch64-linux-android/release/libnearclip_ffi.so android/app/src/main/jniLibs/arm64-v8a/
          cp target/armv7-linux-androideabi/release/libnearclip_ffi.so android/app/src/main/jniLibs/armeabi-v7a/
          cp target/x86_64-linux-android/release/libnearclip_ffi.so android/app/src/main/jniLibs/x86_64/

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build Release APK
        working-directory: android
        run: ./gradlew assembleRelease
        continue-on-error: true

      - name: Upload Android APK
        uses: softprops/action-gh-release@v1
        with:
          files: android/app/build/outputs/apk/release/app-release-unsigned.apk
        continue-on-error: true
