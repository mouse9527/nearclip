name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================
  # Rust Core - Build & Test
  # ============================================
  rust:
    name: Rust (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust"

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Build
        run: cargo build --all-targets

      - name: Test
        run: cargo test --all-targets

  # ============================================
  # macOS Client - Build
  # ============================================
  macos:
    name: macOS Client
    runs-on: macos-latest
    needs: rust

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust-macos"

      - name: Build Rust FFI
        run: cargo build -p nearclip-ffi --release

      - name: Setup library path for Swift
        run: |
          mkdir -p target/swift
          cp target/release/libnearclip_ffi.dylib target/swift/

          # Fix dylib install name before Swift builds
          install_name_tool -id "@rpath/libnearclip_ffi.dylib" target/swift/libnearclip_ffi.dylib

      - name: Build Swift Package
        working-directory: macos/NearClip
        run: swift build
        continue-on-error: true

      - name: Run Swift Tests
        working-directory: macos/NearClip
        run: swift test
        continue-on-error: true  # Tests may require UI/system access

  # ============================================
  # Android Client - Build
  # ============================================
  android:
    name: Android Client
    runs-on: ubuntu-latest
    needs: rust

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android, armv7-linux-androideabi, x86_64-linux-android

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r25c

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust-android"

      - name: Install cargo-ndk
        run: cargo install cargo-ndk

      - name: Build Rust for Android with cargo-ndk
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          cargo ndk -t arm64-v8a -o android/app/src/main/jniLibs build -p nearclip-ffi --release

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build Android APK
        working-directory: android
        run: ./gradlew assembleDebug

  # ============================================
  # Security Audit
  # ============================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run audit
        run: cargo audit
        continue-on-error: true  # Advisory-only for now

  # ============================================
  # Documentation
  # ============================================
  docs:
    name: Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build docs
        run: cargo doc --no-deps --all-features

      - name: Upload docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: rust-docs
          path: target/doc/
          retention-days: 7
