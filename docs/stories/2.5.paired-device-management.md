# Story 2.5: 已配对设备管理

## Status
Draft

## Story
**作为** 用户，
**我希望** 能够查看和管理已配对的设备列表，
**以便** 控制哪些设备可以访问我的粘贴板内容。

## Acceptance Criteria
1. 实现已配对设备的列表显示界面
2. 提供设备重命名功能，便于用户识别
3. 支持设备断开连接和取消配对操作
4. 显示设备的最后连接时间和状态
5. 实现设备权限管理和连接限制

## Tasks / Subtasks
- [ ] 设计设备管理数据模型 (AC: 1, 4)
  - [ ] 创建已配对设备数据结构
  - [ ] 定义设备权限和访问控制
  - [ ] 实现设备历史记录存储
  - [ ] 创建设备分组和标签系统
  - [ ] 设计设备同步状态跟踪
- [ ] 实现设备列表界面 (AC: 1)
  - [ ] 创建 Android 设备管理列表
  - [ ] 实现 Mac 设备管理面板
  - [ ] 添加设备搜索和过滤功能
  - [ ] 实现设备状态可视化
  - [ ] 创建设备详情页面
- [ ] 实现设备重命名功能 (AC: 2)
  - [ ] 创建设备别名编辑界面
  - [ ] 实现跨平台别名同步
  - [ ] 添加重命名验证和冲突处理
  - [ ] 创建设备图标自定义功能
  - [ ] 实现设备备注系统
- [ ] 实现设备连接管理 (AC: 3)
  - [ ] 创建设备连接/断开控制
  - [ ] 实现批量连接操作
  - [ ] 添加连接优先级设置
  - [ ] 创建连接限制配置
  - [ ] 实现设备自动连接规则
- [ ] 实现权限管理系统 (AC: 5)
  - [ ] 创建设备权限设置界面
  - [ ] 实现读写权限控制
  - [ ] 添加临时权限机制
  - [ ] 创建设备信任级别管理
  - [ ] 实现权限审计日志
- [ ] 实现设备操作功能 (AC: 3, 4)
  - [ ] 创建取消配对确认流程
  - [ ] 实现设备信息导出功能
  - [ ] 添加设备备份和恢复
  - [ ] 创建设备统计信息
  - [ ] 实现设备黑名单管理

## Dev Notes

### 设备管理数据模型设计
[Source: architecture/data-models.md]

#### 设备管理协议定义
```protobuf
// src/shared/protocol/device_management.proto
syntax = "proto3";

package nearclip.device_management;

// 设备权限级别
enum DevicePermissionLevel {
  PERMISSION_UNKNOWN = 0;
  PERMISSION_READ_ONLY = 1;          // 只读权限
  PERMISSION_READ_WRITE = 2;         // 读写权限
  PERMISSION_ADMIN = 3;              // 管理员权限
  PERMISSION_TEMPORARY = 4;          // 临时权限
}

// 设备信任级别
enum DeviceTrustLevel {
  TRUST_UNKNOWN = 0;
  TRUST_UNTRUSTED = 1;               // 不信任
  TRUST_TRUSTED = 2;                 // 信任
  TRUST_FULLY_TRUSTED = 3;           // 完全信任
}

// 已配对设备信息
message PairedDevice {
  string device_id = 1;
  string device_name = 2;
  string user_alias = 3;              // 用户自定义别名
  DeviceType device_type = 4;
  string device_model = 5;
  string manufacturer = 6;
  DevicePermissionLevel permission_level = 7;
  DeviceTrustLevel trust_level = 8;
  bool is_active = 9;                 // 是否激活
  bool is_connected = 10;             // 是否已连接
  int64 paired_at = 11;              // 配对时间
  int64 last_connected_at = 12;       // 最后连接时间
  int64 last_seen_at = 13;            // 最后在线时间
  int64 total_connection_time = 14;   // 总连接时长（秒）
  int32 connection_count = 15;        // 连接次数
  bytes device_certificate = 16;      // 设备证书
  map<string, string> metadata = 17;  // 扩展元数据
  repeated string tags = 18;          // 用户标签
  string notes = 19;                 // 用户备注
}

// 设备管理操作
message DeviceManagementOperation {
  string operation_id = 1;
  OperationType operation_type = 2;
  string device_id = 3;
  google.protobuf.Any parameters = 4;
  int64 timestamp = 5;
  string requested_by = 6;
}

enum OperationType {
  OPERATION_UNKNOWN = 0;
  OPERATION_RENAME = 1;               // 重命名
  OPERATION_CHANGE_PERMISSION = 2;    // 修改权限
  OPERATION_DISCONNECT = 3;           // 断开连接
  OPERATION_UNPAIR = 4;               // 取消配对
  OPERATION_SET_TRUST_LEVEL = 5;      // 设置信任级别
  OPERATION_ADD_TAG = 6;              // 添加标签
  OPERATION_REMOVE_TAG = 7;           // 移除标签
  OPERATION_EXPORT_INFO = 8;          // 导出信息
}

// 设备分组
message DeviceGroup {
  string group_id = 1;
  string group_name = 2;
  string description = 3;
  repeated string device_ids = 4;
  GroupPermission default_permission = 5;
  int64 created_at = 6;
  int64 updated_at = 7;
}

message GroupPermission {
  DevicePermissionLevel permission_level = 1;
  bool can_sync_clipboard = 2;
  bool can_receive_notifications = 3;
  bool can_auto_connect = 4;
}

// 设备统计信息
message DeviceStatistics {
  string device_id = 1;
  int64 total_sync_operations = 2;     // 总同步操作数
  int64 successful_syncs = 3;         // 成功同步数
  int64 failed_syncs = 4;             // 失败同步数
  int64 total_bytes_synced = 5;       // 总同步字节数
  int64 average_sync_time_ms = 6;     // 平均同步时间
  int64 last_sync_time = 7;           // 最后同步时间
  repeated SyncRecord recent_syncs = 8; // 最近同步记录
}

message SyncRecord {
  int64 timestamp = 1;
  SyncOperationType operation = 2;
  int64 duration_ms = 3;
  int64 data_size = 4;
  bool success = 5;
  string error_message = 6;
}

enum SyncOperationType {
  SYNC_UNKNOWN = 0;
  SYNC_CLIPBOARD_READ = 1;
  SYNC_CLIPBOARD_WRITE = 2;
  SYNC_FILE_TRANSFER = 3;
}
```

#### Rust 设备管理器
```rust
// src/shared/rust/src/device/management.rs
use chrono::{DateTime, Utc, Duration};
use std::collections::HashMap;
use std::sync::Arc;
use tokio::sync::RwLock;
use serde::{Deserialize, Serialize};
use thiserror::Error;
use log::{info, warn, error};

#[derive(Error, Debug)]
pub enum DeviceManagementError {
    #[error("Device not found: {0}")]
    DeviceNotFound(String),
    #[error("Operation not permitted: {0}")]
    OperationNotPermitted(String),
    #[error("Invalid permission level: {0}")]
    InvalidPermissionLevel(String),
    #[error("Device already paired: {0}")]
    DeviceAlreadyPaired(String),
    #[error("Storage error: {0}")]
    StorageError(String),
}

#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]
pub enum DevicePermissionLevel {
    ReadOnly,
    ReadWrite,
    Admin,
    Temporary,
}

#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]
pub enum DeviceTrustLevel {
    Untrusted,
    Trusted,
    FullyTrusted,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct PairedDevice {
    pub device_id: String,
    pub device_name: String,
    pub user_alias: Option<String>,
    pub device_type: DeviceType,
    pub device_model: String,
    pub manufacturer: String,
    pub permission_level: DevicePermissionLevel,
    pub trust_level: DeviceTrustLevel,
    pub is_active: bool,
    pub is_connected: bool,
    pub paired_at: DateTime<Utc>,
    pub last_connected_at: Option<DateTime<Utc>>,
    pub last_seen_at: DateTime<Utc>,
    pub total_connection_time: i64,
    pub connection_count: i32,
    pub device_certificate: Vec<u8>,
    pub metadata: HashMap<String, String>,
    pub tags: Vec<String>,
    pub notes: Option<String>,
}

impl PairedDevice {
    pub fn display_name(&self) -> &str {
        self.user_alias.as_ref().unwrap_or(&self.device_name)
    }

    pub fn connection_duration(&self) -> Option<Duration> {
        self.last_connected_at.map(|connected| {
            Utc::now().signed_duration_since(connected)
        })
    }

    pub fn is_temporary(&self) -> bool {
        matches!(self.permission_level, DevicePermissionLevel::Temporary)
    }

    pub fn can_read_clipboard(&self) -> bool {
        matches!(
            self.permission_level,
            DevicePermissionLevel::ReadWrite | DevicePermissionLevel::Admin | DevicePermissionLevel::Temporary
        )
    }

    pub fn can_write_clipboard(&self) -> bool {
        matches!(
            self.permission_level,
            DevicePermissionLevel::ReadWrite | DevicePermissionLevel::Admin
        )
    }

    pub fn can_manage_device(&self) -> bool {
        matches!(self.permission_level, DevicePermissionLevel::Admin)
    }
}

#[derive(Debug, Clone)]
pub struct DeviceGroup {
    pub group_id: String,
    pub group_name: String,
    pub description: Option<String>,
    pub device_ids: Vec<String>,
    pub default_permission: GroupPermission,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

#[derive(Debug, Clone)]
pub struct GroupPermission {
    pub permission_level: DevicePermissionLevel,
    pub can_sync_clipboard: bool,
    pub can_receive_notifications: bool,
    pub can_auto_connect: bool,
}

#[derive(Debug, Clone)]
pub struct DeviceStatistics {
    pub device_id: String,
    pub total_sync_operations: i64,
    pub successful_syncs: i64,
    pub failed_syncs: i64,
    pub total_bytes_synced: i64,
    pub average_sync_time_ms: i64,
    pub last_sync_time: Option<DateTime<Utc>>,
    pub recent_syncs: Vec<SyncRecord>,
}

#[derive(Debug, Clone)]
pub struct SyncRecord {
    pub timestamp: DateTime<Utc>,
    pub operation: SyncOperationType,
    pub duration_ms: i64,
    pub data_size: i64,
    pub success: bool,
    pub error_message: Option<String>,
}

pub struct DeviceManager {
    paired_devices: Arc<RwLock<HashMap<String, PairedDevice>>>,
    device_groups: Arc<RwLock<HashMap<String, DeviceGroup>>>,
    device_statistics: Arc<RwLock<HashMap<String, DeviceStatistics>>>,
    storage: Arc<dyn DeviceStorage>,
}

impl DeviceManager {
    pub new(storage: Arc<dyn DeviceStorage>) -> Self {
        Self {
            paired_devices: Arc::new(RwLock::new(HashMap::new())),
            device_groups: Arc::new(RwLock::new(HashMap::new())),
            device_statistics: Arc::new(RwLock::new(HashMap::new())),
            storage,
        }
    }

    /// 加载已配对设备
    pub async fn load_paired_devices(&self) -> Result<(), DeviceManagementError> {
        let devices = self.storage.load_paired_devices().await
            .map_err(|e| DeviceManagementError::StorageError(e.to_string()))?;

        let mut device_map = HashMap::new();
        for device in devices {
            device_map.insert(device.device_id.clone(), device);
        }

        *self.paired_devices.write().await = device_map;
        Ok(())
    }

    /// 添加已配对设备
    pub async fn add_paired_device(&self, device: PairedDevice) -> Result<(), DeviceManagementError> {
        let mut devices = self.paired_devices.write().await;

        if devices.contains_key(&device.device_id) {
            return Err(DeviceManagementError::DeviceAlreadyPaired(device.device_id));
        }

        devices.insert(device.device_id.clone(), device.clone());

        // 保存到存储
        if let Err(e) = self.storage.save_paired_device(&device).await {
            // 回滚内存中的更改
            devices.remove(&device.device_id);
            return Err(DeviceManagementError::StorageError(e.to_string()));
        }

        // 初始化设备统计
        let statistics = DeviceStatistics {
            device_id: device.device_id.clone(),
            total_sync_operations: 0,
            successful_syncs: 0,
            failed_syncs: 0,
            total_bytes_synced: 0,
            average_sync_time_ms: 0,
            last_sync_time: None,
            recent_syncs: Vec::new(),
        };

        let mut stats = self.device_statistics.write().await;
        stats.insert(device.device_id, statistics);

        info!("Added paired device: {}", device.display_name());
        Ok(())
    }

    /// 获取所有已配对设备
    pub async fn get_paired_devices(&self) -> Vec<PairedDevice> {
        let devices = self.paired_devices.read().await;
        devices.values().cloned().collect()
    }

    /// 获取已配对设备
    pub async fn get_paired_device(&self, device_id: &str) -> Option<PairedDevice> {
        let devices = self.paired_devices.read().await;
        devices.get(device_id).cloned()
    }

    /// 更新设备别名
    pub async fn update_device_alias(
        &self,
        device_id: &str,
        alias: String,
    ) -> Result<(), DeviceManagementError> {
        let mut devices = self.paired_devices.write().await;
        let device = devices.get_mut(device_id)
            .ok_or_else(|| DeviceManagementError::DeviceNotFound(device_id.to_string()))?;

        let old_alias = device.user_alias.clone();
        device.user_alias = Some(alias.clone());

        // 保存到存储
        if let Err(e) = self.storage.update_device_alias(device_id, &alias).await {
            // 回滚更改
            device.user_alias = old_alias;
            return Err(DeviceManagementError::StorageError(e.to_string()));
        }

        info!("Updated device alias: {} -> {}", device_id, alias);
        Ok(())
    }

    /// 更新设备权限
    pub async fn update_device_permission(
        &self,
        device_id: &str,
        permission_level: DevicePermissionLevel,
    ) -> Result<(), DeviceManagementError> {
        let mut devices = self.paired_devices.write().await;
        let device = devices.get_mut(device_id)
            .ok_or_else(|| DeviceManagementError::DeviceNotFound(device_id.to_string()))?;

        let old_permission = device.permission_level.clone();
        device.permission_level = permission_level.clone();

        // 保存到存储
        if let Err(e) = self.storage.update_device_permission(device_id, &permission_level).await {
            // 回滚更改
            device.permission_level = old_permission;
            return Err(DeviceManagementError::StorageError(e.to_string()));
        }

        info!("Updated device permission: {} -> {:?}", device_id, permission_level);
        Ok(())
    }

    /// 断开设备连接
    pub async fn disconnect_device(&self, device_id: &str) -> Result<(), DeviceManagementError> {
        let mut devices = self.paired_devices.write().await;
        let device = devices.get_mut(device_id)
            .ok_or_else(|| DeviceManagementError::DeviceNotFound(device_id.to_string()))?;

        if !device.is_connected {
            return Ok(()); // 已经断开
        }

        device.is_connected = false;
        device.last_connected_at = Some(Utc::now());

        // 更新连接统计
        device.connection_count += 1;

        // 保存到存储
        if let Err(e) = self.storage.update_device_connection_status(device_id, false).await {
            warn!("Failed to save connection status: {}", e);
        }

        info!("Disconnected device: {}", device.display_name());
        Ok(())
    }

    /// 取消配对设备
    pub async fn unpair_device(&self, device_id: &str) -> Result<(), DeviceManagementError> {
        let mut devices = self.paired_devices.write().await;

        if !devices.contains_key(device_id) {
            return Err(DeviceManagementError::DeviceNotFound(device_id.to_string()));
        }

        let device = devices.remove(device_id).unwrap();

        // 从所有组中移除
        let mut groups = self.device_groups.write().await;
        for group in groups.values_mut() {
            group.device_ids.retain(|id| id != device_id);
        }

        // 删除统计数据
        let mut stats = self.device_statistics.write().await;
        stats.remove(device_id);

        // 从存储中删除
        if let Err(e) = self.storage.delete_paired_device(device_id).await {
            warn!("Failed to delete device from storage: {}", e);
        }

        info!("Unpaired device: {}", device.display_name());
        Ok(())
    }

    /// 更新设备连接状态
    pub async fn update_device_connection_status(
        &self,
        device_id: &str,
        is_connected: bool,
    ) -> Result<(), DeviceManagementError> {
        let mut devices = self.paired_devices.write().await;
        let device = devices.get_mut(device_id)
            .ok_or_else(|| DeviceManagementError::DeviceNotFound(device_id.to_string()))?;

        let was_connected = device.is_connected;
        device.is_connected = is_connected;
        device.last_seen_at = Utc::now();

        if is_connected && !was_connected {
            device.last_connected_at = Some(Utc::now());
            device.connection_count += 1;
        } else if !is_connected && was_connected {
            if let Some(connected_at) = device.last_connected_at {
                let duration = Utc::now().signed_duration_since(connected_at);
                device.total_connection_time += duration.num_seconds();
            }
        }

        Ok(())
    }

    /// 添加设备标签
    pub async fn add_device_tag(
        &self,
        device_id: &str,
        tag: String,
    ) -> Result<(), DeviceManagementError> {
        let mut devices = self.paired_devices.write().await;
        let device = devices.get_mut(device_id)
            .ok_or_else(|| DeviceManagementError::DeviceNotFound(device_id.to_string()))?;

        if !device.tags.contains(&tag) {
            device.tags.push(tag.clone());

            // 保存到存储
            if let Err(e) = self.storage.update_device_tags(device_id, &device.tags).await {
                // 回滚更改
                device.tags.retain(|t| t != &tag);
                return Err(DeviceManagementError::StorageError(e.to_string()));
            }
        }

        Ok(())
    }

    /// 移除设备标签
    pub async fn remove_device_tag(
        &self,
        device_id: &str,
        tag: &str,
    ) -> Result<(), DeviceManagementError> {
        let mut devices = self.paired_devices.write().await;
        let device = devices.get_mut(device_id)
            .ok_or_else(|| DeviceManagementError::DeviceNotFound(device_id.to_string()))?;

        if device.tags.contains(&tag.to_string()) {
            device.tags.retain(|t| t != tag);

            // 保存到存储
            if let Err(e) = self.storage.update_device_tags(device_id, &device.tags).await {
                return Err(DeviceManagementError::StorageError(e.to_string()));
            }
        }

        Ok(())
    }

    /// 搜索设备
    pub async fn search_devices(&self, query: &str) -> Vec<PairedDevice> {
        let devices = self.paired_devices.read().await;
        let query = query.to_lowercase();

        devices
            .values()
            .filter(|device| {
                device.device_name.to_lowercase().contains(&query) ||
                device.user_alias.as_ref().map(|alias| alias.to_lowercase().contains(&query)).unwrap_or(false) ||
                device.device_model.to_lowercase().contains(&query) ||
                device.tags.iter().any(|tag| tag.to_lowercase().contains(&query))
            })
            .cloned()
            .collect()
    }

    /// 获取设备统计信息
    pub async fn get_device_statistics(&self, device_id: &str) -> Option<DeviceStatistics> {
        let stats = self.device_statistics.read().await;
        stats.get(device_id).cloned()
    }

    /// 更新同步统计
    pub async fn update_sync_statistics(
        &self,
        device_id: &str,
        record: SyncRecord,
    ) -> Result<(), DeviceManagementError> {
        let mut stats = self.device_statistics.write().await;
        let statistics = stats.get_mut(&device_id.to_string())
            .ok_or_else(|| DeviceManagementError::DeviceNotFound(device_id.to_string()))?;

        // 更新统计信息
        statistics.total_sync_operations += 1;
        if record.success {
            statistics.successful_syncs += 1;
        } else {
            statistics.failed_syncs += 1;
        }

        statistics.total_bytes_synced += record.data_size;
        statistics.last_sync_time = Some(record.timestamp);

        // 添加到最近记录
        statistics.recent_syncs.push(record);
        if statistics.recent_syncs.len() > 100 {
            statistics.recent_syncs.remove(0);
        }

        // 计算平均时间
        let total_time: i64 = statistics.recent_syncs.iter().map(|r| r.duration_ms).sum();
        let count = statistics.recent_syncs.len() as i64;
        if count > 0 {
            statistics.average_sync_time_ms = total_time / count;
        }

        // 保存到存储
        if let Err(e) = self.storage.save_device_statistics(device_id, statistics).await {
            warn!("Failed to save device statistics: {}", e);
        }

        Ok(())
    }

    /// 批量操作
    pub async fn batch_disconnect_devices(&self, device_ids: &[String]) -> Vec<Result<(), DeviceManagementError>> {
        let mut results = Vec::new();

        for device_id in device_ids {
            let result = self.disconnect_device(device_id).await;
            results.push(result);
        }

        results
    }

    pub async fn batch_unpair_devices(&self, device_ids: &[String]) -> Vec<Result<(), DeviceManagementError>> {
        let mut results = Vec::new();

        for device_id in device_ids {
            let result = self.unpair_device(device_id).await;
            results.push(result);
        }

        results
    }
}

// 设备存储接口
#[async_trait::async_trait]
pub trait DeviceStorage: Send + Sync {
    async fn save_paired_device(&self, device: &PairedDevice) -> Result<(), Box<dyn std::error::Error>>;
    async fn load_paired_devices(&self) -> Result<Vec<PairedDevice>, Box<dyn std::error::Error>>;
    async fn update_device_alias(&self, device_id: &str, alias: &str) -> Result<(), Box<dyn std::error::Error>>;
    async fn update_device_permission(&self, device_id: &str, permission: &DevicePermissionLevel) -> Result<(), Box<dyn std::error::Error>>;
    async fn update_device_connection_status(&self, device_id: &str, is_connected: bool) -> Result<(), Box<dyn std::error::Error>>;
    async fn update_device_tags(&self, device_id: &str, tags: &[String]) -> Result<(), Box<dyn std::error::Error>>;
    async fn delete_paired_device(&self, device_id: &str) -> Result<(), Box<dyn std::error::Error>>;
    async fn save_device_statistics(&self, device_id: &str, statistics: &DeviceStatistics) -> Result<(), Box<dyn std::error::Error>>;
}
```

### Android 设备管理界面

#### DeviceManagementScreen
```kotlin
// src/platform/android/app/src/main/java/com/nearclip/ui/screens/DeviceManagementScreen.kt
package com.nearclip.ui.screens

import androidx.compose.animation.*
import androidx.compose.animation.core.*
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel
import androidx.lifecycle.compose.collectAsStateWithLifecycle
import com.nearclip.ui.viewmodel.DeviceManagementViewModel

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun DeviceManagementScreen(
    onNavigateBack: () -> Unit,
    onDeviceClick: (String) -> Unit,
    viewModel: DeviceManagementViewModel = hiltViewModel()
) {
    val uiState by viewModel.uiState.collectAsStateWithLifecycle()
    var showRenameDialog by remember { mutableStateOf(false) }
    var selectedDevice by remember { mutableStateOf<PairedDevice?>(null) }

    LaunchedEffect(Unit) {
        viewModel.loadDevices()
    }

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("设备管理") },
                navigationIcon = {
                    IconButton(onClick = onNavigateBack) {
                        Icon(Icons.Default.ArrowBack, contentDescription = "返回")
                    }
                },
                actions = {
                    IconButton(onClick = { viewModel.refreshDevices() }) {
                        Icon(Icons.Default.Refresh, contentDescription = "刷新")
                    }
                }
            )
        },
        floatingActionButton = {
            FloatingActionButton(
                onClick = { viewModel.showAddDeviceDialog() }
            ) {
                Icon(Icons.Default.Add, contentDescription = "添加设备")
            }
        }
    ) { paddingValues ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(paddingValues)
        ) {
            // 搜索栏
            SearchBar(
                query = uiState.searchQuery,
                onQueryChange = { viewModel.updateSearchQuery(it) },
                onSearch = { viewModel.searchDevices() },
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(16.dp)
            )

            // 设备列表
            if (uiState.isLoading) {
                LoadingState()
            } else if (uiState.filteredDevices.isEmpty()) {
                EmptyState()
            } else {
                DeviceList(
                    devices = uiState.filteredDevices,
                    onDeviceClick = onDeviceClick,
                    onRename = { device ->
                        selectedDevice = device
                        showRenameDialog = true
                    },
                    onDisconnect = { viewModel.disconnectDevice(it) },
                    onUnpair = { viewModel.unpairDevice(it) },
                    onTogglePermission = { device, enabled ->
                        viewModel.toggleDeviceAutoConnect(device.deviceId, enabled)
                    },
                    modifier = Modifier.fillMaxSize()
                )
            }
        }
    }

    // 重命名对话框
    if (showRenameDialog && selectedDevice != null) {
        RenameDeviceDialog(
            device = selectedDevice!!,
            onDismiss = { showRenameDialog = false },
            onConfirm = { newName ->
                viewModel.renameDevice(selectedDevice!!.deviceId, newName)
                showRenameDialog = false
                selectedDevice = null
            }
        )
    }
}

@Composable
private fun SearchBar(
    query: String,
    onQueryChange: (String) -> Unit,
    onSearch: () -> Unit,
    modifier: Modifier = Modifier
) {
    OutlinedTextField(
        value = query,
        onValueChange = onQueryChange,
        placeholder = {
            Text("搜索设备...")
        },
        leadingIcon = {
            Icon(Icons.Default.Search, contentDescription = "搜索")
        },
        trailingIcon = {
            if (query.isNotEmpty()) {
                IconButton(onClick = { onQueryChange("") }) {
                    Icon(Icons.Default.Clear, contentDescription = "清除")
                }
            }
        },
        singleLine = true,
        modifier = modifier
    )
}

@Composable
private fun DeviceList(
    devices: List<PairedDevice>,
    onDeviceClick: (PairedDevice) -> Unit,
    onRename: (PairedDevice) -> Unit,
    onDisconnect: (String) -> Unit,
    onUnpair: (String) -> Unit,
    onTogglePermission: (PairedDevice, Boolean) -> Unit,
    modifier: Modifier = Modifier
) {
    LazyColumn(
        modifier = modifier,
        contentPadding = PaddingValues(horizontal = 16.dp, vertical = 8.dp),
        verticalArrangement = Arrangement.spacedBy(8.dp)
    ) {
        items(devices) { device ->
            DeviceManagementCard(
                device = device,
                onClick = { onDeviceClick(device) },
                onRename = { onRename(device) },
                onDisconnect = { onDisconnect(device.deviceId) },
                onUnpair = { onUnpair(device.deviceId) },
                onTogglePermission = onTogglePermission
            )
        }
    }
}

@Composable
private fun DeviceManagementCard(
    device: PairedDevice,
    onClick: () -> Unit,
    onRename: () -> Unit,
    onDisconnect: () -> Unit,
    onUnpair: () -> Unit,
    onTogglePermission: (PairedDevice, Boolean) -> Unit,
    modifier: Modifier = Modifier
) {
    var expanded by remember { mutableStateOf(false) }

    Card(
        modifier = modifier
            .fillMaxWidth()
            .clickable { onClick() },
        elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp)
        ) {
            // 主要信息
            Row(
                modifier = Modifier.fillMaxWidth(),
                verticalAlignment = Alignment.CenterVertically,
                horizontalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                // 设备图标
                DeviceIcon(
                    deviceType = device.deviceType,
                    isConnected = device.isConnected,
                    modifier = Modifier.size(48.dp)
                )

                // 设备信息
                Column(
                    modifier = Modifier.weight(1f),
                    verticalArrangement = Arrangement.spacedBy(4.dp)
                ) {
                    Row(
                        verticalAlignment = Alignment.CenterVertically,
                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        Text(
                            text = device.displayName,
                            style = MaterialTheme.typography.titleMedium,
                            fontWeight = FontWeight.Medium
                        )

                        StatusBadge(status = device.status)
                    }

                    Text(
                        text = device.deviceModel,
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )

                    PermissionBadge(permission = device.permissionLevel)
                }

                // 展开/收起按钮
                IconButton(onClick = { expanded = !expanded }) {
                    Icon(
                        imageVector = if (expanded) Icons.Default.ExpandLess else Icons.Default.ExpandMore,
                        contentDescription = if (expanded) "收起" else "展开"
                    )
                }
            }

            // 展开内容
            AnimatedVisibility(
                visible = expanded,
                enter = expandVertically() + fadeIn(),
                exit = shrinkVertically() + fadeOut()
            ) {
                Column(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(top = 16.dp),
                    verticalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    Divider()

                    // 连接信息
                    ConnectionInfo(device = device)

                    // 权限设置
                    PermissionSettings(
                        device = device,
                        onTogglePermission = onTogglePermission
                    )

                    // 设备标签
                    if (device.tags.isNotEmpty()) {
                        DeviceTags(tags = device.tags)
                    }

                    // 操作按钮
                    ActionButtons(
                        onRename = onRename,
                        onDisconnect = onDisconnect,
                        onUnpair = onUnpair,
                        isConnected = device.isConnected
                    )
                }
            }
        }
    }
}

@Composable
private fun DeviceIcon(
    deviceType: DeviceType,
    isConnected: Boolean,
    modifier: Modifier = Modifier
) {
    Box(
        modifier = modifier
            .clip(RoundedCornerShape(12.dp))
            .background(
                if (isConnected) {
                    MaterialTheme.colorScheme.primaryContainer
                } else {
                    MaterialTheme.colorScheme.surfaceVariant
                }
            )
            .padding(8.dp),
        contentAlignment = Alignment.Center
    ) {
        Icon(
            imageVector = getDeviceTypeIcon(deviceType),
            contentDescription = null,
            tint = if (isConnected) {
                MaterialTheme.colorScheme.primary
            } else {
                MaterialTheme.colorScheme.onSurfaceVariant
            },
            modifier = Modifier.size(32.dp)
        )
    }
}

@Composable
private fun StatusBadge(status: DeviceStatus) {
    Surface(
        color = when (status) {
            DeviceStatus.CONNECTED -> Color(0xFF4CAF50)
            DeviceStatus.CONNECTING -> Color(0xFFFF9800)
            DeviceStatus.DISCONNECTED -> Color(0xFF9E9E9E)
            DeviceStatus.ERROR -> Color(0xFFF44336)
        }.copy(alpha = 0.2f),
        shape = RoundedCornerShape(4.dp)
    ) {
        Text(
            text = when (status) {
                DeviceStatus.CONNECTED -> "已连接"
                DeviceStatus.CONNECTING -> "连接中"
                DeviceStatus.DISCONNECTED -> "已断开"
                DeviceStatus.ERROR -> "错误"
            },
            style = MaterialTheme.typography.labelSmall,
            color = when (status) {
                DeviceStatus.CONNECTED -> Color(0xFF2E7D32)
                DeviceStatus.CONNECTING -> Color(0xFFE65100)
                DeviceStatus.DISCONNECTED -> Color(0xFF616161)
                DeviceStatus.ERROR -> Color(0xFFC62828)
            },
            modifier = Modifier.padding(horizontal = 6.dp, vertical = 2.dp)
        )
    }
}

@Composable
private fun PermissionBadge(permission: DevicePermissionLevel) {
    Surface(
        color = when (permission) {
            DevicePermissionLevel.ADMIN -> Color(0xFF1976D2)
            DevicePermissionLevel.READ_WRITE -> Color(0xFF4CAF50)
            DevicePermissionLevel.READ_ONLY -> Color(0xFFFF9800)
            DevicePermissionLevel.TEMPORARY -> Color(0xFF9C27B0)
        }.copy(alpha = 0.2f),
        shape = RoundedCornerShape(4.dp)
    ) {
        Text(
            text = when (permission) {
                DevicePermissionLevel.ADMIN -> "管理员"
                DevicePermissionLevel.READ_WRITE -> "读写"
                DevicePermissionLevel.READ_ONLY -> "只读"
                DevicePermissionLevel.TEMPORARY -> "临时"
            },
            style = MaterialTheme.typography.labelSmall,
            color = when (permission) {
                DevicePermissionLevel.ADMIN -> Color(0xFF0D47A1)
                DevicePermissionLevel.READ_WRITE -> Color(0xFF2E7D32)
                DevicePermissionLevel.READ_ONLY -> Color(0xFFE65100)
                DevicePermissionLevel.TEMPORARY -> Color(0xFF6A1B9A)
            },
            modifier = Modifier.padding(horizontal = 6.dp, vertical = 2.dp)
        )
    }
}

@Composable
private fun ConnectionInfo(device: PairedDevice) {
    Row(
        modifier = Modifier.fillMaxWidth(),
        horizontalArrangement = Arrangement.SpaceBetween
    ) {
        Column {
            Text(
                text = "连接信息",
                style = MaterialTheme.typography.labelMedium,
                fontWeight = FontWeight.Medium
            )
            Text(
                text = "最后连接: ${formatDateTime(device.lastConnectedAt)}",
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }
        Text(
            text = "连接次数: ${device.connectionCount}",
            style = MaterialTheme.typography.bodySmall,
            color = MaterialTheme.colorScheme.onSurfaceVariant
        )
    }
}

@Composable
private fun PermissionSettings(
    device: PairedDevice,
    onTogglePermission: (PairedDevice, Boolean) -> Unit
) {
    Row(
        modifier = Modifier.fillMaxWidth(),
        horizontalArrangement = Arrangement.SpaceBetween,
        verticalAlignment = Alignment.CenterVertically
    ) {
        Text(
            text = "自动连接",
            style = MaterialTheme.typography.bodyMedium
        )

        Switch(
            checked = device.isAutoConnectEnabled,
            onCheckedChange = { onTogglePermission(device, it) }
        )
    }
}

@Composable
private fun DeviceTags(tags: List<String>) {
    Column {
        Text(
            text = "标签",
            style = MaterialTheme.typography.labelMedium,
            fontWeight = FontWeight.Medium
        )
        Row(
            horizontalArrangement = Arrangement.spacedBy(4.dp)
        ) {
            tags.forEach { tag ->
                Surface(
                    color = MaterialTheme.colorScheme.secondaryContainer,
                    shape = RoundedCornerShape(12.dp)
                ) {
                    Text(
                        text = tag,
                        style = MaterialTheme.typography.labelSmall,
                        color = MaterialTheme.colorScheme.onSecondaryContainer,
                        modifier = Modifier.padding(horizontal = 8.dp, vertical = 4.dp)
                    )
                }
            }
        }
    }
}

@Composable
private fun ActionButtons(
    onRename: () -> Unit,
    onDisconnect: () -> Unit,
    onUnpair: () -> Unit,
    isConnected: Boolean
) {
    Row(
        modifier = Modifier.fillMaxWidth(),
        horizontalArrangement = Arrangement.spacedBy(8.dp)
    ) {
        OutlinedButton(
            onClick = onRename,
            modifier = Modifier.weight(1f)
        ) {
            Icon(Icons.Default.Edit, contentDescription = null, modifier = Modifier.size(16.dp))
            Spacer(modifier = Modifier.width(4.dp))
            Text("重命名")
        }

        if (isConnected) {
            OutlinedButton(
                onClick = onDisconnect,
                modifier = Modifier.weight(1f)
            ) {
                Icon(Icons.Default.LinkOff, contentDescription = null, modifier = Modifier.size(16.dp))
                Spacer(modifier = Modifier.width(4.dp))
                Text("断开")
            }
        }

        OutlinedButton(
            onClick = onUnpair,
            modifier = Modifier.weight(1f),
            colors = ButtonDefaults.outlinedButtonColors(
                contentColor = MaterialTheme.colorScheme.error
            )
        ) {
            Icon(Icons.Default.Delete, contentDescription = null, modifier = Modifier.size(16.dp))
            Spacer(modifier = Modifier.width(4.dp))
            Text("取消配对")
        }
    }
}

@Composable
private fun RenameDeviceDialog(
    device: PairedDevice,
    onDismiss: () -> Unit,
    onConfirm: (String) -> Unit
) {
    var newName by remember { mutableStateOf(device.displayName) }

    AlertDialog(
        onDismissRequest = onDismiss,
        title = {
            Text("重命名设备")
        },
        text = {
            Column {
                Text("为设备 \"${device.displayName}\" 设置新名称：")
                Spacer(modifier = Modifier.height(16.dp))
                OutlinedTextField(
                    value = newName,
                    onValueChange = { newName = it },
                    label = { Text("设备名称") },
                    singleLine = true
                )
            }
        },
        confirmButton = {
            TextButton(
                onClick = {
                    if (newName.isNotBlank()) {
                        onConfirm(newName.trim())
                    }
                },
                enabled = newName.isNotBlank() && newName != device.displayName
            ) {
                Text("确定")
            }
        },
        dismissButton = {
            TextButton(onClick = onDismiss) {
                Text("取消")
            }
        }
    )
}

// 辅助函数
private fun getDeviceTypeIcon(deviceType: DeviceType) -> androidx.compose.ui.graphics.vector.ImageVector {
    return when (deviceType) {
        DeviceType.ANDROID -> Icons.Default.Android
        DeviceType.MAC -> Icons.Default.LaptopMac
        DeviceType.WINDOWS -> Icons.Default.Computer
        DeviceType.IOS -> Icons.Default.PhoneIphone
        else -> Icons.Default.Devices
    }
}

private fun formatDateTime(timestamp: Long?): String {
    return timestamp?.let {
        val formatter = java.text.SimpleDateFormat("MM-dd HH:mm", java.util.Locale.getDefault())
        formatter.format(java.util.Date(it))
    } ?: "从未"
}

@Composable
private fun LoadingState() {
    Box(
        modifier = Modifier.fillMaxSize(),
        contentAlignment = Alignment.Center
    ) {
        Column(
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            CircularProgressIndicator()
            Text(
                text = "加载设备列表...",
                style = MaterialTheme.typography.bodyLarge,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }
    }
}

@Composable
private fun EmptyState() {
    Box(
        modifier = Modifier.fillMaxSize(),
        contentAlignment = Alignment.Center
    ) {
        Column(
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            Icon(
                imageVector = Icons.Default.DevicesOther,
                contentDescription = null,
                modifier = Modifier.size(64.dp),
                tint = MaterialTheme.colorScheme.onSurfaceVariant
            )
            Text(
                text = "暂无已配对设备",
                style = MaterialTheme.typography.headlineSmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
            Text(
                text = "点击右下角按钮添加新设备",
                style = MaterialTheme.typography.bodyMedium,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }
    }
}
```

### Mac 设备管理界面

#### SwiftUI DeviceManagementView
```swift
// src/platform/mac/NearClip/Sources/Views/DeviceManagementView.swift
import SwiftUI

struct DeviceManagementView: View {
    @ObservedObject var deviceManager: DeviceManager
    @State private var searchText = ""
    @State private var selectedDevice: PairedDevice?
    @State private var showingRenameDialog = false
    @State private var showingUnpairConfirmation = false

    var filteredDevices: [PairedDevice] {
        if searchText.isEmpty {
            return deviceManager.pairedDevices
        } else {
            return deviceManager.pairedDevices.filter { device in
                device.displayName.localizedCaseInsensitiveContains(searchText) ||
                device.deviceModel.localizedCaseInsensitiveContains(searchText) ||
                device.tags.contains { $0.localizedCaseInsensitiveContains(searchText) }
            }
        }
    }

    var body: some View {
        VStack(spacing: 0) {
            // Header
            headerView

            Divider()

            // Search Bar
            searchBarView

            Divider()

            // Device List
            deviceListView

            Spacer()
        }
        .frame(width: 500, height: 600)
        .sheet(item: $selectedDevice) { device in
            DeviceDetailView(
                device: device,
                onRename: { newName in
                    deviceManager.renameDevice(device: device, newName: newName)
                },
                onUnpair: {
                    showingUnpairConfirmation = true
                }
            )
        }
        .alert("取消配对", isPresented: $showingUnpairConfirmation) {
            Button("取消", role: .cancel) { }
            Button("确定", role: .destructive) {
                if let device = selectedDevice {
                    deviceManager.unpairDevice(device: device)
                }
            }
        } message: {
            if let device = selectedDevice {
                Text("确定要取消与设备 \"\(device.displayName)\" 的配对吗？\n\n这将删除所有与该设备的连接信息和权限设置。")
            }
        }
    }

    private var headerView: some View {
        HStack {
            Text("设备管理")
                .font(.title2)
                .fontWeight(.semibold)

            Spacer()

            Button(action: deviceManager.refreshDevices) {
                Image(systemName: "arrow.clockwise")
            }
            .buttonStyle(BorderlessButtonStyle())

            Button(action: deviceManager.showAddDeviceDialog) {
                Image(systemName: "plus")
            }
            .buttonStyle(.borderedProminent)
        }
        .padding(.horizontal, 20)
        .padding(.vertical, 12)
    }

    private var searchBarView: some View {
        HStack {
            Image(systemName: "magnifyingglass")
                .foregroundColor(.secondary)

            TextField("搜索设备...", text: $searchText)
                .textFieldStyle(.plain)

            if !searchText.isEmpty {
                Button(action: { searchText = "" }) {
                    Image(systemName: "xmark.circle.fill")
                        .foregroundColor(.secondary)
                }
                .buttonStyle(BorderlessButtonStyle())
            }
        }
        .padding(.horizontal, 12)
        .padding(.vertical, 8)
        .background(Color(NSColor.controlBackgroundColor))
        .cornerRadius(8)
        .padding(.horizontal, 16)
        .padding(.vertical, 8)
    }

    private var deviceListView: some View {
        ScrollView {
            LazyVStack(spacing: 8) {
                ForEach(filteredDevices, id: \.deviceId) { device in
                    DeviceManagementCard(
                        device: device,
                        onClick: { selectedDevice = device },
                        onRename: { selectedDevice = device; showingRenameDialog = true },
                        onDisconnect: { deviceManager.disconnectDevice(device: device) },
                        onUnpair: { selectedDevice = device; showingUnpairConfirmation = true }
                    )
                }
            }
            .padding(.horizontal, 16)
            .padding(.vertical, 8)
        }
    }
}

struct DeviceManagementCard: View {
    let device: PairedDevice
    let onClick: () -> Void
    let onRename: () -> Void
    let onDisconnect: () -> Void
    let onUnpair: () -> Void

    @State private var isExpanded = false

    var body: some View {
        VStack(spacing: 0) {
            // Main content
            Button(action: onClick) {
                HStack(spacing: 16) {
                    // Device icon
                    DeviceIconView(
                        deviceType: device.deviceType,
                        isConnected: device.isConnected
                    )

                    // Device info
                    VStack(alignment: .leading, spacing: 4) {
                        HStack {
                            Text(device.displayName)
                                .font(.subheadline)
                                .fontWeight(.medium)

                            StatusBadgeView(status: device.status)
                        }

                        Text(device.deviceModel)
                            .font(.caption)
                            .foregroundColor(.secondary)

                        PermissionBadgeView(permission: device.permissionLevel)
                    }

                    Spacer()

                    // Expand/collapse icon
                    Image(systemName: isExpanded ? "chevron.up" : "chevron.down")
                        .foregroundColor(.secondary)
                }
                .padding(.horizontal, 16)
                .padding(.vertical, 12)
            }
            .buttonStyle(PlainButtonStyle())
            .cursor(.pointingHand)

            // Expanded content
            if isExpanded {
                VStack(spacing: 12) {
                    Divider()

                    // Connection info
                    ConnectionInfoView(device: device)

                    // Device tags
                    if !device.tags.isEmpty {
                        DeviceTagsView(tags: device.tags)
                    }

                    // Action buttons
                    ActionButtonsView(
                        onRename: onRename,
                        onDisconnect: onDisconnect,
                        onUnpair: onUnpair,
                        isConnected: device.isConnected
                    )
                }
                .padding(.horizontal, 16)
                .padding(.bottom, 12)
            }
        }
        .background(Color(NSColor.controlBackgroundColor))
        .cornerRadius(8)
        .onTapGesture {
            withAnimation(.easeInOut(duration: 0.2)) {
                isExpanded.toggle()
            }
        }
    }
}

struct DeviceIconView: View {
    let deviceType: DeviceType
    let isConnected: Bool

    var body: some View {
        ZStack {
            RoundedRectangle(cornerRadius: 12)
                .fill(isConnected ? Color.accentColor.opacity(0.2) : Color.gray.opacity(0.2))
                .frame(width: 50, height: 50)

            Image(systemName: deviceTypeIconName)
                .font(.system(size: 24))
                .foregroundColor(isConnected ? .accentColor : .secondary)
        }
    }

    private var deviceTypeIconName: String {
        switch deviceType {
        case .android:
            return "iphone"
        case .mac:
            return "laptopcomputer"
        case .windows:
            return "pc"
        case .ios:
            return "ipad"
        }
    }
}

struct StatusBadgeView: View {
    let status: DeviceStatus

    var body: some View {
        Text(status.displayName)
            .font(.caption2)
            .fontWeight(.medium)
            .padding(.horizontal, 6)
            .padding(.vertical, 2)
            .background(status.color.opacity(0.2))
            .foregroundColor(status.color)
            .cornerRadius(4)
    }
}

extension DeviceStatus {
    var displayName: String {
        switch self {
        case .connected:
            return "已连接"
        case .connecting:
            return "连接中"
        case .disconnected:
            return "已断开"
        case .error:
            return "错误"
        }
    }

    var color: Color {
        switch self {
        case .connected:
            return .green
        case .connecting:
            return .orange
        case .disconnected:
            return .gray
        case .error:
            return .red
        }
    }
}

struct PermissionBadgeView: View {
    let permission: DevicePermissionLevel

    var body: some View {
        Text(permission.displayName)
            .font(.caption2)
            .fontWeight(.medium)
            .padding(.horizontal, 6)
            .padding(.vertical, 2)
            .background(permission.color.opacity(0.2))
            .foregroundColor(permission.color)
            .cornerRadius(4)
    }
}

extension DevicePermissionLevel {
    var displayName: String {
        switch self {
        case .admin:
            return "管理员"
        case .readWrite:
            return "读写"
        case .readOnly:
            return "只读"
        case .temporary:
            return "临时"
        }
    }

    var color: Color {
        switch self {
        case .admin:
            return .blue
        case .readWrite:
            return .green
        case .readOnly:
            return .orange
        case .temporary:
            return .purple
        }
    }
}

struct ConnectionInfoView: View {
    let device: PairedDevice

    var body: some View {
        HStack {
            Text("连接信息")
                .font(.caption)
                .fontWeight(.medium)
                .foregroundColor(.secondary)

            Spacer()

            VStack(alignment: .trailing, spacing: 2) {
                Text("最后连接: \(formatDate(device.lastConnectedAt))")
                    .font(.caption2)
                    .foregroundColor(.secondary)
                Text("连接次数: \(device.connectionCount)")
                    .font(.caption2)
                    .foregroundColor(.secondary)
            }
        }
    }

    private func formatDate(_ date: Date?) -> String {
        guard let date = date else { return "从未" }
        let formatter = DateFormatter()
        formatter.dateStyle = .short
        formatter.timeStyle = .short
        return formatter.string(from: date)
    }
}

struct DeviceTagsView: View {
    let tags: [String]

    var body: some View {
        VStack(alignment: .leading, spacing: 4) {
            Text("标签")
                .font(.caption)
                .fontWeight(.medium)
                .foregroundColor(.secondary)

            LazyVGrid(columns: [
                GridItem(.adaptive(minimum: 60))
            ], spacing: 4) {
                ForEach(tags, id: \.self) { tag in
                    Text(tag)
                        .font(.caption2)
                        .padding(.horizontal, 6)
                        .padding(.vertical, 2)
                        .background(Color.secondary.opacity(0.2))
                        .foregroundColor(.secondary)
                        .cornerRadius(8)
                }
            }
        }
    }
}

struct ActionButtonsView: View {
    let onRename: () -> Void
    let onDisconnect: () -> Void
    let onUnpair: () -> Void
    let isConnected: Bool

    var body: some View {
        HStack(spacing: 8) {
            Button("重命名") {
                onRename()
            }
            .buttonStyle(.bordered)
            .controlSize(.small)

            if isConnected {
                Button("断开") {
                    onDisconnect()
                }
                .buttonStyle(.bordered)
                .controlSize(.small)
            }

            Button("取消配对") {
                onUnpair()
            }
            .buttonStyle(.bordered)
            .controlSize(.small)
            .foregroundColor(.red)
        }
    }
}

struct DeviceDetailView: View {
    let device: PairedDevice
    let onRename: (String) -> Void
    let onUnpair: () -> Void
    @Environment(\.dismiss) private var dismiss

    @State private var isEditingName = false
    @State private var newName = ""

    var body: some View {
        VStack(spacing: 0) {
            // Header
            HStack {
                Text("设备详情")
                    .font(.title2)
                    .fontWeight(.semibold)

                Spacer()

                Button("完成") {
                    dismiss()
                }
            }
            .padding()

            Divider()

            // Content
            ScrollView {
                VStack(spacing: 20) {
                    // Device Info Section
                    VStack(alignment: .leading, spacing: 12) {
                        Text("设备信息")
                            .font(.headline)
                            .fontWeight(.medium)

                        if isEditingName {
                            HStack {
                                TextField("设备名称", text: $newName)
                                    .textFieldStyle(.roundedBorder)

                                Button("保存") {
                                    if !newName.isEmpty {
                                        onRename(newName)
                                        isEditingName = false
                                    }
                                }
                                .buttonStyle(.borderedProminent)
                                .disabled(newName.isEmpty)

                                Button("取消") {
                                    newName = device.displayName
                                    isEditingName = false
                                }
                                .buttonStyle(.bordered)
                            }
                        } else {
                            HStack {
                                Text(device.displayName)
                                    .font(.title3)
                                    .fontWeight(.medium)

                                Spacer()

                                Button("编辑") {
                                    newName = device.displayName
                                    isEditingName = true
                                }
                                .buttonStyle(.bordered)
                            }
                        }

                        DetailRow(label: "设备型号", value: device.deviceModel)
                        DetailRow(label: "设备类型", value: device.deviceType.displayName)
                        DetailRow(label: "配对时间", value: formatDate(device.pairedAt))
                        DetailRow(label: "最后连接", value: formatDate(device.lastConnectedAt))
                    }

                    // Permission Section
                    VStack(alignment: .leading, spacing: 12) {
                        Text("权限设置")
                            .font(.headline)
                            .fontWeight(.medium)

                        PermissionDetailView(permission: device.permissionLevel)
                    }

                    // Connection Statistics
                    VStack(alignment: .leading, spacing: 12) {
                        Text("连接统计")
                            .font(.headline)
                            .fontWeight(.medium)

                        DetailRow(label: "连接次数", value: "\(device.connectionCount)")
                        DetailRow(label: "总连接时长", value: formatDuration(device.totalConnectionTime))
                    }

                    // Danger Zone
                    VStack(alignment: .leading, spacing: 12) {
                        Text("危险操作")
                            .font(.headline)
                            .fontWeight(.medium)
                            .foregroundColor(.red)

                        Text("以下操作不可撤销，请谨慎操作。")
                            .font(.caption)
                            .foregroundColor(.secondary)

                        Button("取消配对") {
                            onUnpair()
                            dismiss()
                        }
                        .buttonStyle(.bordered)
                        .foregroundColor(.red)
                        .frame(maxWidth: .infinity)
                    }
                }
                .padding()
            }

            Spacer()
        }
        .frame(width: 400, height: 500)
        .onAppear {
            newName = device.displayName
        }
    }

    private func formatDate(_ date: Date?) -> String {
        guard let date = date else { return "未知" }
        let formatter = DateFormatter()
        formatter.dateStyle = .medium
        formatter.timeStyle = .short
        return formatter.string(from: date)
    }

    private func formatDuration(_ seconds: TimeInterval) -> String {
        let hours = Int(seconds) / 3600
        let minutes = (Int(seconds) % 3600) / 60

        if hours > 0 {
            return "\(hours)小时\(minutes)分钟"
        } else {
            return "\(minutes)分钟"
        }
    }
}

struct DetailRow: View {
    let label: String
    let value: String

    var body: some View {
        HStack {
            Text(label)
                .font(.subheadline)
                .foregroundColor(.secondary)
                .frame(width: 100, alignment: .leading)

            Text(value)
                .font(.subheadline)
                .fontWeight(.medium)

            Spacer()
        }
        .padding(.vertical, 4)
    }
}

struct PermissionDetailView: View {
    let permission: DevicePermissionLevel

    var body: some View {
        VStack(alignment: .leading, spacing: 8) {
            HStack {
                Text("权限级别")
                    .font(.subheadline)
                    .fontWeight(.medium)

                Spacer()

                PermissionBadgeView(permission: permission)
            }

            Text(permission.description)
                .font(.caption)
                .foregroundColor(.secondary)
                .fixedSize(horizontal: false, vertical: true)
        }
        .padding()
        .background(Color(NSColor.controlBackgroundColor))
        .cornerRadius(8)
    }
}

extension DevicePermissionLevel {
    var description: String {
        switch self {
        case .admin:
            return "拥有完全控制权限，可以管理设备设置和其他设备的访问权限。"
        case .readWrite:
            return "可以读取和写入剪贴板内容，进行双向数据同步。"
        case .readOnly:
            return "只能读取剪贴板内容，无法修改或写入数据。"
        case .temporary:
            return "临时权限，将在指定时间后自动失效。"
        }
    }
}

extension DeviceType {
    var displayName: String {
        switch self {
        case .android:
            return "Android"
        case .mac:
            return "macOS"
        case .windows:
            return "Windows"
        case .ios:
            return "iOS"
        }
    }
}

#Preview {
    DeviceManagementView(deviceManager: DeviceManager.preview)
}
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-17 | 1.0 | 初始故事创建，添加已配对设备管理 | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
待开发代理填写

### Debug Log References
待开发代理填写

### Completion Notes List
待开发代理填写

### File List
待开发代理填写

## QA Results
待 QA 代理填写