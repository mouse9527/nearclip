# Story 2.1: 跨平台设备发现界面实现

## Status
Draft

## Story
**作为** 用户，
**我希望** 能够在任何 NearClip 客户端上发现并连接到所有其他平台的设备，
**以便** 我能够在任意设备组合间建立连接（Android↔Android、Android↔Mac、Mac↔Mac 等）。

## Acceptance Criteria
1. Android 端实现设备扫描界面，显示附近所有 NearClip 设备（包括其他 Android 设备）
2. Mac 端实现设备发现功能，在菜单栏显示所有可用设备（包括其他 Mac 设备）
3. 设备列表包含设备名称、平台类型（Android/Mac）、设备型号和信号强度信息
4. 支持所有设备组合的连接：Android↔Android、Android↔Mac、Mac↔Mac
5. 提供设备刷新功能，支持手动重新扫描
6. 处理设备离线和重复发现的情况
7. 实现设备类型的视觉区分，帮助用户识别连接对象
8. **支持设备识别功能，当发现多个同类型设备时，用户能够明确区分具体是哪台设备**
   - 显示设备标识符：设备型号 + 唯一标识后几位（如 "Pixel 6 - 8A3F"）
   - 支持用户自定义设备别名，便于个人识别和管理
   - 在设备列表中显示设备的最后活跃时间，帮助用户识别当前正在使用的设备

## Tasks / Subtasks
- [ ] 设计统一的设备信息数据模型 (AC: 3, 8)
  - [ ] 创建跨平台的 DeviceInfo 数据结构
  - [ ] 定义设备类型、状态和元数据字段
  - [ ] 实现设备唯一标识生成算法
  - [ ] 设计设备别名管理机制
  - [ ] 创建设备活跃时间戳记录
- [ ] 实现 Android 设备发现界面 (AC: 1, 3, 5, 7)
  - [ ] 创建 DeviceDiscoveryScreen Jetpack Compose 组件
  - [ ] 实现设备列表的实时更新
  - [ ] 添加设备类型图标和视觉区分
  - [ ] 实现下拉刷新和自动扫描
  - [ ] 添加设备信号强度指示器
- [ ] 实现 Mac 设备发现界面 (AC: 2, 3, 7)
  - [ ] 创建 Mac 菜单栏设备发现弹出界面
  - [ ] 实现 SwiftUI 设备列表组件
  - [ ] 添加设备状态图标和动画效果
  - [ ] 实现菜单栏状态的实时更新
  - [ ] 添加设备连接预览功能
- [ ] 实现跨平台设备识别功能 (AC: 8)
  - [ ] 实现设备型号检测和显示
  - [ ] 创建设备唯一标识符显示逻辑
  - [ ] 实现用户自定义别名功能
  - [ ] 添加设备最后活跃时间显示
  - [ ] 创建设备指纹识别机制
- [ ] 实现设备状态管理 (AC: 6)
  - [ ] 创建设备在线/离线状态检测
  - [ ] 实现重复设备去除逻辑
  - [ ] 添加设备列表过滤和排序
  - [ ] 实现设备状态缓存机制
  - [ ] 创建设备状态变更通知
- [ ] 实现设备连接功能 (AC: 4)
  - [ ] 创建跨平台连接请求接口
  - [ ] 实现连接状态跟踪和反馈
  - [ ] 添加连接失败处理和重试
  - [ ] 创建连接成功后的状态更新
  - [ ] 实现连接超时和错误处理

## Dev Notes

### 设备信息数据模型设计
[Source: architecture/data-models.md]

#### 统一设备信息结构
```protobuf
// src/shared/protocol/device.proto
syntax = "proto3";

package nearclip.device;

enum DeviceType {
  DEVICE_TYPE_UNKNOWN = 0;
  DEVICE_TYPE_ANDROID = 1;
  DEVICE_TYPE_MAC = 2;
  DEVICE_TYPE_WINDOWS = 3;
  DEVICE_TYPE_IOS = 4;
}

enum DeviceStatus {
  DEVICE_STATUS_OFFLINE = 0;
  DEVICE_STATUS_DISCOVERABLE = 1;
  DEVICE_STATUS_CONNECTING = 2;
  DEVICE_STATUS_CONNECTED = 3;
  DEVICE_STATUS_PAIRING = 4;
  DEVICE_STATUS_ERROR = 5;
}

message DeviceInfo {
  string device_id = 1;                    // 设备唯一标识
  string device_name = 2;                  // 用户可读的设备名称
  DeviceType device_type = 3;              // 设备类型
  string device_model = 4;                 // 设备型号
  string manufacturer = 5;                 // 制造商
  string platform_version = 6;             // 平台版本
  DeviceStatus status = 7;                 // 当前状态
  int32 signal_strength = 8;               // 信号强度 (0-100)
  int64 last_seen = 9;                     // 最后活跃时间戳
  string user_alias = 10;                  // 用户自定义别名
  map<string, string> metadata = 11;       // 扩展元数据
  bytes device_fingerprint = 12;           // 设备指纹
  repeated DeviceCapability capabilities = 13; // 设备能力
}

message DeviceCapability {
  string capability_id = 1;                // 能力ID
  string name = 2;                         // 能力名称
  string version = 3;                      // 能力版本
  bool is_supported = 4;                   // 是否支持
}

message DeviceListRequest {
  int32 timeout_seconds = 1;               // 扫描超时时间
  repeated DeviceType filter_types = 2;    // 设备类型过滤
  bool include_offline = 3;                // 包含离线设备
}

message DeviceListResponse {
  repeated DeviceInfo devices = 1;         // 设备列表
  int64 scan_duration_ms = 2;              // 扫描耗时
  bool is_complete = 3;                    // 是否完整扫描
}
```

#### Rust 数据模型实现
```rust
// src/shared/rust/src/device/models.rs
use chrono::{DateTime, Utc};
use serde::{Deserialize, Serialize};
use std::collections::HashMap;

#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]
pub enum DeviceType {
    Unknown,
    Android,
    Mac,
    Windows,
    Ios,
}

#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]
pub enum DeviceStatus {
    Offline,
    Discoverable,
    Connecting,
    Connected,
    Pairing,
    Error(String),
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DeviceCapability {
    pub capability_id: String,
    pub name: String,
    pub version: String,
    pub is_supported: bool,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DeviceInfo {
    pub device_id: String,
    pub device_name: String,
    pub device_type: DeviceType,
    pub device_model: String,
    pub manufacturer: String,
    pub platform_version: String,
    pub status: DeviceStatus,
    pub signal_strength: i32,
    pub last_seen: DateTime<Utc>,
    pub user_alias: Option<String>,
    pub metadata: HashMap<String, String>,
    pub device_fingerprint: Vec<u8>,
    pub capabilities: Vec<DeviceCapability>,
}

impl DeviceInfo {
    pub fn new(device_id: String, device_type: DeviceType) -> Self {
        Self {
            device_id,
            device_name: String::new(),
            device_type,
            device_model: String::new(),
            manufacturer: String::new(),
            platform_version: String::new(),
            status: DeviceStatus::Discoverable,
            signal_strength: 0,
            last_seen: Utc::now(),
            user_alias: None,
            metadata: HashMap::new(),
            device_fingerprint: Vec::new(),
            capabilities: Vec::new(),
        }
    }

    pub fn display_name(&self) -> String {
        if let Some(ref alias) = self.user_alias {
            alias.clone()
        } else {
            format!("{} - {}",
                self.device_name,
                self.device_id.chars().rev().take(4).collect::<String>().chars().rev().collect::<String>()
            )
        }
    }

    pub fn is_online(&self) -> bool {
        matches!(self.status, DeviceStatus::Discoverable | DeviceStatus::Connected)
    }

    pub fn last_seen_formatted(&self) -> String {
        let now = Utc::now();
        let duration = now.signed_duration_since(self.last_seen);

        if duration.num_minutes() < 1 {
            "刚刚".to_string()
        } else if duration.num_minutes() < 60 {
            format!("{} 分钟前", duration.num_minutes())
        } else if duration.num_hours() < 24 {
            format!("{} 小时前", duration.num_hours())
        } else {
            format!("{} 天前", duration.num_days())
        }
    }

    pub fn generate_fingerprint(&mut self) {
        use ring::digest::{self, Context};

        let mut context = Context::new(&digest::SHA256);
        context.update(self.device_id.as_bytes());
        context.update(self.device_name.as_bytes());
        context.update(self.device_model.as_bytes());
        context.update(self.manufacturer.as_bytes());

        self.device_fingerprint = context.finish().as_ref().to_vec();
    }
}

// 设备别名管理
pub struct DeviceAliasManager {
    aliases: HashMap<String, String>,
}

impl DeviceAliasManager {
    pub fn new() -> Self {
        Self {
            aliases: HashMap::new(),
        }
    }

    pub fn set_alias(&mut self, device_id: &str, alias: String) {
        self.aliases.insert(device_id.to_string(), alias);
    }

    pub fn get_alias(&self, device_id: &str) -> Option<&String> {
        self.aliases.get(device_id)
    }

    pub fn remove_alias(&mut self, device_id: &str) -> Option<String> {
        self.aliases.remove(device_id)
    }

    pub fn apply_alias_to_device(&self, device: &mut DeviceInfo) {
        if let Some(alias) = self.get_alias(&device.device_id) {
            device.user_alias = Some(alias.clone());
        }
    }
}
```

### Android 设备发现界面实现

#### Jetpack Compose 组件
```kotlin
// src/platform/android/app/src/main/java/com/nearclip/ui/screens/DeviceDiscoveryScreen.kt
package com.nearclip.ui.screens

import androidx.compose.animation.*
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.vector.ImageVector
import androidx.compose.ui.res.stringResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel
import androidx.lifecycle.compose.collectAsStateWithLifecycle
import com.nearclip.data.model.DeviceInfo
import com.nearclip.ui.components.DeviceCard
import com.nearclip.ui.viewmodel.DeviceDiscoveryViewModel

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun DeviceDiscoveryScreen(
    onNavigateBack: () -> Unit,
    onDeviceClick: (DeviceInfo) -> Unit,
    viewModel: DeviceDiscoveryViewModel = hiltViewModel()
) {
    val uiState by viewModel.uiState.collectAsStateWithLifecycle()

    LaunchedEffect(Unit) {
        viewModel.startDeviceDiscovery()
    }

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("设备发现") },
                navigationIcon = {
                    IconButton(onClick = onNavigateBack) {
                        Icon(Icons.Default.ArrowBack, contentDescription = "返回")
                    }
                },
                actions = {
                    IconButton(
                        onClick = { viewModel.refreshDevices() },
                        enabled = !uiState.isRefreshing
                    ) {
                        if (uiState.isRefreshing) {
                            CircularProgressIndicator(
                                modifier = Modifier.size(24.dp),
                                strokeWidth = 2.dp
                            )
                        } else {
                            Icon(Icons.Default.Refresh, contentDescription = "刷新")
                        }
                    }
                }
            )
        }
    ) { paddingValues ->
        Box(
            modifier = Modifier
                .fillMaxSize()
                .padding(paddingValues)
        ) {
            when {
                uiState.isLoading -> {
                    LoadingState()
                }
                uiState.devices.isEmpty() && !uiState.isRefreshing -> {
                    EmptyState(onRefresh = { viewModel.refreshDevices() })
                }
                else -> {
                    DeviceList(
                        devices = uiState.devices,
                        onDeviceClick = onDeviceClick,
                        onDeviceAliasChange = { deviceId, alias ->
                            viewModel.updateDeviceAlias(deviceId, alias)
                        }
                    )
                }
            }

            // 错误提示
            uiState.error?.let { error ->
                LaunchedEffect(error) {
                    // 显示错误信息
                    viewModel.clearError()
                }
            }
        }
    }
}

@Composable
private fun DeviceList(
    devices: List<DeviceInfo>,
    onDeviceClick: (DeviceInfo) -> Unit,
    onDeviceAliasChange: (String, String) -> Unit
) {
    LazyColumn(
        modifier = Modifier.fillMaxSize(),
        contentPadding = PaddingValues(16.dp),
        verticalArrangement = Arrangement.spacedBy(8.dp)
    ) {
        // 设备类型分组标题
        items(groupDevicesByType(devices).keys.toList()) { deviceType ->
            DeviceTypeHeader(deviceType)
        }

        // 设备列表
        items(groupDevicesByType(devices).values.flatten()) { device ->
            DeviceCard(
                device = device,
                onClick = { onDeviceClick(device) },
                onAliasChange = { alias -> onDeviceAliasChange(device.deviceId, alias) }
            )
        }
    }
}

@Composable
private fun DeviceTypeHeader(deviceType: String) {
    Row(
        modifier = Modifier
            .fillMaxWidth()
            .padding(vertical = 8.dp),
        verticalAlignment = Alignment.CenterVertically
    ) {
        Icon(
            imageVector = getDeviceTypeIcon(deviceType),
            contentDescription = null,
            tint = MaterialTheme.colorScheme.primary,
            modifier = Modifier.size(20.dp)
        )
        Spacer(modifier = Modifier.width(8.dp))
        Text(
            text = deviceType,
            style = MaterialTheme.typography.titleMedium,
            fontWeight = FontWeight.Bold,
            color = MaterialTheme.colorScheme.primary
        )
    }
}

@Composable
private fun LoadingState() {
    Box(
        modifier = Modifier.fillMaxSize(),
        contentAlignment = Alignment.Center
    ) {
        Column(
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            CircularProgressIndicator()
            Text(
                text = "正在搜索设备...",
                style = MaterialTheme.typography.bodyLarge,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }
    }
}

@Composable
private fun EmptyState(onRefresh: () -> Unit) {
    Box(
        modifier = Modifier.fillMaxSize(),
        contentAlignment = Alignment.Center
    ) {
        Column(
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            Icon(
                imageVector = Icons.Default.BluetoothSearching,
                contentDescription = null,
                modifier = Modifier.size(64.dp),
                tint = MaterialTheme.colorScheme.onSurfaceVariant
            )
            Text(
                text = "未发现设备",
                style = MaterialTheme.typography.headlineSmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
            Text(
                text = "请确保其他设备已开启 NearClip 并处于可发现状态",
                style = MaterialTheme.typography.bodyMedium,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
            Button(onClick = onRefresh) {
                Icon(Icons.Default.Refresh, contentDescription = null)
                Spacer(modifier = Modifier.width(8.dp))
                Text("重新扫描")
            }
        }
    }
}

private fun groupDevicesByType(devices: List<DeviceInfo>): Map<String, List<DeviceInfo>> {
    return devices.groupBy { device ->
        when (device.deviceType) {
            "ANDROID" -> "Android 设备"
            "MAC" -> "Mac 设备"
            else -> "其他设备"
        }
    }
}

private fun getDeviceTypeIcon(deviceType: String): ImageVector {
    return when (deviceType) {
        "Android 设备" -> Icons.Default.Android
        "Mac 设备" -> Icons.Default.LaptopMac
        else -> Icons.Default.Devices
    }
}
```

#### DeviceCard 组件
```kotlin
// src/platform/android/app/src/main/java/com/nearclip/ui/components/DeviceCard.kt
package com.nearclip.ui.components

import androidx.compose.animation.*
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.vector.ImageVector
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp
import com.nearclip.data.model.DeviceInfo

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun DeviceCard(
    device: DeviceInfo,
    onClick: () -> Unit,
    onAliasChange: (String) -> Unit,
    modifier: Modifier = Modifier
) {
    var isEditingAlias by remember { mutableStateOf(false) }
    var aliasText by remember { mutableStateOf(device.userAlias ?: "") }

    Card(
        modifier = modifier
            .fillMaxWidth()
            .clickable { onClick() },
        elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            // 设备图标
            DeviceIcon(
                deviceType = device.deviceType,
                isOnline = device.isOnline,
                modifier = Modifier.size(48.dp)
            )

            Spacer(modifier = Modifier.width(16.dp))

            // 设备信息
            Column(
                modifier = Modifier.weight(1f)
            ) {
                // 设备名称
                if (isEditingAlias) {
                    OutlinedTextField(
                        value = aliasText,
                        onValueChange = { aliasText = it },
                        singleLine = true,
                        textStyle = MaterialTheme.typography.titleMedium,
                        colors = OutlinedTextFieldDefaults.colors(
                            unfocusedBorderColor = Color.Transparent,
                            focusedBorderColor = MaterialTheme.colorScheme.primary
                        )
                    )
                } else {
                    Row(
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Text(
                            text = device.display_name,
                            style = MaterialTheme.typography.titleMedium,
                            fontWeight = FontWeight.Medium,
                            maxLines = 1,
                            overflow = TextOverflow.Ellipsis,
                            modifier = Modifier.weight(1f)
                        )

                        // 编辑别名按钮
                        IconButton(
                            onClick = { isEditingAlias = true },
                            modifier = Modifier.size(24.dp)
                        ) {
                            Icon(
                                imageVector = Icons.Default.Edit,
                                contentDescription = "编辑别名",
                                modifier = Modifier.size(16.dp)
                            )
                        }
                    }
                }

                // 设备型号和状态
                Row(
                    verticalAlignment = Alignment.CenterVertically,
                    horizontalArrangement = Arrangement.spacedBy(8.dp)
                ) {
                    Text(
                        text = device.deviceModel,
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )

                    Text(
                        text = "•",
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )

                    Text(
                        text = device.status_display,
                        style = MaterialTheme.typography.bodyMedium,
                        color = if (device.isOnline) {
                            MaterialTheme.colorScheme.primary
                        } else {
                            MaterialTheme.colorScheme.error
                        }
                    )
                }

                // 最后活跃时间和信号强度
                Row(
                    verticalAlignment = Alignment.CenterVertically,
                    horizontalArrangement = Arrangement.spacedBy(8.dp)
                ) {
                    Icon(
                        imageVector = Icons.Default.Schedule,
                        contentDescription = null,
                        modifier = Modifier.size(14.dp),
                        tint = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                    Text(
                        text = device.last_seen_formatted,
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )

                    if (device.signal_strength > 0) {
                        Icon(
                            imageVector = getSignalStrengthIcon(device.signal_strength),
                            contentDescription = null,
                            modifier = Modifier.size(14.dp),
                            tint = getSignalStrengthColor(device.signal_strength)
                        )
                        Text(
                            text = "${device.signal_strength}%",
                            style = MaterialTheme.typography.bodySmall,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                }
            }

            Spacer(modifier = Modifier.width(16.dp))

            // 连接状态
            ConnectionStateIndicator(
                status = device.connectionStatus,
                modifier = Modifier.size(24.dp)
            )
        }
    }

    // 处理别名编辑完成
    LaunchedEffect(isEditingAlias) {
        if (!isEditingAlias && aliasText != device.userAlias) {
            onAliasChange(aliasText)
        }
    }
}

@Composable
private fun DeviceIcon(
    deviceType: String,
    isOnline: Boolean,
    modifier: Modifier = Modifier
) {
    Box(
        modifier = modifier
            .clip(CircleShape)
            .background(
                if (isOnline) {
                    MaterialTheme.colorScheme.primaryContainer
                } else {
                    MaterialTheme.colorScheme.surfaceVariant
                }
            )
            .padding(12.dp),
        contentAlignment = Alignment.Center
    ) {
        Icon(
            imageVector = getDeviceTypeIcon(deviceType),
            contentDescription = null,
            tint = if (isOnline) {
                MaterialTheme.colorScheme.primary
            } else {
                MaterialTheme.colorScheme.onSurfaceVariant
            },
            modifier = Modifier.size(24.dp)
        )
    }
}

@Composable
private fun ConnectionStateIndicator(
    status: String,
    modifier: Modifier = Modifier
) {
    val (color, icon) = when (status) {
        "CONNECTED" -> MaterialTheme.colorScheme.primary to Icons.Default.CheckCircle
        "CONNECTING" -> MaterialTheme.colorScheme.secondary to Icons.Default.Sync
        "PAIRING" -> MaterialTheme.colorScheme.tertiary to Icons.Default.Link
        else -> MaterialTheme.colorScheme.outline to Icons.Default.Circle
    }

    Icon(
        imageVector = icon,
        contentDescription = null,
        tint = color,
        modifier = modifier
    )
}

private fun getDeviceTypeIcon(deviceType: String): ImageVector {
    return when (deviceType) {
        "ANDROID" -> Icons.Default.Android
        "MAC" -> Icons.Default.LaptopMac
        else -> Icons.Default.Smartphone
    }
}

private fun getSignalStrengthIcon(strength: Int): ImageVector {
    return when {
        strength >= 80 -> Icons.Default.SignalWifi4Bar
        strength >= 60 -> Icons.Default.SignalWifi3Bar
        strength >= 40 -> Icons.Default.SignalWifi2Bar
        strength >= 20 -> Icons.Default.SignalWifi1Bar
        else -> Icons.Default.SignalWifi0Bar
    }
}

private fun getSignalStrengthColor(strength: Int): Color {
    return when {
        strength >= 80 -> Color(0xFF4CAF50) // Green
        strength >= 60 -> Color(0xFF8BC34A) // Light Green
        strength >= 40 -> Color(0xFFFFC107) // Amber
        strength >= 20 -> Color(0xFFFF9800) // Orange
        else -> Color(0xFFF44336) // Red
    }
}
```

### Mac 设备发现界面实现

#### SwiftUI 菜单栏组件
```swift
// src/platform/mac/NearClip/Sources/Views/DeviceDiscoveryView.swift
import SwiftUI

struct DeviceDiscoveryView: View {
    @ObservedObject var deviceManager: DeviceManager
    @State private var isRefreshing = false
    @State private var editingDeviceId: String?
    @State private var aliasText = ""

    var body: some View {
        VStack(spacing: 0) {
            // Header
            headerView

            Divider()

            // Device List
            deviceListView

            Divider()

            // Footer
            footerView
        }
        .frame(width: 320, height: 400)
        .onAppear {
            deviceManager.startDiscovery()
        }
        .onDisappear {
            deviceManager.stopDiscovery()
        }
    }

    private var headerView: some View {
        HStack {
            Text("设备发现")
                .font(.headline)
                .fontWeight(.semibold)

            Spacer()

            Button(action: refreshDevices) {
                Image(systemName: isRefreshing ? "arrow.clockwise" : "arrow.clockwise")
                    .rotationEffect(.degrees(isRefreshing ? 360 : 0))
                    .animation(.linear(duration: 1).repeatForever(autoreverses: false), value: isRefreshing)
            }
            .disabled(isRefreshing)
            .buttonStyle(BorderlessButtonStyle())
        }
        .padding(.horizontal, 16)
        .padding(.vertical, 12)
    }

    private var deviceListView: some View {
        ScrollView {
            LazyVStack(spacing: 8) {
                ForEach(groupedDevices.keys.sorted(), id: \.self) { deviceType in
                    DeviceTypeSection(
                        title: deviceType,
                        devices: groupedDevices[deviceType] ?? [],
                        onDeviceClick: deviceManager.connectToDevice,
                        onAliasChange: updateDeviceAlias
                    )
                }
            }
            .padding(.horizontal, 12)
            .padding(.vertical, 8)
        }
    }

    private var footerView: some View {
        HStack {
            Text("\(deviceManager.discoveredDevices.count) 个设备")
                .font(.caption)
                .foregroundColor(.secondary)

            Spacer()

            if isRefreshing {
                ProgressView()
                    .scaleEffect(0.8)
            }
        }
        .padding(.horizontal, 16)
        .padding(.vertical, 8)
    }

    private var groupedDevices: [String: [Device]] {
        Dictionary(grouping: deviceManager.discoveredDevices) { device in
            switch device.type {
            case .android:
                return "Android 设备"
            case .mac:
                return "Mac 设备"
            case .windows:
                return "Windows 设备"
            case .ios:
                return "iOS 设备"
            default:
                return "其他设备"
            }
        }
    }

    private func refreshDevices() {
        isRefreshing = true
        deviceManager.refreshDevices()

        DispatchQueue.main.asyncAfter(deadline: .now() + 2) {
            isRefreshing = false
        }
    }

    private func updateDeviceAlias(deviceId: String, alias: String) {
        deviceManager.updateDeviceAlias(deviceId: deviceId, alias: alias)
    }
}

struct DeviceTypeSection: View {
    let title: String
    let devices: [Device]
    let onDeviceClick: (Device) -> Void
    let onAliasChange: (String, String) -> Void

    var body: some View {
        VStack(alignment: .leading, spacing: 8) {
            // Section Header
            HStack {
                Image(systemName: sectionIcon)
                    .foregroundColor(.accentColor)

                Text(title)
                    .font(.subheadline)
                    .fontWeight(.semibold)
                    .foregroundColor(.accentColor)

                Spacer()
            }

            // Device Cards
            ForEach(devices) { device in
                DeviceCard(
                    device: device,
                    onClick: { onDeviceClick(device) },
                    onAliasChange: onAliasChange
                )
            }
        }
        .padding(.vertical, 4)
    }

    private var sectionIcon: String {
        switch title {
        case "Android 设备":
            return "iphone"
        case "Mac 设备":
            return "laptopcomputer"
        case "Windows 设备":
            return "pc"
        case "iOS 设备":
            return "ipad"
        default:
            return "computermouse"
        }
    }
}

struct DeviceCard: View {
    let device: Device
    let onClick: () -> Void
    let onAliasChange: (String, String) -> Void

    @State private var isEditingAlias = false
    @State private var aliasText = ""

    var body: some View {
        HStack(spacing: 12) {
            // Device Icon
            deviceIcon

            // Device Info
            VStack(alignment: .leading, spacing: 4) {
                // Device Name
                if isEditingAlias {
                    TextField("设备别名", text: $aliasText)
                        .textFieldStyle(RoundedBorderTextFieldStyle())
                        .onSubmit {
                            saveAlias()
                        }
                } else {
                    HStack {
                        Text(displayName)
                            .font(.subheadline)
                            .fontWeight(.medium)
                            .lineLimit(1)

                        Button(action: { startEditingAlias() }) {
                            Image(systemName: "pencil")
                                .font(.caption)
                                .foregroundColor(.secondary)
                        }
                        .buttonStyle(BorderlessButtonStyle())
                    }
                }

                // Device Model and Status
                HStack(spacing: 6) {
                    Text(device.model)
                        .font(.caption)
                        .foregroundColor(.secondary)

                    Text("•")
                        .font(.caption)
                        .foregroundColor(.secondary)

                    Text(statusText)
                        .font(.caption)
                        .foregroundColor(statusColor)
                }

                // Last Seen and Signal Strength
                HStack(spacing: 6) {
                    Image(systemName: "clock")
                        .font(.caption2)
                        .foregroundColor(.secondary)

                    Text(lastSeenText)
                        .font(.caption2)
                        .foregroundColor(.secondary)

                    if device.signalStrength > 0 {
                        Image(systemName: signalStrengthIcon)
                            .font(.caption2)
                            .foregroundColor(signalStrengthColor)

                        Text("\(device.signalStrength)%")
                            .font(.caption2)
                            .foregroundColor(.secondary)
                    }
                }
            }

            Spacer()

            // Connection Status
            connectionStatusIcon
        }
        .padding(.horizontal, 12)
        .padding(.vertical, 8)
        .background(
            RoundedRectangle(cornerRadius: 8)
                .fill(Color(NSColor.controlBackgroundColor))
        )
        .onTapGesture {
            onClick()
        }
    }

    private var deviceIcon: some View {
        ZStack {
            Circle()
                .fill(backgroundColor)
                .frame(width: 40, height: 40)

            Image(systemName: deviceIconName)
                .font(.system(size: 18))
                .foregroundColor(iconColor)
        }
    }

    private var backgroundColor: Color {
        device.isOnline ? Color.accentColor.opacity(0.1) : Color.gray.opacity(0.1)
    }

    private var iconColor: Color {
        device.isOnline ? Color.accentColor : Color.gray
    }

    private var deviceIconName: String {
        switch device.type {
        case .android:
            return "iphone"
        case .mac:
            return "laptopcomputer"
        case .windows:
            return "pc"
        case .ios:
            return "ipad"
        default:
            return "computermouse"
        }
    }

    private var displayName: String {
        device.userAlias ?? device.name
    }

    private var statusText: String {
        switch device.connectionStatus {
        case .connected:
            return "已连接"
        case .connecting:
            return "连接中"
        case .pairing:
            return "配对中"
        default:
            return "离线"
        }
    }

    private var statusColor: Color {
        switch device.connectionStatus {
        case .connected:
            return .green
        case .connecting, .pairing:
            return .orange
        default:
            return .red
        }
    }

    private var lastSeenText: String {
        let formatter = RelativeDateTimeFormatter()
        formatter.unitsStyle = .abbreviated
        return formatter.localizedString(for: device.lastSeen, relativeTo: Date())
    }

    private var signalStrengthIcon: String {
        switch device.signalStrength {
        case 80...100:
            return "wifi"
        case 60..<80:
            return "wifi.2"
        case 40..<60:
            return "wifi.1"
        case 1..<40:
            return "wifi.0"
        default:
            return "wifi.slash"
        }
    }

    private var signalStrengthColor: Color {
        switch device.signalStrength {
        case 80...100:
            return .green
        case 60..<80:
            return .yellow
        case 40..<60:
            return .orange
        case 1..<40:
            return .red
        default:
            return .gray
        }
    }

    private var connectionStatusIcon: some View {
        Image(systemName: connectionStatusIconName)
            .font(.system(size: 16))
            .foregroundColor(connectionStatusColor)
    }

    private var connectionStatusIconName: String {
        switch device.connectionStatus {
        case .connected:
            return "checkmark.circle.fill"
        case .connecting:
            return "arrow.clockwise"
        case .pairing:
            return "link"
        default:
            return "circle"
        }
    }

    private var connectionStatusColor: Color {
        switch device.connectionStatus {
        case .connected:
            return .green
        case .connecting:
            return .blue
        case .pairing:
            return .orange
        default:
            return .gray
        }
    }

    private func startEditingAlias() {
        aliasText = device.userAlias ?? ""
        isEditingAlias = true
    }

    private func saveAlias() {
        onAliasChange(device.id, aliasText)
        isEditingAlias = false
    }
}

#Preview {
    DeviceDiscoveryView(deviceManager: DeviceManager.preview)
}
```

### 设备发现管理器

#### Android ViewModel
```kotlin
// src/platform/android/app/src/main/java/com/nearclip/ui/viewmodel/DeviceDiscoveryViewModel.kt
package com.nearclip.ui.viewmodel

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.nearclip.bridge.RustNativeBridge
import com.nearclip.data.model.DeviceInfo
import com.nearclip.domain.repository.DeviceRepository
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.Job
import kotlinx.coroutines.delay
import kotlinx.coroutines.flow.*
import kotlinx.coroutines.launch
import javax.inject.Inject

data class DeviceDiscoveryUiState(
    val isLoading: Boolean = false,
    val isRefreshing: Boolean = false,
    val devices: List<DeviceInfo> = emptyList(),
    val error: String? = null
)

@HiltViewModel
class DeviceDiscoveryViewModel @Inject constructor(
    private val deviceRepository: DeviceRepository,
    private val rustBridge: RustNativeBridge
) : ViewModel() {

    private val _uiState = MutableStateFlow(DeviceDiscoveryUiState())
    val uiState: StateFlow<DeviceDiscoveryUiState> = _uiState.asStateFlow()

    private var discoveryJob: Job? = null
    private var refreshJob: Job? = null

    fun startDeviceDiscovery() {
        discoveryJob?.cancel()
        discoveryJob = viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true, error = null) }

            try {
                // 启动 Rust 设备发现
                val result = rustBridge.startDeviceDiscovery()

                if (result.isFailure) {
                    throw Exception("Failed to start device discovery: ${result.exceptionOrNull()?.message}")
                }

                // 监听设备发现结果
                delay(2000) // 给设备发现一些时间

                // 从本地数据库加载设备列表
                deviceRepository.getAllDevices()
                    .collect { devices ->
                        _uiState.update {
                            it.copy(
                                isLoading = false,
                                devices = devices.filter { it.isOnline }
                            )
                        }
                    }

            } catch (e: Exception) {
                _uiState.update {
                    it.copy(
                        isLoading = false,
                        error = e.message
                    )
                }
            }
        }
    }

    fun refreshDevices() {
        refreshJob?.cancel()
        refreshJob = viewModelScope.launch {
            _uiState.update { it.copy(isRefreshing = true, error = null) }

            try {
                // 重新启动设备发现
                val result = rustBridge.startDeviceDiscovery()

                if (result.isFailure) {
                    throw Exception("Failed to refresh devices: ${result.exceptionOrNull()?.message}")
                }

                // 等待刷新完成
                delay(3000)

            } catch (e: Exception) {
                _uiState.update {
                    it.copy(
                        isRefreshing = false,
                        error = e.message
                    )
                }
            } finally {
                _uiState.update { it.copy(isRefreshing = false) }
            }
        }
    }

    fun updateDeviceAlias(deviceId: String, alias: String) {
        viewModelScope.launch {
            try {
                deviceRepository.updateDeviceAlias(deviceId, alias)

                // 更新本地状态
                val currentDevices = _uiState.value.devices.toMutableList()
                val deviceIndex = currentDevices.indexOfFirst { it.deviceId == deviceId }
                if (deviceIndex >= 0) {
                    currentDevices[deviceIndex] = currentDevices[deviceIndex].copy(userAlias = alias)
                    _uiState.update { it.copy(devices = currentDevices) }
                }
            } catch (e: Exception) {
                _uiState.update { it.copy(error = "Failed to update alias: ${e.message}") }
            }
        }
    }

    fun clearError() {
        _uiState.update { it.copy(error = null) }
    }

    override fun onCleared() {
        super.onCleared()
        discoveryJob?.cancel()
        refreshJob?.cancel()
    }
}
```

#### Mac DeviceManager
```swift
// src/platform/mac/NearClip/Sources/Services/DeviceManager.swift
import Foundation
import Combine
import CoreBluetooth

@MainActor
class DeviceManager: ObservableObject {
    @Published var discoveredDevices: [Device] = []
    @Published var isScanning = false

    private var bluetoothManager: BluetoothManager
    private var cancellables = Set<AnyCancellable>()
    private var aliasManager = DeviceAliasManager()

    init(bluetoothManager: BluetoothManager = BluetoothManager()) {
        self.bluetoothManager = bluetoothManager
        setupBindings()
    }

    func startDiscovery() {
        guard !isScanning else { return }

        isScanning = true
        bluetoothManager.startScanning()
    }

    func stopDiscovery() {
        guard isScanning else { return }

        isScanning = false
        bluetoothManager.stopScanning()
    }

    func refreshDevices() {
        stopDiscovery()
        discoveredDevices.removeAll()

        DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
            self.startDiscovery()
        }
    }

    func connectToDevice(_ device: Device) {
        bluetoothManager.connectToDevice(device)
    }

    func updateDeviceAlias(deviceId: String, alias: String) {
        aliasManager.setAlias(deviceId: deviceId, alias: alias)

        // 更新已发现设备的别名
        if let index = discoveredDevices.firstIndex(where: { $0.id == deviceId }) {
            discoveredDevices[index].userAlias = alias
        }
    }

    private func setupBindings() {
        bluetoothManager.$discoveredDevices
            .receive(on: DispatchQueue.main)
            .sink { [weak self] rustDevices in
                self?.updateDiscoveredDevices(rustDevices)
            }
            .store(in: &cancellables)
    }

    private func updateDiscoveredDevices(_ rustDevices: [RustDevice]) {
        var devices: [Device] = []

        for rustDevice in rustDevices {
            var device = Device(from: rustDevice)

            // 应用用户别名
            if let alias = aliasManager.getAlias(deviceId: device.id) {
                device.userAlias = alias
            }

            devices.append(device)
        }

        // 按设备类型和信号强度排序
        devices.sort { device1, device2 in
            if device1.type != device2.type {
                return device1.type.rawValue < device2.type.rawValue
            }
            return device1.signalStrength > device2.signalStrength
        }

        discoveredDevices = devices
    }

    static var preview: DeviceManager {
        let manager = DeviceManager()
        manager.discoveredDevices = Device.previewDevices
        return manager
    }
}

// 设备别名管理
class DeviceAliasManager {
    private var aliases: [String: String] = [:]
    private let userDefaults = UserDefaults.standard
    private let aliasesKey = "DeviceAliases"

    init() {
        loadAliases()
    }

    func setAlias(deviceId: String, alias: String) {
        aliases[deviceId] = alias
        saveAliases()
    }

    func getAlias(deviceId: String) -> String? {
        return aliases[deviceId]
    }

    func removeAlias(deviceId: String) {
        aliases.removeValue(forKey: deviceId)
        saveAliases()
    }

    private func loadAliases() {
        if let data = userDefaults.data(forKey: aliasesKey),
           let decoded = try? JSONDecoder().decode([String: String].self, from: data) {
            aliases = decoded
        }
    }

    private func saveAliases() {
        if let encoded = try? JSONEncoder().encode(aliases) {
            userDefaults.set(encoded, forKey: aliasesKey)
        }
    }
}

// Preview Data
extension Device {
    static var previewDevices: [Device] {
        [
            Device(
                id: "android-1",
                name: "Pixel 6",
                type: .android,
                model: "Pixel 6",
                manufacturer: "Google",
                connectionStatus: .connected,
                signalStrength: 85,
                lastSeen: Date(),
                userAlias: "我的手机"
            ),
            Device(
                id: "mac-1",
                name: "MacBook Pro",
                type: .mac,
                model: "MacBook Pro 16-inch",
                manufacturer: "Apple",
                connectionStatus: .connecting,
                signalStrength: 92,
                lastSeen: Date().addingTimeInterval(-60),
                userAlias: "工作电脑"
            ),
            Device(
                id: "android-2",
                name: "Galaxy S22",
                type: .android,
                model: "Galaxy S22",
                manufacturer: "Samsung",
                connectionStatus: .disconnected,
                signalStrength: 45,
                lastSeen: Date().addingTimeInterval(-300)
            )
        ]
    }
}
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-17 | 1.0 | 初始故事创建，添加跨平台设备发现界面 | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
待开发代理填写

### Debug Log References
待开发代理填写

### Completion Notes List
待开发代理填写

### File List
待开发代理填写

## QA Results
待 QA 代理填写