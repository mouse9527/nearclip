# Story 1.6: BLE通信实机测试验证

## Status
Draft

## Story
**作为** QA测试工程师，
**我希望** 在真实的Android设备环境中验证BLE通信功能，
**以便** 确保模拟环境中的功能在实际硬件上能够正常工作，并验证性能指标是否达到预期目标。

## Acceptance Criteria
1. 在两台真实Android设备间建立BLE连接并验证基础通信功能
2. 验证设备发现过程在实际环境中的表现和稳定性
3. 测试消息传输的延迟和可靠性，验证性能目标达成情况
4. 验证连接断开和重连机制在真实环境中的表现
5. 收集并记录实机测试数据，为后续开发提供参考

## Tasks / Subtasks
- [x] 测试环境准备 (AC: 1, 2)
  - [x] 准备两台Android测试设备并配置开发者选项
  - [x] 验证adb工具连接和权限配置
  - [x] 部署测试应用到两台设备
  - [x] 配置设备蓝牙权限和设置

- [ ] 设备发现功能实机测试 (AC: 2)
  - [ ] 测试不同距离下的设备发现性能
  - [ ] 验证设备发现的成功率和准确率
  - [ ] 测试设备发现时间是否符合≤5秒的目标
  - [ ] 验证NearClip设备过滤功能在真实环境中的表现

- [ ] BLE连接建立实机测试 (AC: 1)
  - [ ] 测试两台设备间的连接建立过程
  - [ ] 验证连接建立时间是否符合≤3秒的目标
  - [ ] 测试连接稳定性和抗干扰能力
  - [ ] 验证连接状态管理的准确性

- [ ] 消息传输性能实机验证 (AC: 3)
  - [ ] 测试不同大小的消息传输延迟
  - [ ] 验证消息传输延迟是否符合≤1秒的目标
  - [ ] 测试消息传输的可靠性和丢包率
  - [ ] 验证Protocol Buffers消息在真实环境中的兼容性

- [ ] 连接断开和重连测试 (AC: 4)
  - [ ] 测试手动断开连接的场景
  - [ ] 模拟意外断开（如关闭蓝牙、超出范围）的场景
  - [ ] 验证自动重连机制的有效性
  - [ ] 测试重连后的状态恢复和消息同步

- [ ] 数据收集和分析 (AC: 5)
  - [ ] 记录各项性能指标的实测数据
  - [ ] 分析测试结果与性能目标的对比
  - [ ] 识别在真实环境中发现的问题和异常
  - [ ] 编写详细的实机测试报告

## Dev Notes

### 前置故事洞察
基于故事1.5的完成情况和QA修复成果（BLE通信验证已完成，QA评审PASS）：
- Protocol Buffers统一实现已完成，跨平台兼容性问题已解决
- 性能基准测试框架已建立，提供了明确的测试目标
- 代码质量优化完成，共享常量统一管理
- QA评审已通过，质量分数95/100

### 技术架构要点
**BLE技术栈** [Source: architecture/tech-stack.md#BLE通信协议]
- Android端使用Jetpack Compose + Kotlin 1.9.20
- 使用BLE 5.0+协议进行设备间通信
- Protocol Buffers 3.x用于跨平台数据序列化
- 统一的连接管理和状态监控系统

**测试架构** [Source: architecture/testing-strategy.md#测试组织]
- E2E测试组织结构：test/e2e/
- 使用JUnit + Espresso进行Android UI和集成测试
- 支持多设备并发测试场景
- 自定义测试工具支持BLE协议特定测试

### 设备配置要求
**测试设备规格**
- 设备1: Android API 21+，支持BLE 5.0
- 设备2: Android API 21+，支持BLE 5.0
- 两台设备均需开启开发者模式和USB调试
- 确保设备蓝牙功能正常且无其他连接干扰

**应用部署配置**
- 使用gradle构建并生成APK文件
- 通过adb install部署到测试设备
- 验证应用权限：BLUETOOTH_CONNECT, BLUETOOTH_SCAN, ACCESS_FINE_LOCATION

### 性能测试标准
**性能目标** [Source: story/1.5.ble-communication-verification.md#性能目标]
- 连接建立时间: ≤ 3秒
- 消息传输延迟: ≤ 1秒
- 设备发现时间: ≤ 5秒
- 连接稳定性: 10分钟内断开次数 ≤ 1次

**测试数据收集**
- 记录每次测试的环境条件（距离、干扰源等）
- 收集连接建立时间的统计分布数据
- 监控消息传输延迟的变化趋势
- 记录异常情况和错误日志

### 测试场景设计
**基础功能测试**
- 设备A扫描并发现设备B
- 建立BLE连接
- 发送Ping消息并验证Pong回复
- 发送数据消息并验证ACK回复

**性能压力测试**
- 在1-5米不同距离下测试连接稳定性
- 同时测试多设备连接场景
- 长时间通信稳定性测试（30分钟+）
- 高频消息发送测试（每秒10条消息）

**边界情况测试**
- 设备处于蓝牙信号边缘区域的连接表现
- 环境干扰下的通信质量测试
- 低电量模式下的BLE功能测试
- 应用切换到后台时的连接保持测试

### 测试数据管理
**日志收集**
- 使用adb logcat收集设备日志
- 关键时间点的事件记录
- 错误和异常情况的详细日志

**性能指标记录**
- 连接建立时间序列数据
- 消息传输延迟统计
- 设备发现成功率统计
- 连接断开次数和原因分析

### 文件位置规范
**测试代码位置** [Source: architecture/unified-project-structure.md#测试代码]
- Android测试：src/platform/android/app/src/test/java/com/nearclip/ble/
- 实机测试报告：docs/testing/reports/ble-real-device-{date}.md
- 性能数据：docs/testing/metrics/ble-performance-{date}.json

**测试工具和脚本**
- 自动化测试脚本：scripts/test/ble-device-pairing.sh
- 性能监控工具：tools/ble-performance-monitor.jar
- 数据分析脚本：scripts/analyze-test-results.py

### 安全和隐私考虑
**测试数据安全**
- 不在测试设备上存储敏感个人信息
- 使用测试专用的消息内容
- 测试完成后清理设备上的应用和数据

**权限管理**
- 验证应用在真实设备上的权限请求流程
- 测试权限被拒绝时的降级处理
- 确保测试过程不违反用户隐私政策

### 风险评估和缓解
**已知风险**
- 设备兼容性问题：使用不同Android版本的设备进行测试
- 环境干扰影响：在多种环境下进行重复测试
- 硬件性能限制：选择不同性能级别的设备测试

**风险缓解措施**
- 准备备用测试设备以应对硬件故障
- 在不同时间段和环境下进行测试以减少偶然因素
- 保留详细的测试日志以便问题复现和分析

## Testing

### 测试策略
**测试层次** [Source: architecture/testing-strategy.md#测试金字塔]
- 单元测试：已由故事1.5完成，覆盖率95%
- 集成测试：验证组件间协作
- E2E测试：真实设备端到端功能验证
- 性能测试：真实环境下的性能指标验证

### 测试环境
**硬件环境**
- 测试设备：2台Android设备（支持BLE 5.0+）
- 测试距离：1米、3米、5米、10米四个距离段
- 环境条件：室内、室外、有干扰、无干扰四种场景

**软件环境**
- Android版本：测试API 21-34的多个版本
- 应用版本：基于故事1.5完成的稳定版本
- 测试工具：adb、Android Studio、自定义性能监控工具

### 测试用例设计
**基础功能测试用例**
1. 设备发现功能验证
2. BLE连接建立测试
3. 消息发送接收测试
4. 连接断开和重连测试

**性能测试用例**
1. 连接建立时间性能测试
2. 消息传输延迟测试
3. 设备发现时间测试
4. 长时间连接稳定性测试

**边界条件测试用例**
1. 信号强度边界测试
2. 多设备连接压力测试
3. 异常情况恢复测试
4. 资源限制场景测试

### 测试数据收集
**性能指标**
- 连接建立时间（毫秒）
- 消息传输延迟（毫秒）
- 设备发现时间（秒）
- 连接稳定性指标（断开次数/小时）

**质量指标**
- 功能成功率（%）
- 错误率（%）
- 兼容性覆盖范围
- 用户体验评分

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | 创建实机测试故事，基于故事1.5完成情况设计真实设备验证方案 | Bob (SM) |

## QA Results
待QA代理填写