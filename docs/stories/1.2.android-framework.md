# Story 1.2: Android 基础应用框架搭建

## Status
Done

## Story
**作为** 开发者，
**我希望** 搭建 Android 应用的基础框架，包含 Jetpack Compose UI、FFI 集成层和基础权限配置，
**以便** 为后续功能开发提供坚实的应用架构基础，并能够与 Rust 共享逻辑库进行通信。

## Acceptance Criteria
1. 创建新的 Android 项目，使用 Kotlin + Jetpack Compose
2. 配置必要的权限：蓝牙访问、网络访问、粘贴板访问等
3. 建立基础的应用架构（MVVM + Repository 模式）
4. 创建基础的导航结构和主要页面占位符
5. 配置基础的依赖注入和状态管理
6. 创建 Rust FFI 集成层，为调用共享逻辑库做准备

## Tasks / Subtasks
- [x] 创建 Android 项目基础结构 (AC: 1)
  - [x] 设置 src/platform/android/app/ 目录结构
  - [x] 创建 build.gradle.kts 配置文件
  - [x] 配置 Gradle 项目设置
  - [x] 创建 AndroidManifest.xml 基础配置
- [x] 配置应用权限和安全性 (AC: 2)
  - [x] 添加蓝牙权限 (BLUETOOTH, BLUETOOTH_ADMIN)
  - [x] 添加网络权限 (INTERNET)
  - [x] 添加粘贴板权限
  - [x] 配置运行时权限请求逻辑
  - [x] 创建权限检查工具类
- [x] 建立应用架构 (AC: 3)
  - [x] 创建 MVVM 架构组件包结构
  - [x] 实现 Repository 模式
  - [x] 创建 ViewModel 基类
  - [x] 设置依赖注入框架
  - [x] 创建数据层和 UI 层分离
- [x] 创建导航和页面结构 (AC: 4)
  - [x] 使用 Jetpack Compose Navigation 设置导航图
  - [x] 创建主要页面 Compose 组件
  - [x] 设置底部导航栏或抽屉导航
  - [x] 创建页面路由管理
  - [x] 实现页面间数据传递
- [x] 配置状态管理和依赖注入 (AC: 5)
  - [x] 设置 Hilt 依赖注入
  - [x] 实现 ViewModel 状态管理
  - [x] 创建状态存储和恢复
  - [x] 配置协程作用域管理
- [x] 创建 Rust FFI 集成层 (AC: 6)
  - [x] 创建 NearClipNativeBridge 类
  - [x] 加载 Rust 共享库
  - [x] 创建 JNI 函数声明
  - [x] 实现 FFI 安全封装
  - [x] 创建设备发现和数据同步接口

## Dev Notes

### Android 项目结构
根据统一项目结构文档 [Source: architecture/unified-project-structure.md]，Android 应用位于：

```
src/platform/android/
├── app/
│   ├── src/
│   │   ├── main/
│   │   │   ├── java/com/nearclip/
│   │   │   │   ├── ui/            # UI 组件
│   │   │   │   ├── services/      # Rust FFI 调用层
│   │   │   │   ├── data/          # 数据层
│   │   │   │   │   ├── repository/
│   │   │   │   │   ├── database/
│   │   │   │   │   └── preferences/
│   │   │   │   ├── presentation/   # ViewModels 和 UI
│   │   │   │   │   ├── viewmodel/
│   │   │   │   │   └── theme/
│   │   │   │   └── MainActivity.kt
│   │   │   └── res/               # 资源文件
│   │   └── test/                  # 测试代码
│   ├── build.gradle.kts
│   └── proguard-rules.pro
├── build.gradle.kts
└── gradle.properties
```

### 技术栈信息
[Source: architecture/tech-stack.md]
- **Android 语言**: Kotlin 1.9.20
- **Android 框架**: Jetpack Compose 1.5.4
- **状态管理**: ViewModel + StateFlow
- **依赖注入**: Hilt 或 Koin
- **数据库**: Room 2.5.0
- **FFI 接口**: JNI (Kotlin ↔ Rust 通信)

### Rust FFI 集成架构
[Source: architecture/api-specification.md]

#### Kotlin JNI 接口
```kotlin
class RustNativeBridge {
    companion object {
        init {
            System.loadLibrary("nearclip_core")
        }

        @JvmStatic
        external fun initializeNearclip(): Int

        @JvmStatic
        external fun startDeviceDiscovery(callback: DeviceDiscoveryCallback): Int

        @JvmStatic
        external fun connectToDevice(deviceId: String): Int

        @JvmStatic
        external fun sendSyncMessage(deviceId: String, content: ByteArray): Int

        @JvmStatic
        external fun setSyncCallback(callback: SyncCallback)

        @JvmStatic
        external fun getLastError(): String
    }
}
```

#### FFI 安全封装
```kotlin
class NearClipManager private constructor(
    private val rustBridge: RustNativeBridge
) {
    fun startDeviceDiscoverySafe(callback: (Device) -> Unit): Result<Unit> {
        return try {
            val result = rustBridge.startDeviceDiscovery(object : DeviceDiscoveryCallback {
                override fun onDeviceFound(device: Device) {
                    callback(device)
                }
            })

            if (result == 0) {
                Result.success(Unit)
            } else {
                Result.failure(NearclipException("Failed to start discovery: $result"))
            }
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
}
```

### 关键组件设计
[Source: architecture/components.md]

#### MainActivity
```kotlin
@AndroidEntryPoint
class MainActivity : ComponentActivity() {
    private val viewModel: NearClipViewModel by viewModels()

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        // 初始化 Rust 库
        val initResult = NearClipManager.initialize()
        if (initResult.isFailure) {
            // 处理初始化失败
            Log.e("NearClip", "Failed to initialize Rust library", initResult.exceptionOrNull())
        }

        setContent {
            NearClipNavigation(navController = rememberNavController())
        }
    }
}
```

#### NearClipViewModel
```kotlin
@HiltViewModel
class NearClipViewModel @Inject constructor(
    private val nearClipManager: NearClipManager,
    private val deviceRepository: DeviceRepository
) : ViewModel() {

    private val _uiState = MutableStateFlow(NearClipUiState())
    val uiState: StateFlow<NearClipUiState> = _uiState.asStateFlow()

    fun startDeviceDiscovery() {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }

            nearClipManager.startDeviceDiscoverySafe { device ->
                // 更新设备列表
                val currentDevices = _uiState.value.discoveredDevices.toMutableList()
                currentDevices.add(device)
                _uiState.update {
                    it.copy(
                        discoveredDevices = currentDevices,
                        isLoading = false
                    )
                }
            }
        }
    }
}
```

### 数据层架构
[Source: architecture/data-models.md]

#### Repository 模式
```kotlin
interface DeviceRepository {
    suspend fun getAllDevices(): Flow<List<Device>>
    suspend fun getDeviceById(deviceId: String): Device?
    suspend fun insertDevice(device: Device)
    suspend fun updateDevice(device: Device)
    suspend fun deleteDevice(deviceId: String)
}

@Singleton
class DeviceRepositoryImpl @Inject constructor(
    private val deviceDao: DeviceDao,
    private val rustBridge: RustNativeBridge
) : DeviceRepository {

    override suspend fun getAllDevices(): Flow<List<Device>> {
        return deviceDao.getAllDevices()
    }

    override suspend fun getDeviceById(deviceId: String): Device? {
        return deviceDao.getDeviceById(deviceId)
    }
}
```

### Testing

#### 测试标准
[Source: architecture/testing-strategy.md]

**测试文件位置：**
```
src/platform/android/app/src/test/
├── ui/
│   ├── components/
│   │   ├── DeviceCardTest.kt
│   │   ├── StatusIndicatorTest.kt
│   │   └── NavigationTest.kt
│   └── screens/
│       ├── HomeScreenTest.kt
│       └── DeviceDiscoveryScreenTest.kt
├── viewmodel/
│   └── NearClipViewModelTest.kt
└── integration/
    ├── RustIntegrationTest.kt
    └── BleIntegrationTest.kt
```

**测试框架：**
- Android: JUnit 4.13.2 + Espresso
- Coroutines: kotlinx-coroutines-test
- Mock: MockK

#### 单元测试示例
```kotlin
@Test
fun `NearClipViewModel should update uiState when device discovered`() = runTest {
    // Given
    val mockNearClipManager = mockk<NearClipManager>()
    val mockDeviceRepository = mockk<DeviceRepository>()
    val viewModel = NearClipViewModel(mockNearClipManager, mockDeviceRepository)
    val testDevice = Device(
        deviceId = "test-device-1",
        deviceName = "Test Android",
        deviceType = DeviceType.ANDROID,
        publicKey = "test-key",
        lastSeen = System.currentTimeMillis(),
        connectionStatus = ConnectionStatus.DISCONNECTED
    )

    // When
    every { mockNearClipManager.startDeviceDiscoverySafe(any()) } returns Result.success(Unit)

    // Then
    viewModel.startDeviceDiscovery()

    // Verify callback was registered
    verify { mockNearClipManager.startDeviceDiscoverySuccess(any()) }
}
```

#### 集成测试示例
```kotlin
@Test
fun `Rust FFI integration should work correctly`() {
    // Test native library loading
    val result = NearClipManager.initialize()
    assertThat(result.isSuccess).isTrue()

    // Test FFI calls
    val mockCallback = mockk<DeviceDiscoveryCallback>()
    val discoveryResult = nearclipStartDeviceDiscovery(mockCallback)
    assertThat(discoveryResult).isEqualTo(0)
}
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-16 | 1.0 | 初始故事创建，添加 Rust FFI 集成要求 | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
glm-4.6

### Debug Log References
无调试日志，实现过程顺利

### Completion Notes List
1. **项目结构创建**: 成功创建了完整的Android项目目录结构，包含所有必要的包结构
2. **权限配置**: 完成了蓝牙、网络、剪贴板等权限的配置，并实现了运行时权限管理
3. **MVVM架构**: 实现了完整的MVVM架构模式，包含Repository、ViewModel、数据层和UI层分离
4. **导航系统**: 使用Jetpack Compose Navigation创建了完整的导航结构和主要页面
5. **依赖注入**: 配置了Hilt依赖注入框架，包含所有必要的模块和Application类
6. **Rust FFI集成**: 创建了完整的JNI桥接层，包含FFI接口、回调管理和后台服务

### File List
**核心配置文件:**
- `/src/platform/android/app/build.gradle.kts` - 应用构建配置
- `/src/platform/android/build.gradle.kts` - 项目构建配置
- `/src/platform/android/app/src/main/AndroidManifest.xml` - 应用清单
- `/src/platform/android/app/CMakeLists.txt` - 原生库构建配置

**应用入口:**
- `/src/platform/android/app/src/main/java/com/nearclip/NearClipApplication.kt` - 应用程序类
- `/src/platform/android/app/src/main/java/com/nearclip/MainActivity.kt` - 主活动

**UI层:**
- `/src/platform/android/app/src/main/java/com/nearclip/ui/navigation/NearClipNavigation.kt` - 导航组件
- `/src/platform/android/app/src/main/java/com/nearclip/ui/screens/HomeScreen.kt` - 首页
- `/src/platform/android/app/src/main/java/com/nearclip/ui/screens/DeviceListScreen.kt` - 设备列表页
- `/src/platform/android/app/src/main/java/com/nearclip/ui/screens/SettingsScreen.kt` - 设置页

**数据层:**
- `/src/platform/android/app/src/main/java/com/nearclip/data/model/Device.kt` - 设备数据模型
- `/src/platform/android/app/src/main/java/com/nearclip/data/database/NearClipDatabase.kt` - Room数据库
- `/src/platform/android/app/src/main/java/com/nearclip/data/database/dao/DeviceDao.kt` - 设备DAO
- `/src/platform/android/app/src/main/java/com/nearclip/data/repository/DeviceRepositoryImpl.kt` - 设备仓库实现

**业务逻辑层:**
- `/src/platform/android/app/src/main/java/com/nearclip/presentation/viewmodel/NearClipViewModel.kt` - 主视图模型
- `/src/platform/android/app/src/main/java/com/nearclip/presentation/viewmodel/BaseViewModel.kt` - 基础视图模型

**服务层:**
- `/src/platform/android/app/src/main/java/com/nearclip/services/PermissionManager.kt` - 权限管理器
- `/src/platform/android/app/src/main/java/com/nearclip/services/ClipboardSyncService.kt` - 剪贴板同步服务
- `/src/platform/android/app/src/main/java/com/nearclip/services/BleService.kt` - 蓝牙服务

**依赖注入:**
- `/src/platform/android/app/src/main/java/com/nearclip/di/DatabaseModule.kt` - 数据库模块
- `/src/platform/android/app/src/main/java/com/nearclip/di/RepositoryModule.kt` - 仓库模块
- `/src/platform/android/app/src/main/java/com/nearclip/di/NetworkModule.kt` - 网络模块

**Rust FFI集成层:**
- `/src/platform/android/app/src/main/java/com/nearclip/ffi/NearClipFFI.kt` - FFI桥接类
- `/src/platform/android/app/src/main/java/com/nearclip/ffi/NearClipNativeBridge.kt` - 原生桥接服务
- `/src/platform/android/app/src/main/java/com/nearclip/ffi/JniCallbacks.kt` - JNI回调接口
- `/src/platform/android/app/src/main/java/com/nearclip/ffi/JniLoader.kt` - JNI库加载器
- `/src/platform/android/app/src/main/java/com/nearclip/ffi/NearClipService.kt` - 后台服务

**原生代码:**
- `/src/platform/android/app/src/main/cpp/nearclip_jni.cpp` - JNI主实现
- `/src/platform/android/app/src/main/cpp/jni_callbacks.cpp` - JNI回调实现
- `/src/platform/android/app/src/main/cpp/jni_bridge.h` - JNI桥接头文件

## QA Results
待 QA 代理填写