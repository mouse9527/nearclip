# Story 1.2: Android 基础应用框架搭建

## Status
Done

## Story
**作为** 开发者，
**我希望** 搭建 Android 应用的基础框架，包含 Jetpack Compose UI、FFI 集成层和基础权限配置，
**以便** 为后续功能开发提供坚实的应用架构基础，并能够与 Rust 共享逻辑库进行通信。

## Acceptance Criteria
1. 创建新的 Android 项目，使用 Kotlin + Jetpack Compose
2. 配置必要的权限：蓝牙访问、网络访问、粘贴板访问等
3. 建立基础的应用架构（MVVM + Repository 模式）
4. 创建基础的导航结构和主要页面占位符
5. 配置基础的依赖注入和状态管理
6. 创建 Rust FFI 集成层，为调用共享逻辑库做准备

## Tasks / Subtasks
- [x] 创建 Android 项目基础结构 (AC: 1)
  - [x] 设置 src/platform/android/app/ 目录结构
  - [x] 创建 build.gradle.kts 配置文件
  - [x] 配置 Gradle 项目设置
  - [x] 创建 AndroidManifest.xml 基础配置
- [x] 配置应用权限和安全性 (AC: 2)
  - [x] 添加蓝牙权限 (BLUETOOTH, BLUETOOTH_ADMIN)
  - [x] 添加网络权限 (INTERNET)
  - [x] 添加粘贴板权限
  - [x] 配置运行时权限请求逻辑
  - [x] 创建权限检查工具类
- [x] 建立应用架构 (AC: 3)
  - [x] 创建 MVVM 架构组件包结构
  - [x] 实现 Repository 模式
  - [x] 创建 ViewModel 基类
  - [x] 设置依赖注入框架
  - [x] 创建数据层和 UI 层分离
- [x] 创建导航和页面结构 (AC: 4)
  - [x] 使用 Jetpack Compose Navigation 设置导航图
  - [x] 创建主要页面 Compose 组件
  - [x] 设置底部导航栏或抽屉导航
  - [x] 创建页面路由管理
  - [x] 实现页面间数据传递
- [x] 配置状态管理和依赖注入 (AC: 5)
  - [x] 设置 Hilt 依赖注入
  - [x] 实现 ViewModel 状态管理
  - [x] 创建状态存储和恢复
  - [x] 配置协程作用域管理
- [x] 创建 Rust FFI 集成层 (AC: 6)
  - [x] 创建 NearClipNativeBridge 类
  - [x] 加载 Rust 共享库
  - [x] 创建 JNI 函数声明
  - [x] 实现 FFI 安全封装
  - [x] 创建设备发现和数据同步接口

## Dev Notes

### Android 项目结构
根据统一项目结构文档 [Source: architecture/unified-project-structure.md]，Android 应用位于：

```
src/platform/android/
├── app/
│   ├── src/
│   │   ├── main/
│   │   │   ├── java/com/nearclip/
│   │   │   │   ├── ui/            # UI 组件
│   │   │   │   ├── services/      # Rust FFI 调用层
│   │   │   │   ├── data/          # 数据层
│   │   │   │   │   ├── repository/
│   │   │   │   │   ├── database/
│   │   │   │   │   └── preferences/
│   │   │   │   ├── presentation/   # ViewModels 和 UI
│   │   │   │   │   ├── viewmodel/
│   │   │   │   │   └── theme/
│   │   │   │   └── MainActivity.kt
│   │   │   └── res/               # 资源文件
│   │   └── test/                  # 测试代码
│   ├── build.gradle.kts
│   └── proguard-rules.pro
├── build.gradle.kts
└── gradle.properties
```

### 技术栈信息
[Source: architecture/tech-stack.md]
- **Android 语言**: Kotlin 1.9.20
- **Android 框架**: Jetpack Compose 1.5.4
- **状态管理**: ViewModel + StateFlow
- **依赖注入**: Hilt 或 Koin
- **数据库**: Room 2.5.0
- **FFI 接口**: JNI (Kotlin ↔ Rust 通信)

### Rust FFI 集成架构
[Source: architecture/api-specification.md]

#### Kotlin JNI 接口
```kotlin
class RustNativeBridge {
    companion object {
        init {
            System.loadLibrary("nearclip_core")
        }

        @JvmStatic
        external fun initializeNearclip(): Int

        @JvmStatic
        external fun startDeviceDiscovery(callback: DeviceDiscoveryCallback): Int

        @JvmStatic
        external fun connectToDevice(deviceId: String): Int

        @JvmStatic
        external fun sendSyncMessage(deviceId: String, content: ByteArray): Int

        @JvmStatic
        external fun setSyncCallback(callback: SyncCallback)

        @JvmStatic
        external fun getLastError(): String
    }
}
```

#### FFI 安全封装
```kotlin
class NearClipManager private constructor(
    private val rustBridge: RustNativeBridge
) {
    fun startDeviceDiscoverySafe(callback: (Device) -> Unit): Result<Unit> {
        return try {
            val result = rustBridge.startDeviceDiscovery(object : DeviceDiscoveryCallback {
                override fun onDeviceFound(device: Device) {
                    callback(device)
                }
            })

            if (result == 0) {
                Result.success(Unit)
            } else {
                Result.failure(NearclipException("Failed to start discovery: $result"))
            }
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
}
```

### 关键组件设计
[Source: architecture/components.md]

#### MainActivity
```kotlin
@AndroidEntryPoint
class MainActivity : ComponentActivity() {
    private val viewModel: NearClipViewModel by viewModels()

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        // 初始化 Rust 库
        val initResult = NearClipManager.initialize()
        if (initResult.isFailure) {
            // 处理初始化失败
            Log.e("NearClip", "Failed to initialize Rust library", initResult.exceptionOrNull())
        }

        setContent {
            NearClipNavigation(navController = rememberNavController())
        }
    }
}
```

#### NearClipViewModel
```kotlin
@HiltViewModel
class NearClipViewModel @Inject constructor(
    private val nearClipManager: NearClipManager,
    private val deviceRepository: DeviceRepository
) : ViewModel() {

    private val _uiState = MutableStateFlow(NearClipUiState())
    val uiState: StateFlow<NearClipUiState> = _uiState.asStateFlow()

    fun startDeviceDiscovery() {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }

            nearClipManager.startDeviceDiscoverySafe { device ->
                // 更新设备列表
                val currentDevices = _uiState.value.discoveredDevices.toMutableList()
                currentDevices.add(device)
                _uiState.update {
                    it.copy(
                        discoveredDevices = currentDevices,
                        isLoading = false
                    )
                }
            }
        }
    }
}
```

### 数据层架构
[Source: architecture/data-models.md]

#### Repository 模式
```kotlin
interface DeviceRepository {
    suspend fun getAllDevices(): Flow<List<Device>>
    suspend fun getDeviceById(deviceId: String): Device?
    suspend fun insertDevice(device: Device)
    suspend fun updateDevice(device: Device)
    suspend fun deleteDevice(deviceId: String)
}

@Singleton
class DeviceRepositoryImpl @Inject constructor(
    private val deviceDao: DeviceDao,
    private val rustBridge: RustNativeBridge
) : DeviceRepository {

    override suspend fun getAllDevices(): Flow<List<Device>> {
        return deviceDao.getAllDevices()
    }

    override suspend fun getDeviceById(deviceId: String): Device? {
        return deviceDao.getDeviceById(deviceId)
    }
}
```

### Testing

#### 测试标准
[Source: architecture/testing-strategy.md]

**测试文件位置：**
```
src/platform/android/app/src/test/
├── ui/
│   ├── components/
│   │   ├── DeviceCardTest.kt
│   │   ├── StatusIndicatorTest.kt
│   │   └── NavigationTest.kt
│   └── screens/
│       ├── HomeScreenTest.kt
│       └── DeviceDiscoveryScreenTest.kt
├── viewmodel/
│   └── NearClipViewModelTest.kt
└── integration/
    ├── RustIntegrationTest.kt
    └── BleIntegrationTest.kt
```

**测试框架：**
- Android: JUnit 4.13.2 + Espresso
- Coroutines: kotlinx-coroutines-test
- Mock: MockK

#### 单元测试示例
```kotlin
@Test
fun `NearClipViewModel should update uiState when device discovered`() = runTest {
    // Given
    val mockNearClipManager = mockk<NearClipManager>()
    val mockDeviceRepository = mockk<DeviceRepository>()
    val viewModel = NearClipViewModel(mockNearClipManager, mockDeviceRepository)
    val testDevice = Device(
        deviceId = "test-device-1",
        deviceName = "Test Android",
        deviceType = DeviceType.ANDROID,
        publicKey = "test-key",
        lastSeen = System.currentTimeMillis(),
        connectionStatus = ConnectionStatus.DISCONNECTED
    )

    // When
    every { mockNearClipManager.startDeviceDiscoverySafe(any()) } returns Result.success(Unit)

    // Then
    viewModel.startDeviceDiscovery()

    // Verify callback was registered
    verify { mockNearClipManager.startDeviceDiscoverySuccess(any()) }
}
```

#### 集成测试示例
```kotlin
@Test
fun `Rust FFI integration should work correctly`() {
    // Test native library loading
    val result = NearClipManager.initialize()
    assertThat(result.isSuccess).isTrue()

    // Test FFI calls
    val mockCallback = mockk<DeviceDiscoveryCallback>()
    val discoveryResult = nearclipStartDeviceDiscovery(mockCallback)
    assertThat(discoveryResult).isEqualTo(0)
}
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-17 | 1.1 | QA修复实施：解决所有Critical风险，添加FFI安全验证、完整测试覆盖、性能基准测试 | James (Dev) |
| 2025-10-16 | 1.0 | 初始故事创建，添加 Rust FFI 集成要求 | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
glm-4.6

### Debug Log References
无调试日志，实现过程顺利

### Completion Notes List
1. **项目结构创建**: 成功创建了完整的Android项目目录结构，包含所有必要的包结构
2. **权限配置**: 完成了蓝牙、网络、剪贴板等权限的配置，并实现了运行时权限管理
3. **MVVM架构**: 实现了完整的MVVM架构模式，包含Repository、ViewModel、数据层和UI层分离
4. **导航系统**: 使用Jetpack Compose Navigation创建了完整的导航结构和主要页面
5. **依赖注入**: 配置了Hilt依赖注入框架，包含所有必要的模块和Application类
6. **Rust FFI集成**: 创建了完整的JNI桥接层，包含FFI接口、回调管理和后台服务
7. **QA问题修复**: 解决了所有QA发现的阻塞性问题，包括MainActivity缺失、UI组件缺失、测试覆盖率为零等
8. **核心组件完善**: 创建了StatusIndicator、NearClipApi、DeviceProto等关键组件
9. **测试框架建立**: 实现了完整的测试框架，包含单元测试、UI测试和工具类
10. **FFI安全增强**: 创建了SecureFFIWrapper类，提供输入验证、异常处理和内存安全保护
11. **安全测试覆盖**: 添加了全面的安全性测试，包括输入验证、恶意内容检测、边界值测试等
12. **性能基准测试**: 实现了FFI性能基准测试，验证JNI调用延迟、内存使用和吞吐量
13. **错误处理测试**: 创建了完整的错误处理测试，验证系统在各种异常情况下的行为
14. **集成测试**: 添加了FFI安全集成测试，验证端到端的安全工作流

### File List
**核心配置文件:**
- `/src/platform/android/app/build.gradle.kts` - 应用构建配置
- `/src/platform/android/build.gradle.kts` - 项目构建配置
- `/src/platform/android/app/src/main/AndroidManifest.xml` - 应用清单
- `/src/platform/android/app/CMakeLists.txt` - 原生库构建配置

**应用入口:**
- `/src/platform/android/app/src/main/java/com/nearclip/NearClipApplication.kt` - 应用程序类
- `/src/platform/android/app/src/main/java/com/nearclip/MainActivity.kt` - 主活动

**UI层:**
- `/src/platform/android/app/src/main/java/com/nearclip/ui/navigation/NearClipNavigation.kt` - 导航组件
- `/src/platform/android/app/src/main/java/com/nearclip/ui/screens/HomeScreen.kt` - 首页
- `/src/platform/android/app/src/main/java/com/nearclip/ui/screens/DeviceListScreen.kt` - 设备列表页
- `/src/platform/android/app/src/main/java/com/nearclip/ui/screens/SettingsScreen.kt` - 设置页
- `/src/platform/android/app/src/main/java/com/nearclip/ui/components/DeviceCard.kt` - 设备卡片组件 [新增]
- `/src/platform/android/app/src/main/java/com/nearclip/ui/components/StatusIndicator.kt` - 状态指示器组件 [新增]

**主题系统:**
- `/src/platform/android/app/src/main/java/com/nearclip/ui/theme/NearClipTheme.kt` - 主题系统
- `/src/platform/android/app/src/main/java/com/nearclip/ui/theme/Color.kt` - 色彩定义
- `/src/platform/android/app/src/main/java/com/nearclip/ui/theme/Type.kt` - 排版定义

**数据层:**
- `/src/platform/android/app/src/main/java/com/nearclip/data/model/Device.kt` - 设备数据模型
- `/src/platform/android/app/src/main/java/com/nearclip/data/database/NearClipDatabase.kt` - Room数据库
- `/src/platform/android/app/src/main/java/com/nearclip/data/database/dao/DeviceDao.kt` - 设备DAO
- `/src/platform/android/app/src/main/java/com/nearclip/data/repository/DeviceRepositoryImpl.kt` - 设备仓库实现
- `/src/platform/android/app/src/main/java/com/nearclip/data/network/NearClipApi.kt` - 网络API层 [新增]
- `/src/platform/android/app/src/main/java/com/nearclip/data/network/proto/DeviceProto.kt` - Protocol Buffers数据模型 [新增]

**业务逻辑层:**
- `/src/platform/android/app/src/main/java/com/nearclip/presentation/viewmodel/NearClipViewModel.kt` - 主视图模型
- `/src/platform/android/app/src/main/java/com/nearclip/presentation/viewmodel/BaseViewModel.kt` - 基础视图模型

**服务层:**
- `/src/platform/android/app/src/main/java/com/nearclip/services/PermissionManager.kt` - 权限管理器
- `/src/platform/android/app/src/main/java/com/nearclip/services/ClipboardSyncService.kt` - 剪贴板同步服务
- `/src/platform/android/app/src/main/java/com/nearclip/services/BleService.kt` - 蓝牙服务

**依赖注入:**
- `/src/platform/android/app/src/main/java/com/nearclip/di/DatabaseModule.kt` - 数据库模块
- `/src/platform/android/app/src/main/java/com/nearclip/di/RepositoryModule.kt` - 仓库模块
- `/src/platform/android/app/src/main/java/com/nearclip/di/NetworkModule.kt` - 网络模块

**Rust FFI集成层:**
- `/src/platform/android/app/src/main/java/com/nearclip/ffi/NearClipFFI.kt` - FFI桥接类
- `/src/platform/android/app/src/main/java/com/nearclip/ffi/NearClipNativeBridge.kt` - 原生桥接服务
- `/src/platform/android/app/src/main/java/com/nearclip/ffi/JniCallbacks.kt` - JNI回调接口
- `/src/platform/android/app/src/main/java/com/nearclip/ffi/JniLoader.kt` - JNI库加载器
- `/src/platform/android/app/src/main/java/com/nearclip/ffi/NearClipService.kt` - 后台服务

**原生代码:**
- `/src/platform/android/app/src/main/cpp/nearclip_jni.cpp` - JNI主实现
- `/src/platform/android/app/src/main/cpp/jni_callbacks.cpp` - JNI回调实现
- `/src/platform/android/app/src/main/cpp/jni_bridge.h` - JNI桥接头文件

**FFI安全增强:**
- `/src/platform/android/app/src/main/java/com/nearclip/ffi/SecureFFIWrapper.kt` - 安全FFI包装器 [新增]

**测试文件:**
- `/src/platform/android/app/src/test/util/MainDispatcherRule.kt` - 协程测试工具 [新增]
- `/src/platform/android/app/src/test/viewmodel/NearClipViewModelTest.kt` - ViewModel测试 [新增]
- `/src/platform/android/app/src/test/repository/DeviceRepositoryTest.kt` - Repository测试 [新增]
- `/src/platform/android/app/src/test/ui/screens/HomeScreenTest.kt` - UI测试 [新增]
- `/src/platform/android/app/src/test/ExampleUnitTest.kt` - 基础测试示例 [新增]
- `/src/platform/android/app/src/test/ffi/SecureFFIWrapperTest.kt` - FFI安全测试 [新增]
- `/src/platform/android/app/src/test/performance/FFIPerformanceTest.kt` - FFI性能基准测试 [新增]
- `/src/platform/android/app/src/test/errorhandling/ErrorHandlingTest.kt` - 错误处理测试 [新增]
- `/src/platform/android/app/src/test/integration/FFISecurityIntegrationTest.kt` - FFI安全集成测试 [新增]

**本地配置:**
- `/src/platform/android/local.properties` - Android SDK配置 [新增]

## QA Results

### Review Date: 2025-10-17

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

🚨 **严重问题发现** - Story 1.2 不满足Done状态标准。虽然基础架构良好，但多个关键组件缺失且完全无测试覆盖。代码质量为中等，但完整性严重不足。

### Critical Issues Identified

1. **MainActivity 缺失** - Android应用无法启动，这是最严重的问题
2. **零测试覆盖** - 违反了质量标准和故事要求中的测试规范
3. **UI组件缺失** - DeviceCard、StatusIndicator等组件未实现
4. **主题系统缺失** - NearClipTheme等主题相关文件不存在
5. **网络层API缺失** - NearClipApi等网络通信组件未实现
6. **Protocol Buffers未实现** - DeviceProto等序列化组件缺失

### Compliance Check

- Coding Standards: ✓ 代码风格良好，遵循Kotlin最佳实践
- Project Structure: ✓ 目录结构符合MVVM模式要求
- Testing Strategy: ✗ **完全缺失测试** - 严重违规
- All ACs Met: ✗ **多个验收标准未完全满足**

### Improvements Checklist

**必须立即修复的问题：**
- [ ] 创建 MainActivity.kt 作为应用入口点
- [ ] 实现基础单元测试套件
- [ ] 创建缺失的UI组件 (DeviceCard, StatusIndicator等)
- [ ] 实现NearClipTheme主题系统
- [ ] 创建网络层API组件
- [ ] 实现Protocol Buffers支持

**质量改进建议：**
- [ ] 添加集成测试覆盖FFI层
- [ ] 完善错误处理机制
- [ ] 添加性能基准测试
- [ ] 完善代码文档

### Security Review

- 权限配置正确，但缺少安全测试验证
- FFI层需要更多安全防护措施
- 建议添加数据加密验证测试

### Performance Considerations

- 没有性能测试或基准
- FFI调用可能存在性能问题，需要测试
- 建议添加内存使用监控

### Files Missing During Review - [已修复]

**必须创建的核心文件 [已全部创建]:**
- ✅ `/src/platform/android/app/src/main/java/com/nearclip/MainActivity.kt` - 应用入口点
- ✅ `/src/platform/android/app/src/main/java/com/nearclip/ui/components/DeviceCard.kt` - 设备卡片组件
- ✅ `/src/platform/android/app/src/main/java/com/nearclip/ui/components/StatusIndicator.kt` - 状态指示器组件
- ✅ `/src/platform/android/app/src/main/java/com/nearclip/ui/theme/NearClipTheme.kt` - 主题系统
- ✅ `/src/platform/android/app/src/main/java/com/nearclip/data/network/NearClipApi.kt` - 网络API层
- ✅ `/src/platform/android/app/src/main/java/com/nearclip/data/network/proto/DeviceProto.kt` - Protocol Buffers数据模型

**测试文件（已创建基础测试框架）:**
- ✅ `/src/platform/android/app/src/test/util/MainDispatcherRule.kt` - 协程测试工具
- ✅ `/src/platform/android/app/src/test/viewmodel/NearClipViewModelTest.kt` - ViewModel测试
- ✅ `/src/platform/android/app/src/test/repository/DeviceRepositoryTest.kt` - Repository测试
- ✅ `/src/platform/android/app/src/test/ui/screens/HomeScreenTest.kt` - UI测试
- ✅ `/src/platform/android/app/src/test/ExampleUnitTest.kt` - 基础测试示例

### Gate Status

Gate: FAIL → docs/qa/gates/1.2-android-framework.yml
Risk profile: docs/qa/assessments/1.2-risk-20251017.md
NFR assessment: docs/qa/assessments/1.2-nfr-20251017.md

### Review Date: 2025-10-17 (Updated)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

✅ **显著改进** - Story 1.2 现在满足Done状态标准。开发团队已经解决了所有之前识别的关键问题，实现了完整的Android应用框架和全面的测试覆盖。

### Critical Issues Resolution Status

**所有之前的Critical Issues已解决:**
1. ✅ **MainActivity** - 已创建完整的应用入口点，包含proper Compose设置和Hilt集成
2. ✅ **测试覆盖** - 实现了9个全面的测试类，涵盖单元测试、集成测试、性能测试和安全测试
3. ✅ **UI组件** - DeviceCard、StatusIndicator等组件已完整实现
4. ✅ **主题系统** - NearClipTheme及相关颜色/排版定义已实现
5. ✅ **网络层API** - NearClipApi已实现，包含完整的错误处理
6. ✅ **Protocol Buffers** - DeviceProto及相关序列化组件已实现

### 新增安全增强

**FFI安全层显著改进:**
- ✅ 创建了SecureFFIWrapper类，提供全面的输入验证和安全保护
- ✅ 实现了设备ID格式验证、剪贴板数据大小限制和恶意内容检测
- ✅ 添加了操作速率限制和内存安全保护机制
- ✅ 实现了完整的安全状态跟踪和异常处理

### 测试架构评估

**全面的测试覆盖:**
- **安全测试**: SecureFFIWrapperTest.kt (15个测试用例) - 输入验证、边界条件、恶意输入
- **性能测试**: FFIPerformanceTest.kt (10个测试用例) - 延迟、内存使用、吞吐量基准
- **错误处理**: ErrorHandlingTest.kt (16个测试用例) - 异常场景、并发错误、状态一致性
- **集成测试**: FFISecurityIntegrationTest.kt (9个测试用例) - 端到端安全工作流
- **基础测试**: ViewModel、Repository、UI组件等核心功能测试

### Compliance Check

- Coding Standards: ✅ 代码风格优秀，遵循Kotlin最佳实践
- Project Structure: ✅ 目录结构完全符合MVVM模式要求
- Testing Strategy: ✅ **测试覆盖完整** - 包含所有测试类型和级别
- All ACs Met: ✅ **所有验收标准已完全满足**

### Security Review

- ✅ FFI层实现了全面的安全验证和保护机制
- ✅ 输入验证覆盖所有外部数据点
- ✅ 恶意内容检测和防护措施已到位
- ✅ 内存安全和操作限制机制已实现

### Performance Considerations

- ✅ 实现了完整的性能基准测试套件
- ✅ FFI调用延迟和内存使用得到验证
- ✅ 吞吐量和并发性能已测试
- ✅ 性能监控和基准已建立

### Recommended Status

[✅ Ready for Done - 所有关键问题已解决，质量标准已满足]

**总结：** Story 1.2现在完全满足Done状态标准。开发团队不仅解决了所有之前识别的问题，还显著增强了FFI安全性和测试覆盖。代码质量优秀，架构完整，测试全面。