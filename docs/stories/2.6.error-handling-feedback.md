# Story 2.6: 错误处理与用户反馈

## Status
Draft

## Story
**作为** 用户，
**我希望** 在配对或连接过程中出现问题时，能够得到清晰的错误提示和解决建议，
**以便** 快速解决问题并正常使用应用功能。

## Acceptance Criteria
1. 实现常见错误场景的识别和分类
2. 提供用户友好的错误消息和解决建议
3. 实现错误重试机制和自动恢复功能
4. 记录关键错误日志用于问题诊断
5. 提供帮助文档和故障排除指南

## Tasks / Subtasks
- [ ] 设计错误分类和处理系统 (AC: 1)
  - [ ] 创建错误代码和消息定义
  - [ ] 实现错误严重性分级
  - [ ] 设计错误恢复策略
  - [ ] 创建错误上下文收集
  - [ ] 实现错误追踪和关联
- [ ] 实现用户友好的错误消息 (AC: 2)
  - [ ] 创建本地化错误消息
  - [ ] 实现错误消息模板系统
  - [ ] 添加错误图标和视觉指示
  - [ ] 创建错误详情展开功能
  - [ ] 实现错误消息的上下文相关性
- [ ] 实现错误重试和恢复机制 (AC: 3)
  - [ ] 创建自动重试逻辑
  - [ ] 实现指数退避算法
  - [ ] 添加重试限制和超时
  - [ ] 创建重试状态指示
  - [ ] 实现用户手动重试选项
- [ ] 实现错误日志记录系统 (AC: 4)
  - [ ] 创建结构化日志格式
  - [ ] 实现错误上下文收集
  - [ ] 添加日志级别控制
  - [ ] 创建日志文件轮转机制
  - [ ] 实现错误报告聚合
- [ ] 实现帮助文档和故障排除 (AC: 5)
  - [ ] 创建在线帮助系统
  - [ ] 实现故障排除向导
  - [ ] 添加常见问题解答
  - [ ] 创建错误解决建议库
  - [ ] 实现用户反馈收集
- [ ] 实现错误通知和反馈界面
  - [ ] 创建错误通知弹窗
  - [ ] 实现错误状态栏指示
  - [ ] 添加错误详情页面
  - [ ] 创建错误恢复进度显示
  - [ ] 实现错误静默模式

## Dev Notes

### 错误处理系统设计
[Source: architecture/coding-standards.md]

#### 错误分类和代码定义
```protobuf
// src/shared/protocol/error_handling.proto
syntax = "proto3";

package nearclip.error;

// 错误严重性级别
enum ErrorSeverity {
  SEVERITY_UNKNOWN = 0;
  SEVERITY_INFO = 1;      // 信息性消息
  SEVERITY_WARNING = 2;   // 警告
  SEVERITY_ERROR = 3;     // 错误（可恢复）
  SEVERITY_CRITICAL = 4;  // 严重错误（影响核心功能）
  SEVERITY_FATAL = 5;     // 致命错误（应用崩溃）
}

// 错误类别
enum ErrorCategory {
  CATEGORY_UNKNOWN = 0;
  CATEGORY_NETWORK = 1;           // 网络相关错误
  CATEGORY_BLUETOOTH = 2;         // 蓝牙相关错误
  CATEGORY_PERMISSION = 3;        // 权限相关错误
  CATEGORY_AUTHENTICATION = 4;    // 认证相关错误
  CATEGORY_SYNCHRONIZATION = 5;   // 同步相关错误
  CATEGORY_DEVICE = 6;            // 设备相关错误
  CATEGORY_STORAGE = 7;           // 存储相关错误
  CATEGORY_CRYPTOGRAPHY = 8;      // 加密相关错误
  CATEGORY_SYSTEM = 9;            // 系统相关错误
  CATEGORY_USER_INPUT = 10;       // 用户输入错误
}

// 标准错误代码
enum ErrorCode {
  ERROR_UNKNOWN = 0;

  // 网络错误 (1000-1099)
  ERROR_NETWORK_UNAVAILABLE = 1000;
  ERROR_NETWORK_TIMEOUT = 1001;
  ERROR_CONNECTION_LOST = 1002;
  ERROR_SERVER_UNREACHABLE = 1003;

  // 蓝牙错误 (1100-1199)
  ERROR_BLUETOOTH_UNAVAILABLE = 1100;
  ERROR_BLUETOOTH_PERMISSION_DENIED = 1101;
  ERROR_BLUETOOTH_ADAPTER_OFF = 1102;
  ERROR_DEVICE_NOT_FOUND = 1103;
  ERROR_PAIRING_FAILED = 1104;
  ERROR_CONNECTION_FAILED = 1105;

  // 权限错误 (1200-1299)
  ERROR_PERMISSION_DENIED = 1200;
  ERROR_PERMISSION_CLIPBOARD = 1201;
  ERROR_PERMISSION_BLUETOOTH = 1202;
  ERROR_PERMISSION_LOCATION = 1203;
  ERROR_PERMISSION_BACKGROUND = 1204;

  // 认证错误 (1300-1399)
  ERROR_AUTHENTICATION_FAILED = 1300;
  ERROR_CERTIFICATE_INVALID = 1301;
  ERROR_SIGNATURE_VERIFICATION_FAILED = 1302;
  ERROR_TOKEN_EXPIRED = 1303;
  ERROR_CREDENTIALS_INVALID = 1304;

  // 同步错误 (1400-1499)
  ERROR_SYNC_FAILED = 1400;
  ERROR_SYNC_TIMEOUT = 1401;
  ERROR_DATA_CORRUPTION = 1402;
  ERROR_CONFLICT_DETECTED = 1403;
  ERROR_QUOTA_EXCEEDED = 1404;

  // 设备错误 (1500-1599)
  ERROR_DEVICE_OFFLINE = 1500;
  ERROR_DEVICE_BUSY = 1501;
  ERROR_DEVICE_UNSUPPORTED = 1502;
  ERROR_DEVICE_VERSION_MISMATCH = 1503;

  // 存储错误 (1600-1699)
  ERROR_STORAGE_FULL = 1600;
  ERROR_STORAGE_CORRUPTION = 1601;
  ERROR_DATABASE_ERROR = 1602;
  ERROR_FILE_NOT_FOUND = 1603;

  // 加密错误 (1700-1799)
  ERROR_ENCRYPTION_FAILED = 1700;
  ERROR_DECRYPTION_FAILED = 1701;
  ERROR_KEY_GENERATION_FAILED = 1702;
  ERROR_KEY_NOT_FOUND = 1703;

  // 系统错误 (1800-1899)
  ERROR_SYSTEM_RESOURCE_EXHAUSTED = 1800;
  ERROR_MEMORY_INSUFFICIENT = 1801;
  ERROR_PROCESSING_FAILED = 1802;
  ERROR_INTERNAL_ERROR = 1803;
}

// 错误信息
protocol ErrorInfo {
  ErrorCode error_code = 1;
  string error_id = 2;              // 唯一错误标识符
  ErrorCategory category = 3;
  ErrorSeverity severity = 4;
  string message = 5;                // 错误消息
  string detailed_message = 6;       // 详细错误信息
  string user_friendly_message = 7;  // 用户友好消息
  string resolution_hint = 8;       // 解决建议
  repeated string possible_causes = 9; // 可能原因
  repeated string resolution_steps = 10; // 解决步骤
  map<string, string> context = 11;  // 错误上下文
  int64 timestamp = 12;             // 错误时间戳
  string stack_trace = 13;          // 堆栈跟踪（调试模式）
  bool is_recoverable = 14;         // 是否可恢复
  bool should_retry = 15;           // 是否建议重试
  int32 max_retries = 16;           // 最大重试次数
  int64 retry_delay_ms = 17;        // 重试延迟
  string help_url = 18;            // 帮助文档URL
}

// 错误报告
protocol ErrorReport {
  string report_id = 1;
  repeated ErrorInfo errors = 2;
  string device_info = 3;           // 设备信息
  string app_version = 4;           // 应用版本
  string os_version = 5;            // 操作系统版本
  int64 timestamp = 6;             // 报告时间
  string user_session_id = 7;      // 用户会话ID
  map<string, string> environment = 8; // 环境信息
}

// 重试策略
protocol RetryPolicy {
  RetryStrategy strategy = 1;
  int32 max_attempts = 2;
  int64 base_delay_ms = 3;
  int64 max_delay_ms = 4;
  float backoff_multiplier = 5;
  bool jitter_enabled = 6;
  repeated ErrorCode retryable_errors = 7;
}

enum RetryStrategy {
  STRATEGY_UNKNOWN = 0;
  STRATEGY_FIXED_DELAY = 1;          // 固定延迟
  STRATEGY_EXPONENTIAL_BACKOFF = 2;  // 指数退避
  STRATEGY_LINEAR_BACKOFF = 3;       // 线性退避
  STRATEGY_ADAPTIVE = 4;             // 自适应
}
```

#### Rust 错误处理管理器
```rust
// src/shared/rust/src/error/manager.rs
use chrono::{DateTime, Utc, Duration};
use std::collections::HashMap;
use std::sync::Arc;
use tokio::sync::RwLock;
use serde::{Deserialize, Serialize};
use thiserror::Error;
use log::{error, warn, info, debug};
use uuid::Uuid;

#[derive(Error, Debug)]
pub enum NearclipError {
    #[error("Network error: {message}")]
    Network { message: String, code: ErrorCode },

    #[error("Bluetooth error: {message}")]
    Bluetooth { message: String, code: ErrorCode },

    #[error("Permission denied: {permission}")]
    Permission { permission: String },

    #[error("Authentication failed: {reason}")]
    Authentication { reason: String },

    #[error("Device error: {device_id} - {message}")]
    Device { device_id: String, message: String },

    #[error("Synchronization error: {message}")]
    Synchronization { message: String },

    #[error("Storage error: {message}")]
    Storage { message: String },

    #[error("Cryptography error: {message}")]
    Cryptography { message: String },

    #[error("System error: {message}")]
    System { message: String },

    #[error("Internal error: {message}")]
    Internal { message: String },

    #[error("Unknown error: {message}")]
    Unknown { message: String },
}

#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]
pub enum ErrorCode {
    Unknown,
    NetworkUnavailable,
    NetworkTimeout,
    ConnectionLost,
    ServerUnreachable,
    BluetoothUnavailable,
    BluetoothPermissionDenied,
    BluetoothAdapterOff,
    DeviceNotFound,
    PairingFailed,
    ConnectionFailed,
    PermissionDenied,
    PermissionClipboard,
    PermissionBluetooth,
    PermissionLocation,
    PermissionBackground,
    AuthenticationFailed,
    CertificateInvalid,
    SignatureVerificationFailed,
    TokenExpired,
    CredentialsInvalid,
    SyncFailed,
    SyncTimeout,
    DataCorruption,
    ConflictDetected,
    QuotaExceeded,
    DeviceOffline,
    DeviceBusy,
    DeviceUnsupported,
    DeviceVersionMismatch,
    StorageFull,
    StorageCorruption,
    DatabaseError,
    FileNotFound,
    EncryptionFailed,
    DecryptionFailed,
    KeyGenerationFailed,
    KeyNotFound,
    SystemResourceExhausted,
    MemoryInsufficient,
    ProcessingFailed,
    InternalError,
}

#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]
pub enum ErrorSeverity {
    Info,
    Warning,
    Error,
    Critical,
    Fatal,
}

#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]
pub enum ErrorCategory {
    Network,
    Bluetooth,
    Permission,
    Authentication,
    Synchronization,
    Device,
    Storage,
    Cryptography,
    System,
    UserInput,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ErrorInfo {
    pub error_id: String,
    pub error_code: ErrorCode,
    pub category: ErrorCategory,
    pub severity: ErrorSeverity,
    pub message: String,
    pub detailed_message: String,
    pub user_friendly_message: String,
    pub resolution_hint: String,
    pub possible_causes: Vec<String>,
    pub resolution_steps: Vec<String>,
    pub context: HashMap<String, String>,
    pub timestamp: DateTime<Utc>,
    pub stack_trace: Option<String>,
    pub is_recoverable: bool,
    pub should_retry: bool,
    pub max_retries: i32,
    pub retry_delay_ms: i64,
    pub help_url: Option<String>,
}

#[derive(Debug, Clone)]
pub struct RetryPolicy {
    pub strategy: RetryStrategy,
    pub max_attempts: i32,
    pub base_delay: Duration,
    pub max_delay: Duration,
    pub backoff_multiplier: f64,
    pub jitter_enabled: bool,
    pub retryable_errors: Vec<ErrorCode>,
}

#[derive(Debug, Clone)]
pub enum RetryStrategy {
    FixedDelay,
    ExponentialBackoff,
    LinearBackoff,
    Adaptive,
}

pub struct ErrorManager {
    error_messages: Arc<RwLock<HashMap<ErrorCode, ErrorTemplate>>>,
    error_handlers: Arc<RwLock<HashMap<ErrorCategory, Box<dyn ErrorHandler>>>>,
    retry_policies: Arc<RwLock<HashMap<ErrorCode, RetryPolicy>>>,
    error_reporter: Arc<dyn ErrorReporter>,
}

impl ErrorManager {
    pub new(error_reporter: Arc<dyn ErrorReporter>) -> Self {
        let manager = Self {
            error_messages: Arc::new(RwLock::new(HashMap::new())),
            error_handlers: Arc::new(RwLock::new(HashMap::new())),
            retry_policies: Arc::new(RwLock::new(HashMap::new())),
            error_reporter,
        };

        manager.load_error_templates();
        manager.setup_default_handlers();
        manager.setup_default_retry_policies();

        manager
    }

    /// 创建错误信息
    pub async fn create_error_info(
        &self,
        error: NearclipError,
        context: HashMap<String, String>,
    ) -> ErrorInfo {
        let error_code = self.extract_error_code(&error);
        let category = self.determine_category(&error);
        let severity = self.determine_severity(&error);
        let error_id = Uuid::new_v4().to_string();

        let templates = self.error_messages.read().await;
        let template = templates.get(&error_code);

        let (message, user_friendly_message, resolution_hint) = if let Some(tmpl) = template {
            (
                tmpl.message.clone(),
                tmpl.user_friendly_message.clone(),
                tmpl.resolution_hint.clone(),
            )
        } else {
            (
                error.to_string(),
                "发生了未知错误".to_string(),
                "请重启应用或联系技术支持".to_string(),
            )
        };

        let (possible_causes, resolution_steps) = self.generate_error_suggestions(&error_code);

        ErrorInfo {
            error_id,
            error_code,
            category,
            severity,
            message: message.clone(),
            detailed_message: error.to_string(),
            user_friendly_message,
            resolution_hint,
            possible_causes,
            resolution_steps,
            context,
            timestamp: Utc::now(),
            stack_trace: Some(self.get_stack_trace()),
            is_recoverable: self.is_recoverable(&error),
            should_retry: self.should_retry(&error),
            max_retries: self.get_max_retries(&error_code),
            retry_delay_ms: self.get_retry_delay(&error_code),
            help_url: self.get_help_url(&error_code),
        }
    }

    /// 处理错误
    pub async fn handle_error(&self, error: NearclipError, context: HashMap<String, String>) -> ErrorHandlingResult {
        let error_info = self.create_error_info(error, context).await;

        // 记录错误日志
        self.log_error(&error_info);

        // 获取错误处理器
        let handlers = self.error_handlers.read().await;
        if let Some(handler) = handlers.get(&error_info.category) {
            let result = handler.handle(&error_info).await;

            // 报告错误
            self.error_reporter.report_error(&error_info).await;

            result
        } else {
            // 默认处理
            self.default_error_handling(&error_info).await
        }
    }

    /// 执行重试操作
    pub async fn retry_operation<F, T, E>(
        &self,
        operation: F,
        error_code: ErrorCode,
        context: HashMap<String, String>,
    ) -> Result<T, NearclipError>
    where
        F: Fn() -> Result<T, NearclipError> + Send + Sync,
        E: Into<NearclipError>,
    {
        let policies = self.retry_policies.read().await;
        let policy = policies.get(&error_code).cloned().unwrap_or_else(|| self.default_retry_policy());

        let mut attempt = 0;
        let mut delay = policy.base_delay;

        loop {
            match operation() {
                Ok(result) => return Ok(result),
                Err(e) => {
                    attempt += 1;

                    if attempt > policy.max_attempts {
                        error!("Operation failed after {} attempts: {}", attempt, e);
                        return Err(e);
                    }

                    if !policy.retryable_errors.contains(&error_code) {
                        error!("Error type is not retryable: {}", e);
                        return Err(e);
                    }

                    warn!("Attempt {} failed, retrying in {:?}: {}", attempt, delay, e);

                    // 添加抖动
                    let actual_delay = if policy.jitter_enabled {
                        let jitter_factor = 0.8 + (rand::random::<f64>() * 0.4);
                        Duration::from_millis((delay.as_millis() as f64 * jitter_factor) as u64)
                    } else {
                        delay
                    };

                    tokio::time::sleep(actual_delay).await;

                    // 更新延迟
                    delay = std::cmp::min(
                        Duration::from_millis((delay.as_millis() as f64 * policy.backoff_multiplier) as u64),
                        policy.max_delay,
                    );
                }
            }
        }
    }

    /// 记录错误
    async fn log_error(&self, error_info: &ErrorInfo) {
        match error_info.severity {
            ErrorSeverity::Info => info!("{}", error_info.user_friendly_message),
            ErrorSeverity::Warning => warn!("{}", error_info.user_friendly_message),
            ErrorSeverity::Error => error!("{}", error_info.user_friendly_message),
            ErrorSeverity::Critical | ErrorSeverity::Fatal => {
                error!("{}: {}", error_info.user_friendly_message, error_info.detailed_message);
            }
        }

        debug!("Error details: {:?}", error_info);
    }

    /// 默认错误处理
    async fn default_error_handling(&self, error_info: &ErrorInfo) -> ErrorHandlingResult {
        match error_info.severity {
            ErrorSeverity::Info | ErrorSeverity::Warning => {
                ErrorHandlingResult::Continue
            }
            ErrorSeverity::Error => {
                if error_info.is_recoverable {
                    ErrorHandlingResult::Retry
                } else {
                    ErrorHandlingResult::Abort
                }
            }
            ErrorSeverity::Critical => {
                ErrorHandlingResult::Abort
            }
            ErrorSeverity::Fatal => {
                ErrorHandlingResult::Shutdown
            }
        }
    }

    // 私有辅助方法
    fn extract_error_code(&self, error: &NearclipError) -> ErrorCode {
        match error {
            NearclipError::Network { code, .. } => code.clone(),
            NearclipError::Bluetooth { code, .. } => code.clone(),
            NearclipError::Permission { .. } => ErrorCode::PermissionDenied,
            NearclipError::Authentication { .. } => ErrorCode::AuthenticationFailed,
            NearclipError::Device { .. } => ErrorCode::DeviceOffline,
            NearclipError::Synchronization { .. } => ErrorCode::SyncFailed,
            NearclipError::Storage { .. } => ErrorCode::DatabaseError,
            NearclipError::Cryptography { .. } => ErrorCode::EncryptionFailed,
            NearclipError::System { .. } => ErrorCode::InternalError,
            NearclipError::Internal { .. } => ErrorCode::InternalError,
            NearclipError::Unknown { .. } => ErrorCode::Unknown,
        }
    }

    fn determine_category(&self, error: &NearclipError) -> ErrorCategory {
        match error {
            NearclipError::Network { .. } => ErrorCategory::Network,
            NearclipError::Bluetooth { .. } => ErrorCategory::Bluetooth,
            NearclipError::Permission { .. } => ErrorCategory::Permission,
            NearclipError::Authentication { .. } => ErrorCategory::Authentication,
            NearclipError::Device { .. } => ErrorCategory::Device,
            NearclipError::Synchronization { .. } => ErrorCategory::Synchronization,
            NearclipError::Storage { .. } => ErrorCategory::Storage,
            NearclipError::Cryptography { .. } => ErrorCategory::Cryptography,
            NearclipError::System { .. } => ErrorCategory::System,
            NearclipError::Internal { .. } | NearclipError::Unknown { .. } => ErrorCategory::System,
        }
    }

    fn determine_severity(&self, error: &NearclipError) -> ErrorSeverity {
        match error {
            NearclipError::Network { .. } | NearclipError::Bluetooth { .. } => ErrorSeverity::Error,
            NearclipError::Permission { .. } | NearclipError::Authentication { .. } => ErrorSeverity::Critical,
            NearclipError::Synchronization { .. } => ErrorSeverity::Warning,
            NearclipError::Storage { .. } | NearclipError::Cryptography { .. } => ErrorSeverity::Critical,
            NearclipError::System { .. } => ErrorSeverity::Error,
            NearclipError::Internal { .. } => ErrorSeverity::Error,
            NearclipError::Unknown { .. } => ErrorSeverity::Warning,
        }
    }

    fn generate_error_suggestions(&self, error_code: &ErrorCode) -> (Vec<String>, Vec<String>) {
        match error_code {
            ErrorCode::BluetoothUnavailable => (
                vec![
                    "蓝牙功能未启用".to_string(),
                    "设备不支持蓝牙".to_string(),
                    "蓝牙驱动程序问题".to_string(),
                ],
                vec![
                    "检查设备蓝牙设置".to_string(),
                    "重启蓝牙适配器".to_string(),
                    "更新系统蓝牙驱动".to_string(),
                ],
            ),
            ErrorCode::PermissionDenied => (
                vec![
                    "应用缺少必要权限".to_string(),
                    "权限被用户拒绝".to_string(),
                    "权限配置错误".to_string(),
                ],
                vec![
                    "进入应用设置重新授予权限".to_string(),
                    "检查系统权限管理".to_string(),
                    "重启应用".to_string(),
                ],
            ),
            ErrorCode::DeviceNotFound => (
                vec![
                    "目标设备未开启".to_string(),
                    "设备超出通信范围".to_string(),
                    "设备未配对".to_string(),
                ],
                vec![
                    "确保设备已开启NearClip".to_string(),
                    "检查设备距离".to_string(),
                    "重新配对设备".to_string(),
                ],
            ),
            _ => (
                vec!["未知原因".to_string()],
                vec!["重启应用".to_string(), "联系技术支持".to_string()],
            ),
        }
    }

    fn get_stack_trace(&self) -> String {
        std::backtrace::Backtrace::capture().to_string()
    }

    fn is_recoverable(&self, error: &NearclipError) -> bool {
        !matches!(
            error,
            NearclipError::Cryptography { .. } | NearclipError::Authentication { .. }
        )
    }

    fn should_retry(&self, error: &NearclipError) -> bool {
        matches!(
            error,
            NearclipError::Network { .. } | NearclipError::Bluetooth { .. } | NearclipError::Device { .. }
        )
    }

    fn get_max_retries(&self, error_code: &ErrorCode) -> i32 {
        match error_code {
            ErrorCode::NetworkTimeout | ErrorCode::ConnectionLost => 3,
            ErrorCode::DeviceNotFound | ErrorCode::PairingFailed => 2,
            _ => 1,
        }
    }

    fn get_retry_delay(&self, error_code: &ErrorCode) -> i64 {
        match error_code {
            ErrorCode::NetworkTimeout => 2000,
            ErrorCode::ConnectionLost => 1000,
            ErrorCode::DeviceNotFound => 5000,
            _ => 1000,
        }
    }

    fn get_help_url(&self, error_code: &ErrorCode) -> Option<String> {
        Some(format!("https://help.nearclip.com/errors/{}", error_code as i32))
    }

    fn default_retry_policy(&self) -> RetryPolicy {
        RetryPolicy {
            strategy: RetryStrategy::ExponentialBackoff,
            max_attempts: 3,
            base_delay: Duration::from_millis(1000),
            max_delay: Duration::from_secs(30),
            backoff_multiplier: 2.0,
            jitter_enabled: true,
            retryable_errors: vec![
                ErrorCode::NetworkTimeout,
                ErrorCode::ConnectionLost,
                ErrorCode::DeviceNotFound,
            ],
        }
    }

    fn load_error_templates(&self) {
        // 这里应该从配置文件或数据库加载错误模板
        // 为了演示，这里使用硬编码的模板
        let templates = vec![
            ErrorTemplate {
                error_code: ErrorCode::BluetoothUnavailable,
                message: "蓝牙不可用".to_string(),
                user_friendly_message: "无法访问蓝牙功能".to_string(),
                resolution_hint: "请检查设备蓝牙设置".to_string(),
            },
            ErrorTemplate {
                error_code: ErrorCode::PermissionDenied,
                message: "权限被拒绝".to_string(),
                user_friendly_message: "应用缺少必要权限".to_string(),
                resolution_hint: "请在设置中授予所需权限".to_string(),
            },
        ];

        let mut error_messages = self.error_messages.blocking_write();
        for template in templates {
            error_messages.insert(template.error_code.clone(), template);
        }
    }

    fn setup_default_handlers(&self) {
        // 注册默认错误处理器
        let mut handlers = self.error_handlers.blocking_write();
        handlers.insert(ErrorCategory::Network, Box::new(NetworkErrorHandler::new()));
        handlers.insert(ErrorCategory::Bluetooth, Box::new(BluetoothErrorHandler::new()));
        handlers.insert(ErrorCategory::Permission, Box::new(PermissionErrorHandler::new()));
    }

    fn setup_default_retry_policies(&self) {
        // 设置默认重试策略
        let mut policies = self.retry_policies.blocking_write();
        policies.insert(ErrorCode::NetworkTimeout, self.default_retry_policy());
        policies.insert(ErrorCode::ConnectionLost, self.default_retry_policy());
    }
}

#[derive(Debug, Clone)]
pub struct ErrorTemplate {
    pub error_code: ErrorCode,
    pub message: String,
    pub user_friendly_message: String,
    pub resolution_hint: String,
}

#[derive(Debug, Clone, PartialEq)]
pub enum ErrorHandlingResult {
    Continue,
    Retry,
    Abort,
    Shutdown,
}

#[async_trait::async_trait]
pub trait ErrorHandler: Send + Sync {
    async fn handle(&self, error_info: &ErrorInfo) -> ErrorHandlingResult;
}

#[async_trait::async_trait]
pub trait ErrorReporter: Send + Sync {
    async fn report_error(&self, error_info: &ErrorInfo);
    async fn report_feedback(&self, feedback: &str, error_id: &str);
}

// 示例错误处理器实现
pub struct NetworkErrorHandler;

#[async_trait::async_trait]
impl ErrorHandler for NetworkErrorHandler {
    async fn handle(&self, error_info: &ErrorInfo) -> ErrorHandlingResult {
        match error_info.error_code {
            ErrorCode::NetworkTimeout => ErrorHandlingResult::Retry,
            ErrorCode::NetworkUnavailable => ErrorHandlingResult::Abort,
            _ => ErrorHandlingResult::Continue,
        }
    }
}

pub struct BluetoothErrorHandler;

#[async_trait::async_trait]
impl ErrorHandler for BluetoothErrorHandler {
    async fn handle(&self, error_info: &ErrorInfo) -> ErrorHandlingResult {
        match error_info.error_code {
            ErrorCode::BluetoothAdapterOff => ErrorHandlingResult::Retry,
            ErrorCode::BluetoothUnavailable => ErrorHandlingResult::Abort,
            _ => ErrorHandlingResult::Continue,
        }
    }
}

pub struct PermissionErrorHandler;

#[async_trait::async_trait]
impl ErrorHandler for PermissionErrorHandler {
    async fn handle(&self, error_info: &ErrorInfo) -> ErrorHandlingResult {
        // 权限错误通常需要用户操作，所以不应该自动重试
        ErrorHandlingResult::Abort
    }
}
```

### Android 错误处理界面

#### ErrorHandlingActivity
```kotlin
// src/platform/android/app/src/main/java/com/nearclip/ui/activity/ErrorHandlingActivity.kt
package com.nearclip.ui.activity

import android.content.Context
import android.content.Intent
import android.net.Uri
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.verticalScroll
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.vector.ImageVector
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.lifecycle.compose.collectAsStateWithLifecycle
import com.nearclip.ui.viewmodel.ErrorHandlingViewModel

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun ErrorScreen(
    errorId: String,
    onDismiss: () -> Unit,
    onRetry: () -> Unit,
    viewModel: ErrorHandlingViewModel = androidx.hilt.android.compose.hiltViewModel()
) {
    val uiState by viewModel.uiState.collectAsStateWithLifecycle()

    LaunchedEffect(errorId) {
        viewModel.loadError(errorId)
    }

    if (uiState.errorInfo != null) {
        ErrorDialogContent(
            errorInfo = uiState.errorInfo!!,
            onDismiss = onDismiss,
            onRetry = onRetry,
            onGetHelp = { url ->
                viewModel.openHelpUrl(url)
            },
            onSendFeedback = { feedback ->
                viewModel.sendFeedback(feedback)
            }
        )
    }
}

@Composable
private fun ErrorDialogContent(
    errorInfo: ErrorInfo,
    onDismiss: () -> Void,
    onRetry: () -> Void,
    onGetHelp: (String) -> Void,
    onSendFeedback: (String) -> Void
) {
    Card(
        modifier = Modifier
            .fillMaxWidth()
            .padding(16.dp),
        elevation = CardDefaults.cardElevation(defaultElevation = 4.dp)
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(24.dp),
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            // 错误图标和标题
            ErrorHeader(
                severity = errorInfo.severity,
                title = errorInfo.userFriendlyMessage
            )

            // 错误详情
            if (errorInfo.detailedMessage.isNotEmpty()) {
                ErrorDetails(
                    message = errorInfo.detailedMessage,
                    timestamp = errorInfo.timestamp,
                    errorId = errorInfo.errorId
                )
            }

            // 解决建议
            if (errorInfo.resolutionHint.isNotEmpty()) {
                ResolutionHint(
                    hint = errorInfo.resolutionHint,
                    steps = errorInfo.resolutionSteps
                )
            }

            // 可能原因
            if (errorInfo.possibleCauses.isNotEmpty()) {
                PossibleCauses(causes = errorInfo.possibleCauses)
            }

            // 操作按钮
            ActionButtons(
                onDismiss = onDismiss,
                onRetry = if (errorInfo.shouldRetry) onRetry else null,
                onGetHelp = if (errorInfo.helpUrl != null)
                    { { errorInfo.helpUrl?.let { onGetHelp(it) } } }
                else null,
                onSendFeedback = onSendFeedback,
                severity = errorInfo.severity
            )
        }
    }
}

@Composable
private fun ErrorHeader(
    severity: ErrorSeverity,
    title: String,
    modifier: Modifier = Modifier
) {
    Column(
        modifier = modifier,
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.spacedBy(8.dp)
    ) {
        Icon(
            imageVector = getSeverityIcon(severity),
            contentDescription = null,
            modifier = Modifier.size(48.dp),
            tint = getSeverityColor(severity)
        )

        Text(
            text = title,
            style = MaterialTheme.typography.titleMedium,
            fontWeight = FontWeight.Medium,
            textAlign = TextAlign.Center,
            color = getSeverityColor(severity)
        )
    }
}

@Composable
private fun ErrorDetails(
    message: String,
    timestamp: Long,
    errorId: String,
    modifier: Modifier = Modifier
) {
    Column(
        modifier = modifier
            .fillMaxWidth()
            .clip(RoundedCornerShape(8.dp))
            .background(MaterialTheme.colorScheme.errorContainer)
            .padding(16.dp),
        verticalArrangement = Arrangement.spacedBy(8.dp)
    ) {
        Text(
            text = "错误详情",
            style = MaterialTheme.typography.labelMedium,
            fontWeight = FontWeight.Medium,
            color = MaterialTheme.colorScheme.onErrorContainer
        )

        Text(
            text = message,
            style = MaterialTheme.typography.bodySmall,
            color = MaterialTheme.colorScheme.onErrorContainer
        )

        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.SpaceBetween
        ) {
            Text(
                text = "时间: ${formatTimestamp(timestamp)}",
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onErrorContainer
            )

            Text(
                text = "ID: ${errorId.takeLast(8)}",
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onErrorContainer
            )
        }
    }
}

@Composable
private fun ResolutionHint(
    hint: String,
    steps: List<String>,
    modifier: Modifier = Modifier
) {
    Column(
        modifier = modifier
            .fillMaxWidth()
            .clip(RoundedCornerShape(8.dp))
            .background(MaterialTheme.colorScheme.primaryContainer)
            .padding(16.dp),
        verticalArrangement = Arrangement.spacedBy(12.dp)
    ) {
        Row(
            verticalAlignment = Alignment.CenterVertically,
            horizontalArrangement = Arrangement.spacedBy(8.dp)
        ) {
            Icon(
                imageVector = Icons.Default.Lightbulb,
                contentDescription = null,
                tint = MaterialTheme.colorScheme.onPrimaryContainer,
                modifier = Modifier.size(20.dp)
            )

            Text(
                text = "解决建议",
                style = MaterialTheme.typography.labelMedium,
                fontWeight = FontWeight.Medium,
                color = MaterialTheme.colorScheme.onPrimaryContainer
            )
        }

        Text(
            text = hint,
            style = MaterialTheme.typography.bodyMedium,
            color = MaterialTheme.colorScheme.onPrimaryContainer
        )

        if (steps.isNotEmpty()) {
            Text(
                text = "操作步骤：",
                style = MaterialTheme.typography.labelSmall,
                fontWeight = FontWeight.Medium,
                color = MaterialTheme.colorScheme.onPrimaryContainer
            )

            steps.forEachIndexed { index, step ->
                Row(
                    verticalAlignment = Alignment.Top,
                    horizontalArrangement = Arrangement.spacedBy(8.dp)
                ) {
                    Text(
                        text = "${index + 1}.",
                        style = MaterialTheme.typography.bodySmall,
                        fontWeight = FontWeight.Medium,
                        color = MaterialTheme.colorScheme.onPrimaryContainer,
                        modifier = Modifier.widthIn(min = 20.dp)
                    )

                    Text(
                        text = step,
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onPrimaryContainer,
                        modifier = Modifier.weight(1f)
                    )
                }
            }
        }
    }
}

@Composable
private fun PossibleCauses(
    causes: List<String>,
    modifier: Modifier = Modifier
) {
    Column(
        modifier = modifier
            .fillMaxWidth()
            .clip(RoundedCornerShape(8.dp))
            .background(MaterialTheme.colorScheme.surfaceVariant)
            .padding(16.dp),
        verticalArrangement = Arrangement.spacedBy(8.dp)
    ) {
        Row(
            verticalAlignment = Alignment.CenterVertically,
            horizontalArrangement = Arrangement.spacedBy(8.dp)
        ) {
            Icon(
                imageVector = Icons.Default.HelpOutline,
                contentDescription = null,
                tint = MaterialTheme.colorScheme.onSurfaceVariant,
                modifier = Modifier.size(20.dp)
            )

            Text(
                text = "可能原因",
                style = MaterialTheme.typography.labelMedium,
                fontWeight = FontWeight.Medium,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }

        causes.forEach { cause ->
            Row(
                verticalAlignment = Alignment.Top,
                horizontalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                Text(
                    text = "•",
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )

                Text(
                    text = cause,
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant,
                    modifier = Modifier.weight(1f)
                )
            }
        }
    }
}

@Composable
private fun ActionButtons(
    onDismiss: () -> Void,
    onRetry: (() -> Void)?,
    onGetHelp: (() -> Void)?,
    onSendFeedback: (String) -> Void,
    severity: ErrorSeverity,
    modifier: Modifier = Modifier
) {
    Column(
        modifier = modifier.fillMaxWidth(),
        verticalArrangement = Arrangement.spacedBy(8.dp)
    ) {
        // 主要操作按钮
        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.spacedBy(8.dp)
        ) {
            // 重试按钮（如果可重试）
            if (onRetry != null) {
                Button(
                    onClick = onRetry,
                    modifier = Modifier.weight(1f)
                ) {
                    Icon(Icons.Default.Refresh, contentDescription = null, modifier = Modifier.size(18.dp))
                    Spacer(modifier = Modifier.width(8.dp))
                    Text("重试")
                }
            }

            // 关闭按钮
            if (severity != ErrorSeverity.CRITICAL && severity != ErrorSeverity.FATAL) {
                OutlinedButton(
                    onClick = onDismiss,
                    modifier = if (onRetry == null) Modifier.weight(1f) else Modifier.weight(1f)
                ) {
                    Text("关闭")
                }
            }
        }

        // 辅助操作按钮
        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.spacedBy(8.dp)
        ) {
            // 获取帮助按钮
            if (onGetHelp != null) {
                OutlinedButton(
                    onClick = onGetHelp!!,
                    modifier = Modifier.weight(1f)
                ) {
                    Icon(Icons.Default.Help, contentDescription = null, modifier = Modifier.size(18.dp))
                    Spacer(modifier = Modifier.width(8.dp))
                    Text("获取帮助")
                }
            }

            // 发送反馈按钮
            OutlinedButton(
                onClick = { /* 显示反馈对话框 */ },
                modifier = Modifier.weight(1f)
            ) {
                Icon(Icons.Default.Feedback, contentDescription = null, modifier = Modifier.size(18.dp))
                Spacer(modifier = Modifier.width(8.dp))
                Text("发送反馈")
            }
        }
    }
}

// 反馈对话框
@Composable
private fun FeedbackDialog(
    errorId: String,
    onDismiss: () -> Void,
    onSubmit: (String) -> Void
) {
    var feedback by remember { mutableStateOf("") }

    AlertDialog(
        onDismissRequest = onDismiss,
        title = {
            Text("发送反馈")
        },
        text = {
            Column {
                Text("请描述您遇到的问题，这将帮助我们改进应用：")
                Spacer(modifier = Modifier.height(16.dp))
                OutlinedTextField(
                    value = feedback,
                    onValueChange = { feedback = it },
                    label = { Text("反馈内容") },
                    placeholder = { Text("请详细描述问题...") },
                    modifier = Modifier.fillMaxWidth(),
                    minLines = 4,
                    maxLines = 8
                )
                Spacer(modifier = Modifier.height(8.dp))
                Text("错误ID: ${errorId.takeLast(8)}")
                    .font(.caption)
                    .foregroundColor(MaterialTheme.colorScheme.onSurfaceVariant)
            }
        },
        confirmButton = {
            TextButton(
                onClick = {
                    if (feedback.isNotBlank()) {
                        onSubmit(feedback)
                        onDismiss()
                    }
                },
                enabled = feedback.isNotBlank()
            ) {
                Text("发送")
            }
        },
        dismissButton = {
            TextButton(onClick = onDismiss) {
                Text("取消")
            }
        }
    )
}

// 辅助函数
private fun getSeverityIcon(severity: ErrorSeverity): ImageVector {
    return when (severity) {
        ErrorSeverity.INFO -> Icons.Default.Info
        ErrorSeverity.WARNING -> Icons.Default.Warning
        ErrorSeverity.ERROR -> Icons.Default.Error
        ErrorSeverity.CRITICAL -> Icons.Default.ErrorOutline
        ErrorSeverity.FATAL -> Icons.Default.Dangerous
    }
}

private fun getSeverityColor(severity: ErrorSeverity): Color {
    return when (severity) {
        ErrorSeverity.INFO -> Color(0xFF2196F3)
        ErrorSeverity.WARNING -> Color(0xFFFF9800)
        ErrorSeverity.ERROR -> Color(0xFFF44336)
        ErrorSeverity.CRITICAL -> Color(0xFFD32F2F)
        ErrorSeverity.FATAL -> Color(0xFFB71C1C)
    }
}

private fun formatTimestamp(timestamp: Long): String {
    val formatter = java.text.SimpleDateFormat("MM-dd HH:mm:ss", java.util.Locale.getDefault())
    return formatter.format(java.util.Date(timestamp))
}
```

### Mac 错误处理界面

#### SwiftUI ErrorHandlingView
```swift
// src/platform/mac/NearClip/Sources/Views/ErrorHandlingView.swift
import SwiftUI

struct ErrorHandlingView: View {
    let errorInfo: ErrorInfo
    let onDismiss: () -> Void
    let onRetry: (() -> Void)?
    let onGetHelp: ((String) -> Void)?
    let onSendFeedback: (String) -> Void

    @State private var showingFeedbackDialog = false
    @State private var feedbackText = ""

    var body: some View {
        VStack(spacing: 0) {
            // Header
            headerView

            Divider()

            // Content
            ScrollView {
                VStack(spacing: 20) {
                    // Error Icon and Title
                    errorHeaderSection

                    // Error Details
                    if !errorInfo.detailedMessage.isEmpty {
                        errorDetailsSection
                    }

                    // Resolution Hint
                    if !errorInfo.resolutionHint.isEmpty {
                        resolutionHintSection
                    }

                    // Possible Causes
                    if !errorInfo.possibleCauses.isEmpty {
                        possibleCausesSection
                    }

                    // Technical Info
                    if errorInfo.context.isEmpty {
                        technicalInfoSection
                    }
                }
                .padding()
            }

            Divider()

            // Action Buttons
            actionButtonsSection
        }
        .frame(width: 500, height: 600)
        .alert("发送反馈", isPresented: $showingFeedbackDialog) {
            TextField("请描述您遇到的问题...", text: $feedbackText)
            Button("取消", role: .cancel) { }
            Button("发送") {
                if !feedbackText.isEmpty {
                    onSendFeedback(feedbackText)
                    feedbackText = ""
                }
            }
            .disabled(feedbackText.isEmpty)
        } message: {
            Text("错误ID: \(errorInfo.errorId.suffix(8))")
        }
    }

    private var headerView: some View {
        HStack {
            Text("错误")
                .font(.title2)
                .fontWeight(.semibold)

            Spacer()

            Button(action: onDismiss) {
                Image(systemName: "xmark.circle.fill")
                    .font(.title2)
                    .foregroundColor(.secondary)
            }
            .buttonStyle(BorderlessButtonStyle())
        }
        .padding()
    }

    private var errorHeaderSection: some View {
        VStack(spacing: 16) {
            Image(systemName: severityIconName)
                .font(.system(size: 48))
                .foregroundColor(severityColor)

            Text(errorInfo.userFriendlyMessage)
                .font(.headline)
                .fontWeight(.medium)
                .multilineTextAlignment(.center)
                .foregroundColor(severityColor)
        }
    }

    private var errorDetailsSection: some View {
        VStack(alignment: .leading, spacing: 12) {
            HStack {
                Image(systemName: "info.circle.fill")
                    .foregroundColor(.secondary)

                Text("错误详情")
                    .font(.subheadline)
                    .fontWeight(.medium)
            }

            VStack(alignment: .leading, spacing: 8) {
                Text(errorInfo.detailedMessage)
                    .font(.body)
                    .foregroundColor(.primary)

                HStack {
                    Text("时间: \(formatDate(errorInfo.timestamp))")
                    Spacer()
                    Text("ID: \(errorInfo.errorId.suffix(8))")
                }
                .font(.caption)
                .foregroundColor(.secondary)
            }
            .padding()
            .background(Color(NSColor.controlBackgroundColor))
            .cornerRadius(8)
        }
    }

    private var resolutionHintSection: some View {
        VStack(alignment: .leading, spacing: 12) {
            HStack {
                Image(systemName: "lightbulb.fill")
                    .foregroundColor(.accentColor)

                Text("解决建议")
                    .font(.subheadline)
                    .fontWeight(.medium)
            }

            VStack(alignment: .leading, spacing: 12) {
                Text(errorInfo.resolutionHint)
                    .font(.body)
                    .foregroundColor(.primary)

                if !errorInfo.resolutionSteps.isEmpty {
                    VStack(alignment: .leading, spacing: 8) {
                        Text("操作步骤：")
                            .font(.subheadline)
                            .fontWeight(.medium)

                        ForEach(Array(errorInfo.resolutionSteps.enumerated()), id: \.offset) { index, step in
                            HStack(alignment: .top, spacing: 8) {
                                Text("\(index + 1).")
                                    .font(.caption)
                                    .fontWeight(.medium)
                                    .frame(width: 20, alignment: .leading)

                                Text(step)
                                    .font(.body)
                                    .fixedSize(horizontal: false, vertical: true)
                            }
                        }
                    }
                }
            }
            .padding()
            .background(Color.accentColor.opacity(0.1))
            .cornerRadius(8)
        }
    }

    private var possibleCausesSection: some View {
        VStack(alignment: .leading, spacing: 12) {
            HStack {
                Image(systemName: "questionmark.circle.fill")
                    .foregroundColor(.secondary)

                Text("可能原因")
                    .font(.subheadline)
                    .fontWeight(.medium)
            }

            VStack(alignment: .leading, spacing: 8) {
                ForEach(Array(errorInfo.possibleCauses.enumerated()), id: \.offset) { index, cause in
                    HStack(alignment: .top, spacing: 8) {
                        Text("•")
                            .font(.caption)
                            .frame(width: 10, alignment: .leading)

                        Text(cause)
                            .font(.body)
                            .fixedSize(horizontal: false, vertical: true)
                    }
                }
            }
            .padding()
            .background(Color(NSColor.controlBackgroundColor))
            .cornerRadius(8)
        }
    }

    private var technicalInfoSection: some View {
        VStack(alignment: .leading, spacing: 12) {
            HStack {
                Image(systemName: "terminal.fill")
                    .foregroundColor(.secondary)

                Text("技术信息")
                    .font(.subheadline)
                    .fontWeight(.medium)
            }

            VStack(alignment: .leading, spacing: 8) {
                ForEach(Array(errorInfo.context.keys.sorted()), id: \.self) { key in
                    HStack {
                        Text("\(key):")
                            .font(.caption)
                            .fontWeight(.medium)
                            .foregroundColor(.secondary)
                            .frame(width: 100, alignment: .leading)

                        Text(errorInfo.context[key] ?? "")
                            .font(.caption)
                            .font(.system(.monospaced))
                            .foregroundColor(.primary)
                    }
                }
            }
            .padding()
            .background(Color(NSColor.controlBackgroundColor))
            .cornerRadius(8)
        }
    }

    private var actionButtonsSection: some View {
        VStack(spacing: 12) {
            // Primary Actions
            HStack(spacing: 12) {
                if let onRetry = onRetry {
                    Button(action: onRetry) {
                        HStack {
                            Image(systemName: "arrow.clockwise")
                            Text("重试")
                        }
                    }
                    .buttonStyle(.borderedProminent)
                    .controlSize(.large)
                }

                if errorInfo.severity != .critical && errorInfo.severity != .fatal {
                    Button(action: onDismiss) {
                        Text("关闭")
                    }
                    .buttonStyle(.bordered)
                    .controlSize(.large)
                }
            }

            // Secondary Actions
            HStack(spacing: 12) {
                if let onGetHelp = onGetHelp, let helpUrl = errorInfo.helpUrl {
                    Button(action: { onGetHelp(helpUrl) }) {
                        HStack {
                            Image(systemName: "book.fill")
                            Text("获取帮助")
                        }
                    }
                    .buttonStyle(.bordered)
                    .controlSize(.regular)
                }

                Button(action: { showingFeedbackDialog = true }) {
                    HStack {
                        Image(systemName: "paperplane.fill")
                        Text("发送反馈")
                    }
                }
                .buttonStyle(.bordered)
                .controlSize(.regular)
            }
        }
        .padding()
    }

    private var severityIconName: String {
        switch errorInfo.severity {
        case .info:
            return "info.circle.fill"
        case .warning:
            return "exclamationmark.triangle.fill"
        case .error:
            return "xmark.circle.fill"
        case .critical:
            return "xmark.octagon.fill"
        case .fatal:
            return "xmark.shield.fill"
        }
    }

    private var severityColor: Color {
        switch errorInfo.severity {
        case .info:
            return .blue
        case .warning:
            return .orange
        case .error:
            return .red
        case .critical:
            return .red
        case .fatal:
            return .red
        }
    }

    private func formatDate(_ date: Date) -> String {
        let formatter = DateFormatter()
        formatter.dateStyle = .medium
        formatter.timeStyle = .medium
        return formatter.string(from: date)
    }
}

// 扩展错误严重级别
extension ErrorSeverity {
    var displayName: String {
        switch self {
        case .info:
            return "信息"
        case .warning:
            return "警告"
        case .error:
            return "错误"
        case .critical:
            return "严重"
        case .fatal:
            return "致命"
        }
    }
}

#Preview {
    ErrorHandlingView(
        errorInfo: ErrorInfo.preview,
        onDismiss: {},
        onRetry: {},
        onGetHelp: { _ in },
        onSendFeedback: { _ in }
    )
}

// Preview Data
extension ErrorInfo {
    static var preview: ErrorInfo {
        ErrorInfo(
            errorId: "error-123456",
            errorCode: .bluetoothUnavailable,
            category: .bluetooth,
            severity: .error,
            message: "蓝牙功能不可用",
            detailedMessage: "系统无法访问蓝牙适配器，可能是因为蓝牙未启用或适配器出现故障。",
            userFriendlyMessage: "无法访问蓝牙功能",
            resolutionHint: "请检查设备的蓝牙设置，确保蓝牙已开启。",
            possibleCauses: [
                "蓝牙适配器被禁用",
                "蓝牙驱动程序问题",
                "硬件故障"
            ],
            resolutionSteps: [
                "打开系统设置",
                "检查蓝牙开关是否打开",
                "重启设备"
            ],
            context: [
                "device": "MacBook Pro",
                "os_version": "macOS 14.0",
                "app_version": "1.0.0"
            ],
            timestamp: Date(),
            stackTrace: nil,
            isRecoverable: true,
            shouldRetry: true,
            maxRetries: 3,
            retryDelayMs: 2000,
            helpUrl: "https://help.nearclip.com/errors/1101"
        )
    }
}
```

### 帮助文档系统

#### HelpDocumentationManager
```rust
// src/shared/rust/src/help/documentation_manager.rs
use std::collections::HashMap;
use serde::{Deserialize, Serialize};
use tokio::sync::RwLock;
use std::sync::Arc;

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct HelpArticle {
    pub id: String,
    pub title: String,
    pub content: String,
    pub category: HelpCategory,
    pub tags: Vec<String>,
    pub related_errors: Vec<String>,
    pub last_updated: chrono::DateTime<chrono::Utc>,
    pub difficulty_level: DifficultyLevel,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum HelpCategory {
    GettingStarted,
    Troubleshooting,
    Faq,
    Advanced,
    ApiReference,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum DifficultyLevel {
    Beginner,
    Intermediate,
    Advanced,
}

pub struct HelpDocumentationManager {
    articles: Arc<RwLock<HashMap<String, HelpArticle>>>,
    error_to_articles: Arc<RwLock<HashMap<String, Vec<String>>>>,
}

impl HelpDocumentationManager {
    pub fn new() -> Self {
        let manager = Self {
            articles: Arc::new(RwLock::new(HashMap::new())),
            error_to_articles: Arc::new(RwLock::new(HashMap::new())),
        };

        manager.load_documentation();
        manager
    }

    /// 根据错误代码获取帮助文章
    pub async fn get_help_for_error(&self, error_code: &str) -> Vec<HelpArticle> {
        let mapping = self.error_to_articles.read().await;
        let articles = self.articles.read().await;

        if let Some(article_ids) = mapping.get(error_code) {
            article_ids
                .iter()
                .filter_map(|id| articles.get(id))
                .cloned()
                .collect()
        } else {
            Vec::new()
        }
    }

    /// 搜索帮助文章
    pub async fn search_articles(&self, query: &str) -> Vec<HelpArticle> {
        let articles = self.articles.read().await;
        let query = query.to_lowercase();

        articles
            .values()
            .filter(|article| {
                article.title.to_lowercase().contains(&query) ||
                article.content.to_lowercase().contains(&query) ||
                article.tags.iter().any(|tag| tag.to_lowercase().contains(&query))
            })
            .cloned()
            .collect()
    }

    /// 按类别获取文章
    pub async fn get_articles_by_category(&self, category: HelpCategory) -> Vec<HelpArticle> {
        let articles = self.articles.read().await;
        articles
            .values()
            .filter(|article| article.category == category)
            .cloned()
            .collect()
    }

    /// 获取常见问题
    pub async fn get_faq() -> Vec<HelpArticle> {
        self.get_articles_by_category(HelpCategory::Faq).await
    }

    /// 加载文档
    fn load_documentation(&self) {
        // 这里应该从文件系统或数据库加载文档
        // 为了演示，这里使用硬编码的文档
        let sample_articles = vec![
            HelpArticle {
                id: "bluetooth-troubleshooting".to_string(),
                title: "蓝牙连接问题排查".to_string(),
                content: include_str!("../docs/help/bluetooth_troubleshooting.md").to_string(),
                category: HelpCategory::Troubleshooting,
                tags: vec!["蓝牙".to_string(), "连接".to_string(), "问题".to_string()],
                related_errors: vec!["1101".to_string(), "1102".to_string(), "1103".to_string()],
                last_updated: chrono::Utc::now(),
                difficulty_level: DifficultyLevel::Beginner,
            },
            HelpArticle {
                id: "permission-guide".to_string(),
                title: "应用权限设置指南".to_string(),
                content: include_str!("../docs/help/permission_guide.md").to_string(),
                category: HelpCategory::GettingStarted,
                tags: vec!["权限".to_string(), "设置".to_string(), "指南".to_string()],
                related_errors: vec!["1201".to_string(), "1202".to_string()],
                last_updated: chrono::Utc::now(),
                difficulty_level: DifficultyLevel::Beginner,
            },
        ];

        let mut articles = self.articles.blocking_write();
        let mut error_mapping = self.error_to_articles.blocking_write();

        for article in sample_articles {
            for error_id in &article.related_errors {
                error_mapping
                    .entry(error_id.clone())
                    .or_insert_with(Vec::new)
                    .push(article.id.clone());
            }
            articles.insert(article.id.clone(), article);
        }
    }
}
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-17 | 1.0 | 初始故事创建，添加错误处理与用户反馈 | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
待开发代理填写

### Debug Log References
待开发代理填写

### Completion Notes List
待开发代理填写

### File List
待开发代理填写

## QA Results
待 QA 代理填写