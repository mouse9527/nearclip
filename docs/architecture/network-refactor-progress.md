# ç½‘ç»œå±‚é‡æ„è¿›åº¦æŠ¥å‘Š

## å·²å®Œæˆå·¥ä½œ

### ç¬¬ä¸€é˜¶æ®µï¼šBLE æ§åˆ¶æƒè½¬ç§» (è¿›è¡Œä¸­)

#### âœ… æ­¥éª¤ 1.1ï¼šå®šä¹‰ BLE ç¡¬ä»¶æŠ½è±¡æ¥å£ (UDL)
- **çŠ¶æ€**: å·²å®Œæˆ
- **æ–‡ä»¶**: `crates/nearclip-ffi/src/nearclip.udl`
- **å†…å®¹**:
  - `FfiBleHardware` æ¥å£å·²å®šä¹‰ï¼ˆç¬¬117-156è¡Œï¼‰
  - åŒ…å«æ‰«æã€è¿æ¥ã€æ•°æ®ä¼ è¾“ã€çŠ¶æ€æŸ¥è¯¢ã€å¹¿æ’­ç­‰æ–¹æ³•
  - `FfiNearClipManager` ä¸­çš„ BLE äº‹ä»¶å¤„ç†æ–¹æ³•å·²å®šä¹‰ï¼ˆç¬¬240-272è¡Œï¼‰

#### âœ… æ­¥éª¤ 1.2ï¼šå®ç° BleController
- **çŠ¶æ€**: å·²å®Œæˆ
- **æ–‡ä»¶**: `crates/nearclip-ble/src/controller.rs` (æ–°å»ºï¼Œ700+è¡Œ)
- **åŠŸèƒ½**:
  - æ‰«ææ§åˆ¶å’Œè®¾å¤‡å‘ç°
  - è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†
  - è‡ªåŠ¨é‡è¿ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
  - å¥åº·æ£€æŸ¥
  - è®¾å¤‡ä¸¢å¤±æ£€æµ‹
  - é…å¯¹éªŒè¯å‡†å¤‡
- **æµ‹è¯•**: åŒ…å«å•å…ƒæµ‹è¯•ï¼ˆMockHardware, MockCallbackï¼‰

#### ğŸ”„ æ­¥éª¤ 1.3ï¼šé›†æˆåˆ° NearClipManager
- **çŠ¶æ€**: è¿›è¡Œä¸­ï¼ˆ90%å®Œæˆï¼‰
- **å·²å®Œæˆ**:
  - åˆ›å»º `BleHardwareBridge` é€‚é…å™¨ï¼ˆ`crates/nearclip-ffi/src/ble_hardware_bridge.rs`ï¼‰
  - åˆ›å»º `BleControllerCallbackBridge` æ¡¥æ¥
  - åœ¨ `FfiNearClipManager` ä¸­æ·»åŠ  `ble_controller` å­—æ®µ
  - æ›´æ–° `set_ble_hardware()` æ–¹æ³•ä»¥åˆå§‹åŒ– BleController
  - æ›´æ–° `start_discovery()` å’Œ `stop_discovery()` ä½¿ç”¨ BleController
  - æ›´æ–° BLE äº‹ä»¶å¤„ç†æ–¹æ³•è½¬å‘åˆ° BleController
  - æ·»åŠ  `nearclip-ble` ä¾èµ–åˆ° `nearclip-ffi/Cargo.toml`

- **å¾…ä¿®å¤çš„ç¼–è¯‘é”™è¯¯**:
  1. **é‡å¤æ–¹æ³•**: `on_ble_data_received` æœ‰ä¸¤ä¸ªå®šä¹‰ï¼ˆç¬¬684è¡Œå’Œç¬¬1163è¡Œï¼‰
     - éœ€è¦åˆ é™¤æ—§çš„å®ç°ï¼ˆç¬¬684è¡Œï¼Œlegacy ç‰ˆæœ¬ï¼‰
     - ä¿ç•™æ–°çš„å®ç°ï¼ˆç¬¬1163è¡Œï¼Œä½¿ç”¨ BleControllerï¼‰

  2. **Clone é”™è¯¯**: `tokio::sync::RwLock` ä¸æ”¯æŒ `clone()`
     - ç¬¬930è¡Œ: `self.discovered_devices.clone()`
     - è§£å†³æ–¹æ¡ˆ: ä½¿ç”¨ `Arc::clone(&self.discovered_devices)`

  3. **Move é”™è¯¯**: `ffi_device` åœ¨ async å—ä¸­è¢«ç§»åŠ¨åå†æ¬¡ä½¿ç”¨
     - ç¬¬64è¡Œ: åœ¨ `tokio::spawn` ä¸­ä½¿ç”¨åï¼Œåˆåœ¨ç¬¬64è¡Œä½¿ç”¨
     - è§£å†³æ–¹æ¡ˆ: åœ¨ç§»åŠ¨å‰ `clone()` ä¸€ä»½

#### â³ æ­¥éª¤ 1.4ï¼šç®€åŒ–å¹³å°å±‚ BleManager
- **çŠ¶æ€**: æœªå¼€å§‹
- **ç›®æ ‡**:
  - macOS `BleManager.swift` ä» 1124 è¡Œå‡å°‘åˆ° ~200 è¡Œ
  - Android `BleManager.kt` ä» 1096 è¡Œå‡å°‘åˆ° ~200 è¡Œ
- **éœ€è¦ç§»é™¤çš„é€»è¾‘**:
  - è‡ªåŠ¨é‡è¿ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
  - è¿æ¥å¥åº·ç›‘æ§
  - è®¾å¤‡ä¸¢å¤±æ£€æµ‹
  - æ‰«ææš‚åœä¼˜åŒ–
  - æ•°æ®åˆ†å—/é‡ç»„ï¼ˆéƒ¨åˆ†ï¼‰
- **éœ€è¦ä¿ç•™çš„é€»è¾‘**:
  - CoreBluetooth / Android BLE API è°ƒç”¨
  - ç‰¹å¾è¯»å†™
  - æœåŠ¡å‘ç°
  - å¹¿æ’­è®¾ç½®

## å‰©ä½™å·¥ä½œ

### ç¬¬ä¸€é˜¶æ®µå‰©ä½™ä»»åŠ¡

1. **ä¿®å¤ç¼–è¯‘é”™è¯¯** (é¢„è®¡ 30 åˆ†é’Ÿ)
   ```rust
   // åˆ é™¤ç¬¬684è¡Œçš„æ—§ on_ble_data_received æ–¹æ³•
   // ä¿®å¤ BleControllerCallbackBridge ä¸­çš„ clone å’Œ move é”™è¯¯
   ```

2. **æµ‹è¯• FFI é›†æˆ** (é¢„è®¡ 1 å°æ—¶)
   - ç¼–è¯‘ Swift/Kotlin ç»‘å®š
   - éªŒè¯ BLE äº‹ä»¶æµ
   - æµ‹è¯•è®¾å¤‡å‘ç°å’Œè¿æ¥

3. **ç®€åŒ–å¹³å°å±‚ BleManager** (é¢„è®¡ 4-6 å°æ—¶)
   - macOS: é‡å†™ `BleManager.swift`
   - Android: é‡å†™ `BleManager.kt`
   - ç§»é™¤ä¸šåŠ¡é€»è¾‘ï¼Œåªä¿ç•™ç¡¬ä»¶æ“ä½œ

### ç¬¬äºŒé˜¶æ®µï¼šç»Ÿä¸€å†å²å­˜å‚¨

**ç›®æ ‡**: åœ¨ Rust å±‚å®ç°åŒæ­¥å†å²å­˜å‚¨

#### æ­¥éª¤ 2.1ï¼šå®ç° HistoryManager
- æ·»åŠ  `rusqlite` ä¾èµ–
- åˆ›å»º `crates/nearclip-core/src/history.rs`
- å®ç° SQLite å­˜å‚¨
- å®ç°å†å²è®°å½• CRUD

#### æ­¥éª¤ 2.2ï¼šé›†æˆåˆ° FFI
- æ·»åŠ  `FfiSyncHistoryEntry` ç±»å‹åˆ° UDL
- æ·»åŠ  `get_sync_history()` æ–¹æ³•
- æ·»åŠ  `clear_sync_history()` æ–¹æ³•

#### æ­¥éª¤ 2.3ï¼šç§»é™¤å¹³å°å±‚å†å²å­˜å‚¨
- åˆ é™¤ `macos/.../SyncHistoryManager.swift`
- åˆ é™¤ `android/.../SyncHistoryRepository.kt`
- æ›´æ–° UI å±‚è°ƒç”¨ FFI æ¥å£

### ç¬¬ä¸‰é˜¶æ®µï¼šç»Ÿä¸€è®¾å¤‡å­˜å‚¨

**ç›®æ ‡**: åªä½¿ç”¨ Rust å±‚çš„è®¾å¤‡å­˜å‚¨

#### æ­¥éª¤ 3.1ï¼šå¢å¼º Rust DeviceStore
- ç¡®ä¿ `FileDeviceStore` åŠŸèƒ½å®Œæ•´
- æ·»åŠ è®¾å¤‡å…ƒæ•°æ®å­˜å‚¨

#### æ­¥éª¤ 3.2ï¼šç§»é™¤å¹³å°å±‚è®¾å¤‡å­˜å‚¨
- macOS: ç§»é™¤ UserDefaults è®¾å¤‡å­˜å‚¨
- Android: ç§»é™¤ SecureStorage è®¾å¤‡å­˜å‚¨
- æ›´æ–°å¹³å°å±‚åªé€šè¿‡ FFI è®¿é—®è®¾å¤‡åˆ—è¡¨

### ç¬¬å››é˜¶æ®µï¼šæ¸…ç†å’Œä¼˜åŒ–

#### æ­¥éª¤ 4.1ï¼šç§»é™¤åºŸå¼ƒä»£ç 
- æ¸…ç†å¹³å°å±‚ä¸å†ä½¿ç”¨çš„ä»£ç 
- ç§»é™¤é‡å¤çš„æ•°æ®ç»“æ„å®šä¹‰
- ç§»é™¤ legacy `FfiBleSender` æ¥å£

#### æ­¥éª¤ 4.2ï¼šæµ‹è¯•
- å•å…ƒæµ‹è¯• BleController âœ…
- å•å…ƒæµ‹è¯• HistoryManager
- é›†æˆæµ‹è¯• BLE æµç¨‹
- ç«¯åˆ°ç«¯æµ‹è¯•

#### æ­¥éª¤ 4.3ï¼šæ–‡æ¡£
- æ›´æ–°æ¶æ„æ–‡æ¡£
- æ›´æ–° API æ–‡æ¡£
- æ›´æ–°å¹³å°é›†æˆæŒ‡å—

## æˆåŠŸæŒ‡æ ‡

- [ ] å¹³å°å±‚ BLE ä»£ç ä» 2200+ è¡Œå‡å°‘åˆ° ~400 è¡Œ
- [ ] æ‰€æœ‰ BLE é€»è¾‘æµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] å†å²å­˜å‚¨ç»Ÿä¸€ï¼Œæ•°æ®æ ¼å¼ä¸€è‡´
- [ ] è®¾å¤‡å­˜å‚¨ç»Ÿä¸€ï¼Œæ— çŠ¶æ€åŒæ­¥é—®é¢˜
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•é€šè¿‡

## å…³é”®æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
- `crates/nearclip-ble/src/controller.rs` - BLE æ§åˆ¶å™¨
- `crates/nearclip-ffi/src/ble_hardware_bridge.rs` - ç¡¬ä»¶æ¡¥æ¥é€‚é…å™¨

### ä¿®æ”¹æ–‡ä»¶
- `crates/nearclip-ble/src/lib.rs` - å¯¼å‡º BleController
- `crates/nearclip-ffi/src/lib.rs` - é›†æˆ BleController
- `crates/nearclip-ffi/src/nearclip.udl` - BLE æ¥å£å®šä¹‰ï¼ˆå·²æœ‰ï¼‰
- `crates/nearclip-ffi/Cargo.toml` - æ·»åŠ  nearclip-ble ä¾èµ–

### å¾…ä¿®æ”¹æ–‡ä»¶
- `macos/NearClip/Sources/NearClip/BleManager.swift` - ç®€åŒ–åˆ° ~200 è¡Œ
- `android/app/src/main/java/com/nearclip/service/BleManager.kt` - ç®€åŒ–åˆ° ~200 è¡Œ

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³**: ä¿®å¤ 3 ä¸ªç¼–è¯‘é”™è¯¯
2. **çŸ­æœŸ**: å®Œæˆ FFI é›†æˆæµ‹è¯•
3. **ä¸­æœŸ**: ç®€åŒ–å¹³å°å±‚ BleManager
4. **é•¿æœŸ**: å®ç°å†å²å­˜å‚¨å’Œè®¾å¤‡å­˜å‚¨ç»Ÿä¸€

## æŠ€æœ¯å€ºåŠ¡

- æ—§çš„ `on_ble_connection_changed` æ–¹æ³•ä»åœ¨ä½¿ç”¨ï¼ˆlegacyï¼‰
- `FfiBleSender` æ¥å£åº”è¯¥åœ¨å®Œæˆè¿ç§»åç§»é™¤
- å¹³å°å±‚ä»æœ‰å¤§é‡é‡å¤çš„æ•°æ®åˆ†å—/é‡ç»„ä»£ç 
- ç¼ºå°‘ BLE é›†æˆæµ‹è¯•

## é£é™©è¯„ä¼°

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ | çŠ¶æ€ |
|------|------|---------|------|
| BLE å¹³å°å·®å¼‚ | ä¸­ | åœ¨ Rust å±‚æŠ½è±¡ï¼Œå¹³å°å±‚åªåšæœ€å°å®ç° | è¿›è¡Œä¸­ |
| FFI è°ƒç”¨å¼€é”€ | ä½ | æ‰¹é‡æ“ä½œï¼Œå‡å°‘è·¨è¾¹ç•Œè°ƒç”¨ | å·²è€ƒè™‘ |
| è°ƒè¯•å›°éš¾ | ä¸­ | å®Œå–„æ—¥å¿—ï¼Œæ·»åŠ  tracing | å·²å®æ–½ |
| è¿ç§»é£é™© | é«˜ | åˆ†é˜¶æ®µè¿ç§»ï¼Œä¿æŒæ—§ä»£ç å¯å›é€€ | è¿›è¡Œä¸­ |

## æ—¶é—´ä¼°ç®—

- **ç¬¬ä¸€é˜¶æ®µå‰©ä½™**: 6-8 å°æ—¶
- **ç¬¬äºŒé˜¶æ®µ**: 8-10 å°æ—¶
- **ç¬¬ä¸‰é˜¶æ®µ**: 4-6 å°æ—¶
- **ç¬¬å››é˜¶æ®µ**: 6-8 å°æ—¶
- **æ€»è®¡**: 24-32 å°æ—¶

---

**æœ€åæ›´æ–°**: 2025-12-25
**è´Ÿè´£äºº**: Claude Code Agent
**çŠ¶æ€**: ç¬¬ä¸€é˜¶æ®µ 90% å®Œæˆ
