# Task 0106: 实现传输层抽象接口

## 任务描述

实现统一的传输层抽象接口，为应用层提供一致的传输API。

## 正交性分析

- **接口抽象**: 专注于传输接口定义
- **多态支持**: 支持不同传输实现
- **生命周期**: 连接生命周期管理
- **质量评估**: 传输质量评估机制

## 技术实现

### 核心组件
```rust
// rust-core/transport/transport.rs
pub trait Transport: Send + Sync {
    // 基础连接操作
    async fn connect(&mut self) -> Result<(), TransportError>;
    async fn disconnect(&mut self) -> Result<(), TransportError>;
    fn is_connected(&self) -> bool;
    
    // 数据传输
    async fn send_data(&mut self, data: &[u8]) -> Result<(), TransportError>;
    async fn receive_data(&mut self) -> Result<Vec<u8>, TransportError>;
    async fn send_packet(&mut self, packet: Packet) -> Result<(), TransportError>;
    async fn receive_packet(&mut self) -> Result<Packet, TransportError>;
    
    // 连接信息
    fn get_connection_info(&self) -> ConnectionInfo;
    fn get_transport_type(&self) -> TransportType;
    fn get_quality_score(&self) -> f32;
    fn get_metrics(&self) -> TransportMetrics;
    
    // 配置和状态
    fn set_config(&mut self, config: TransportConfig) -> Result<(), TransportError>;
    fn get_config(&self) -> &TransportConfig;
}

#[derive(Debug, Clone)]
pub struct Packet {
    pub id: String,
    pub payload: Vec<u8>,
    pub packet_type: PacketType,
    pub flags: PacketFlags,
    pub timestamp: SystemTime,
}

#[derive(Debug)]
pub struct ConnectionInfo {
    pub transport_type: TransportType,
    pub remote_address: String,
    pub connection_time: Option<SystemTime>,
    pub last_activity: SystemTime,
    pub metadata: HashMap<String, String>,
}

#[derive(Debug)]
pub struct TransportMetrics {
    pub bytes_sent: u64,
    pub bytes_received: u64,
    pub packets_sent: u64,
    pub packets_received: u64,
    pub average_latency: Duration,
    pub connection_uptime: Duration,
    pub error_count: u32,
}

pub enum TransportType {
    Wifi,
    Ble,
    #[allow(dead_code)]
    Usb,
    #[allow(dead_code)]
    Tcp,
    #[allow(dead_code)]
    Udp,
}
```

### 传输事件
```rust
#[derive(Debug, Clone)]
pub enum TransportEvent {
    Connected { transport_type: TransportType, connection_info: ConnectionInfo },
    Disconnected { transport_type: TransportType, reason: String },
    DataReceived { data: Vec<u8>, size: usize },
    DataSent { size: usize, duration: Duration },
    Error { error: TransportError, context: String },
    QualityChanged { old_score: f32, new_score: f32 },
    Reconnecting { attempt: u32, max_attempts: u32 },
}

pub trait TransportEventHandler: Send + Sync {
    fn on_transport_event(&self, event: TransportEvent);
}
```

### 配置管理
```rust
#[derive(Debug, Clone)]
pub struct TransportConfig {
    pub connection_timeout: Duration,
    pub read_timeout: Duration,
    pub write_timeout: Duration,
    pub keep_alive_interval: Duration,
    pub max_packet_size: usize,
    pub retry_policy: RetryPolicy,
    pub compression_enabled: bool,
    pub encryption_enabled: bool,
}

#[derive(Debug, Clone)]
pub enum RetryPolicy {
    None,
    Fixed { max_attempts: u32, delay: Duration },
    Exponential { max_attempts: u32, initial_delay: Duration, max_delay: Duration, multiplier: f64 },
}
```

### 工厂模式
```rust
pub trait TransportFactory: Send + Sync {
    fn create_transport(&self, transport_type: TransportType, config: TransportConfig) -> Result<Box<dyn Transport>, TransportError>;
    fn get_supported_types(&self) -> Vec<TransportType>;
    fn validate_config(&self, transport_type: &TransportType, config: &TransportConfig) -> Result<(), TransportError>;
}
```

## 验收标准

- [ ] 接口设计完整，覆盖所有必要操作
- [ ] 支持异步操作和生命周期管理
- [ ] 提供传输质量评估机制
- [ ] 支持事件通知系统
- [ ] 配置灵活可扩展
- [ ] 错误处理完善
- [ ] 性能开销最小化