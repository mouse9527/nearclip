# Task 0502: 实现设备状态监控

## 任务描述

实现设备在线状态和连接状态的实时监控。

## 正交性分析

- **状态检测**: 设备状态检测
- **健康检查**: 设备健康状态
- **事件通知**: 状态变化通知
- **历史记录**: 状态历史追踪

## 技术实现

### 核心组件
```rust
// rust-core/device/status_monitor.rs
pub struct DeviceStatusMonitor {
    device_states: HashMap<String, DeviceState>,
    health_checker: HealthChecker,
    event_emitter: EventEmitter<DeviceStatusEvent>,
    config: MonitorConfig,
}

pub struct DeviceState {
    pub device_id: String,
    pub connection_status: ConnectionStatus,
    pub health_status: HealthStatus,
    pub last_activity: SystemTime,
    pub response_time: Option<Duration>,
    pub error_count: u32,
    pub consecutive_failures: u32,
}

pub struct DeviceStatusEvent {
    pub device_id: String,
    pub old_status: DeviceState,
    pub new_status: DeviceState,
    pub event_type: StatusEventType,
    pub timestamp: SystemTime,
}

pub enum ConnectionStatus {
    Disconnected,
    Connecting,
    Connected,
    Reconnecting,
    Error(String),
}
```

### 接口设计
```rust
impl DeviceStatusMonitor {
    pub fn new(config: MonitorConfig) -> Self;
    pub async fn start_monitoring(&mut self, device_id: &str);
    pub fn stop_monitoring(&mut self, device_id: &str);
    pub fn update_device_status(&mut self, device_id: &str, status: ConnectionStatus);
    pub fn get_device_state(&self, device_id: &str) -> Option<&DeviceState>;
    pub fn get_all_device_states(&self) -> Vec<&DeviceState>;
    pub async fn perform_health_check(&mut self, device_id: &str) -> HealthCheckResult;
    pub fn subscribe_to_status_changes(&mut self, callback: Box<dyn Fn(DeviceStatusEvent) + Send + Sync>);
    pub fn get_device_history(&self, device_id: &str, period: Duration) -> Vec<DeviceStatusEvent>;
}
```

## 验收标准

- [ ] 状态检测准确
- [ ] 健康检查完善
- [ ] 事件通知及时
- [ ] 历史记录完整
- [ ] 性能优化
- [ ] 资源占用低